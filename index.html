<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f3ef;--surface:#fff;--surface2:#eeecea;
  --accent:#1a5cff;--accent-soft:#e8eeff;
  --danger:#d90019;--danger-soft:#fff0f1;
  --success:#007a38;--success-soft:#e6f5ed;
  --pause:#b87000;--pause-soft:#fff7e0;
  --giqi:#7c00c8;--giqi-soft:#f3e8ff;
  --hiyari:#c80050;--hiyari-soft:#ffe8f0;
  --text:#1a1a1a;--muted:#8a8a84;--border:#dedad4;
  --shadow:0 2px 10px rgba(0,0,0,0.06);--shadow-lg:0 8px 32px rgba(0,0,0,0.13);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;}
#setupScreen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 32px;width:100%;max-width:400px;box-shadow:var(--shadow-lg);text-align:center;}
.setup-card .logo{font-size:42px;margin-bottom:12px;}
.setup-card h2{font-size:20px;font-weight:900;margin-bottom:6px;}
.setup-card p{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.7;}
.setup-code-input{width:100%;text-align:center;font-family:'JetBrains Mono',monospace;font-size:34px;font-weight:700;letter-spacing:10px;background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:14px 10px;outline:none;color:var(--text);transition:border-color 0.15s;margin-bottom:8px;}
.setup-code-input:focus{border-color:var(--accent);}
.setup-hint{font-size:12px;color:var(--muted);margin-bottom:20px;font-family:'JetBrains Mono',monospace;}
.setup-hint.ok{color:var(--success);font-weight:700;}
.setup-hint.err{color:var(--danger);font-weight:700;}
.btn-setup{width:100%;padding:15px;background:var(--accent);color:#fff;border:none;border-radius:11px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;box-shadow:0 3px 10px rgba(26,92,255,0.3);}
.btn-setup:hover{filter:brightness(1.1);}
#mainApp{display:none;}
.container{max-width:1060px;margin:0 auto;padding:16px 14px;}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--surface);border-radius:14px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.header-left{display:flex;align-items:center;gap:10px;}
.store-badge{background:var(--accent-soft);border:1.5px solid var(--accent);border-radius:8px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;user-select:none;}
.store-badge:hover{background:#d4e0ff;}
.refresh-btn{background:var(--danger-soft);border:1.5px solid var(--danger);border-radius:8px;padding:4px 10px;font-size:12px;font-weight:700;color:var(--danger);cursor:pointer;font-family:'Noto Sans JP',sans-serif;white-space:nowrap;}
.refresh-btn:hover{background:#ffd0d4;}
.header-title{font-size:16px;font-weight:900;}
.header-right{display:flex;align-items:center;gap:12px;}
.sync-wrap{display:flex;align-items:center;gap:5px;}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:background 0.3s;flex-shrink:0;}
.sync-dot.synced{background:var(--success);}
.sync-dot.syncing{background:var(--pause);animation:pulse 0.8s ease-in-out infinite;}
.sync-dot.error{background:var(--danger);}
.sync-label{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);}
.clock{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;}
.tabs{display:flex;gap:3px;margin-bottom:12px;background:var(--surface);padding:4px;border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);}
.tab{flex:1;padding:8px 2px;text-align:center;border-radius:7px;cursor:pointer;font-size:12px;font-weight:700;color:var(--muted);transition:all 0.18s;border:none;background:none;font-family:'Noto Sans JP',sans-serif;}
.tab.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(26,92,255,0.28);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.new-ticket-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 15px;margin-bottom:12px;box-shadow:var(--shadow);}
.new-ticket-bar label{font-size:13px;color:var(--muted);white-space:nowrap;font-weight:500;}
.num-spinner{display:flex;align-items:center;border:2px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface2);}
.num-spinner:focus-within{border-color:var(--accent);}
.spinner-btn{width:50px;height:54px;border:none;background:var(--surface2);color:var(--text);font-size:24px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.1s;user-select:none;-webkit-user-select:none;touch-action:manipulation;flex-shrink:0;}
.spinner-btn:hover{background:var(--border);}
.spinner-btn:active{background:var(--accent);color:#fff;}
.sdiv{width:1px;height:30px;background:var(--border);flex-shrink:0;}
.ticket-input{width:76px;background:transparent;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;padding:0 4px;text-align:center;outline:none;-moz-appearance:textfield;}
.ticket-input::-webkit-inner-spin-button,.ticket-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
.btn-add{padding:0 22px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;white-space:nowrap;box-shadow:0 2px 8px rgba(26,92,255,0.28);touch-action:manipulation;height:54px;}
.btn-add:hover{filter:brightness(1.1);}
.btn-add:active{transform:scale(0.97);}
.ticket-count-badge{margin-left:auto;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;}
.tags-row{width:100%;display:flex;flex-wrap:wrap;gap:6px;padding-top:6px;border-top:1px solid var(--border);margin-top:2px;align-items:center;}
.tags-row label{font-size:12px;color:var(--muted);font-weight:500;white-space:nowrap;}
.tag-chip{display:inline-flex;align-items:center;padding:5px 10px;border-radius:99px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;user-select:none;touch-action:manipulation;}
.tag-chip:hover{border-color:var(--accent);}
.tag-chip.selected{border-color:var(--accent);background:var(--accent-soft);color:var(--accent);}
.tag-chip.tag-fast.selected{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-chip.tag-slow.selected{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}
.tickets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:11px;max-height:68vh;overflow-y:auto;padding-bottom:4px;}
.tickets-grid::-webkit-scrollbar{width:4px;}
.tickets-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.ticket-card{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:14px;transition:border-color 0.2s,box-shadow 0.2s;box-shadow:var(--shadow);}
.ticket-card.status-active{border-color:var(--accent);box-shadow:0 4px 18px rgba(26,92,255,0.12);}
.ticket-card.status-paused{border-color:var(--pause);box-shadow:0 4px 14px rgba(184,112,0,0.10);}
.ticket-card.status-giqi{border-color:var(--giqi);box-shadow:0 4px 14px rgba(124,0,200,0.12);}
.ticket-card.status-cancelled{border-color:var(--border);opacity:0.6;box-shadow:none;}
.ticket-card.status-done{border-color:var(--success);box-shadow:0 4px 14px rgba(0,122,56,0.10);}
.ticket-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.ticket-num{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;}
.status-active .ticket-num{color:var(--accent);}
.status-paused .ticket-num{color:var(--pause);}
.status-giqi .ticket-num{color:var(--giqi);}
.status-done .ticket-num{color:var(--success);}
.status-cancelled .ticket-num{color:var(--muted);}
.ticket-badge{font-size:10px;font-family:'JetBrains Mono',monospace;padding:3px 9px;border-radius:99px;font-weight:700;}
.badge-active{background:var(--accent-soft);color:var(--accent);}
.badge-paused{background:var(--pause-soft);color:var(--pause);}
.badge-giqi{background:var(--giqi-soft);color:var(--giqi);}
.badge-cancelled{background:var(--danger-soft);color:var(--danger);}
.badge-done{background:var(--success-soft);color:var(--success);}
.card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:7px;align-items:center;}
.card-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:99px;border:1px solid;}
.card-tag.slow{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.card-tag.fast{background:var(--success-soft);color:var(--success);border-color:rgba(0,122,56,0.3);}
.card-tag.normal{background:var(--surface2);color:var(--muted);border-color:var(--border);}
.btn-tag-edit{font-size:10px;padding:2px 8px;border-radius:99px;border:1px dashed var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.btn-tag-edit:hover{border-color:var(--accent);color:var(--accent);}
.hiyari-flag{display:flex;align-items:center;gap:5px;background:var(--hiyari-soft);border:1px solid rgba(200,0,80,0.25);border-radius:7px;padding:4px 9px;margin-bottom:7px;font-size:11px;color:var(--hiyari);font-weight:700;}
.hiyari-flag .hf-dot{width:6px;height:6px;border-radius:50%;background:var(--hiyari);animation:pulse 1s ease-in-out infinite;flex-shrink:0;}
.steps{display:flex;gap:3px;margin-bottom:8px;}
.step{flex:1;text-align:center;padding:5px 2px;border-radius:5px;font-size:9px;font-weight:700;transition:all 0.2s;}
.step.pending{background:var(--surface2);color:var(--muted);}
.step.current{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.28);}
.step.current.paused{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.step.current.giqi{background:var(--giqi-soft);color:var(--giqi);border-color:rgba(124,0,200,0.3);}
.step.done-step{background:var(--success-soft);color:var(--success);}
.step-time{font-family:'JetBrains Mono',monospace;font-size:8px;margin-top:2px;}
.current-process{display:flex;align-items:center;gap:9px;background:var(--surface2);border-radius:9px;padding:9px 12px;margin-bottom:8px;}
.proc-icon{font-size:17px;}
.proc-name{font-size:12px;font-weight:700;flex:1;}
.proc-timer{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;}
.giqi-info{font-size:11px;color:var(--giqi);font-family:'JetBrains Mono',monospace;margin-bottom:5px;}
.giqi-info span{font-weight:700;}
.total-time{font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'JetBrains Mono',monospace;}
.total-time span{color:var(--text);font-weight:700;}
.sub-info{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:2px;}
.ticket-buttons{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap;}
.tbtn{padding:9px 6px;border-radius:8px;border:none;cursor:pointer;font-size:11px;font-weight:700;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;touch-action:manipulation;white-space:nowrap;line-height:1.3;flex:1;}
.tbtn-next{background:var(--accent);color:#fff;flex:2;box-shadow:0 2px 6px rgba(26,92,255,0.20);}
.tbtn-next:hover{filter:brightness(1.1);}
.tbtn-pause{background:var(--pause-soft);color:var(--pause);border:1px solid rgba(184,112,0,0.22);}
.tbtn-giqi{background:var(--giqi-soft);color:var(--giqi);border:1px solid rgba(124,0,200,0.22);}
.tbtn-giqi.on{background:var(--giqi);color:#fff;}
.tbtn-hiyari{background:var(--hiyari-soft);color:var(--hiyari);border:1px solid rgba(200,0,80,0.22);}
.tbtn-resume{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.22);flex:2;}
.tbtn-cancel{background:var(--danger-soft);color:var(--danger);border:1px solid rgba(217,0,25,0.18);}
.tbtn-restore{background:var(--success);color:#fff;flex:2;}
.tbtn-restore:hover{filter:brightness(1.1);}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:38px;margin-bottom:10px;}
.empty-state p{font-size:14px;}
.cancelled-section{margin-top:16px;}
.cancelled-header{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-bottom:8px;padding:0 2px;}
.filter-bar{display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;box-shadow:var(--shadow);flex-wrap:wrap;}
.filter-bar label{font-size:12px;color:var(--muted);font-weight:500;}
.filter-input{background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 9px;outline:none;}
.filter-input:focus{border-color:var(--accent);}
.btn-filter{padding:7px 13px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-filter.sec{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:12px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:13px;text-align:center;box-shadow:var(--shadow);}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--accent);}
.stat-label{font-size:10px;color:var(--muted);margin-top:3px;font-weight:500;}
.section-title{font-size:10px;font-family:'JetBrains Mono',monospace;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;margin-top:14px;}
.section-title:first-child{margin-top:0;}
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:var(--shadow);}
.bar-row{display:flex;align-items:center;gap:9px;margin-bottom:7px;}
.bar-label{width:130px;font-size:11px;color:var(--text);flex-shrink:0;text-align:right;font-weight:500;}
.bar-wrap{flex:1;height:24px;background:var(--surface2);border-radius:5px;overflow:hidden;}
.bar-fill{height:100%;border-radius:5px;transition:width 0.7s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;color:#fff;min-width:44px;}
.bar-fill.bn{background:linear-gradient(90deg,var(--danger),#ff4520);}
.bar-fill.nrm{background:linear-gradient(90deg,var(--accent),#3d77ff);}
.bar-fill.fst{background:linear-gradient(90deg,var(--success),#00a84e);}
.bar-fill.giq{background:linear-gradient(90deg,var(--giqi),#a020f0);}
.bar-fill.hiy{background:linear-gradient(90deg,var(--hiyari),#ff2060);}
.bn-badge{background:var(--danger-soft);border:1px solid var(--danger);color:var(--danger);font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 7px;border-radius:4px;flex-shrink:0;font-weight:700;}
.history-controls{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap;}
.btn-csv{padding:9px 16px;background:var(--success);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;box-shadow:0 2px 8px rgba(0,122,56,0.22);}
.btn-csv:hover{filter:brightness(1.1);}
.btn-clear{padding:9px 13px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-clear:hover{color:var(--danger);border-color:var(--danger);}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);overflow-x:auto;margin-bottom:12px;}
.data-table{width:100%;border-collapse:collapse;font-size:11px;}
.data-table th{text-align:left;padding:8px 10px;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap;}
.data-table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;}
.data-table tr:last-child td{border-bottom:none;}
.data-table tr:hover td{background:var(--surface2);}
.bn-text{color:var(--danger);font-weight:700;}
.tag{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700;}
.tag-done{background:var(--success-soft);color:var(--success);}
.tag-cancelled{background:var(--danger-soft);color:var(--danger);}
.tag-giqi{background:var(--giqi-soft);color:var(--giqi);}
.tag-hiyari{background:var(--hiyari-soft);color:var(--hiyari);}
.pending-badge{background:var(--hiyari-soft);color:var(--hiyari);font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;border:1px solid rgba(200,0,80,0.3);}
.btn-write{padding:5px 11px;background:var(--hiyari);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-write:hover{filter:brightness(1.1);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);padding:16px;}
.modal-overlay.hidden{display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;width:100%;max-width:420px;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;}
.modal h3{font-size:16px;font-weight:900;margin-bottom:4px;}
.modal .modal-sub{font-size:12px;color:var(--muted);margin-bottom:14px;}
.step-select-list{display:flex;flex-direction:column;gap:6px;margin-bottom:13px;}
.step-select-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:9px;background:var(--surface2);border:1.5px solid var(--border);color:var(--text);cursor:pointer;font-size:13px;font-weight:600;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;text-align:left;touch-action:manipulation;width:100%;}
.step-select-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-soft);}
.step-sel-icon{font-size:17px;}
.step-sel-time{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--success);font-weight:700;}
.modal-cancel-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-top:8px;}
.modal-cancel-btn:hover{color:var(--text);}
.btn-save-modal{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:9px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-bottom:6px;}
.btn-save-modal:hover{filter:brightness(1.1);}
.btn-save-modal.danger{background:var(--hiyari);}
.btn-save-modal.dark{background:var(--text);}
.tag-modal-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.tag-modal-chip{padding:9px 16px;border-radius:99px;border:2px solid var(--border);background:var(--surface2);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.tag-modal-chip.sel-slow{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}
.tag-modal-chip.sel-fast{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-modal-chip.sel-normal{border-color:var(--muted);background:var(--surface2);color:var(--muted);}
.hiyari-section{margin-bottom:14px;}
.hiyari-section h4{font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;}
.hiyari-chips{display:flex;flex-wrap:wrap;gap:6px;}
.hiyari-chip{padding:7px 12px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.hiyari-chip.sel{border-color:var(--hiyari);background:var(--hiyari-soft);color:var(--hiyari);}
.hiyari-chip:hover{border-color:var(--hiyari);}
.hiyari-textarea{width:100%;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;font-size:13px;font-family:'Noto Sans JP',sans-serif;color:var(--text);outline:none;resize:vertical;min-height:70px;margin-top:8px;}
.hiyari-textarea:focus{border-color:var(--hiyari);}
.step-picker{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.step-pick-btn{padding:9px 12px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.step-pick-btn.sel{border-color:var(--hiyari);background:var(--hiyari-soft);color:var(--hiyari);}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--text);color:#fff;padding:10px 22px;border-radius:99px;font-size:13px;font-weight:700;transition:transform 0.3s;z-index:400;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.blinking{animation:pulse 1s ease-in-out infinite;}
@media(max-width:600px){
  .container{padding:10px;} header{padding:10px 12px;border-radius:11px;margin-bottom:10px;}
  .header-title{font-size:14px;} .clock{font-size:11px;} .sync-label{display:none;}
  .tab{font-size:11px;padding:8px 2px;}
  .spinner-btn{width:54px;height:58px;font-size:27px;} .ticket-input{font-size:27px;width:70px;}
  .btn-add{font-size:14px;height:58px;padding:0 16px;}
  .ticket-count-badge{width:100%;text-align:right;margin-left:0;}
  .tickets-grid{grid-template-columns:1fr;max-height:none;}
  .tbtn{font-size:11px;padding:10px 5px;min-height:44px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .stat-value{font-size:16px;} .filter-input{font-size:12px;max-width:120px;}
  .bar-label{width:95px;font-size:10px;} .modal{padding:16px;}
}
</style>
</head>
<body>

<div id="setupScreen">
  <div class="setup-card">
    <div class="logo">ğŸ¥</div>
    <h2>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</h2>
    <p>ã“ã®ç«¯æœ«ãŒä½¿ç”¨ã™ã‚‹<strong>åº—èˆ—ã‚³ãƒ¼ãƒ‰ï¼ˆ5æ¡ï¼‰</strong>ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>åŒã˜ã‚³ãƒ¼ãƒ‰ã®ç«¯æœ«é–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åŒæœŸãƒ»æ“ä½œã§ãã¾ã™ã€‚</p>
    <input type="text" class="setup-code-input" id="storeCodeInput" placeholder="00000" maxlength="5" inputmode="numeric">
    <div class="setup-hint" id="setupHint">ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002</div>
    <div style="margin-bottom:8px;text-align:left;font-size:12px;color:var(--muted);font-weight:500;">åˆè¨€è‘‰</div>
    <input type="password" id="secretInput" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" style="width:100%;text-align:center;font-family:'Noto Sans JP',sans-serif;font-size:20px;font-weight:700;background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:12px 10px;outline:none;color:var(--text);transition:border-color 0.15s;margin-bottom:8px;" onkeydown="if(event.key==='Enter')confirmStore()">
    <div class="setup-hint" id="secretHint" style="margin-bottom:16px;"> </div>
    <button class="btn-setup" onclick="confirmStore()">ã“ã®åº—èˆ—ã‚³ãƒ¼ãƒ‰ã§å§‹ã‚ã‚‹</button>
  </div>
</div>

<div id="mainApp">
<div class="container">
  <header>
    <div class="header-left">
      <div class="store-badge" onclick="changeStore()">ğŸª <span id="storeLabel">-----</span></div>
      <button class="refresh-btn" onclick="refreshTickets()" title="å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ğŸ—‘ ä»Šæ—¥ä»¥å¤–ã‚’å‰Šé™¤</button>
      <div class="header-title">èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</div>
    </div>
    <div class="header-right">
      <button onclick="cleanOldTickets()" style="padding:5px 11px;background:var(--danger-soft);color:var(--danger);border:1px solid rgba(217,0,25,0.25);border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;">ğŸ—‘ å¤ã„ç•ªå·ã‚’æ¶ˆã™</button><div class="sync-wrap"><div class="sync-dot" id="syncDot"></div><span class="sync-label" id="syncLabel">--</span></div>
      <div class="clock" id="clockDisplay"></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('measure')">â± è¨ˆæ¸¬</button>
    <button class="tab" onclick="switchTab('today')">ğŸ“… æœ¬æ—¥</button>
    <button class="tab" onclick="switchTab('hiyari')" id="hiyariTab">âš  ãƒ’ãƒ¤ãƒª</button>
    <button class="tab" onclick="switchTab('report')">ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ</button>
  </div>

  <div id="tab-measure" class="tab-content active">
    <div class="new-ticket-bar">
      <label>å‘¼ã³å‡ºã—ç•ªå·</label>
      <div class="num-spinner">
        <button class="spinner-btn" onmousedown="startRepeat(-1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(-1);return false;" ontouchend="stopRepeat()">âˆ’</button>
        <div class="sdiv"></div>
        <input type="number" class="ticket-input" id="ticketNumInput" min="1" max="999" value="1" oninput="clampNum()" onkeydown="if(event.key==='Enter')addTicket()">
        <div class="sdiv"></div>
        <button class="spinner-btn" onmousedown="startRepeat(1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(1);return false;" ontouchend="stopRepeat()">ï¼‹</button>
      </div>
      <button class="btn-add" onclick="addTicket()">â–¶ è¨ˆæ¸¬é–‹å§‹</button>
      <span class="ticket-count-badge" id="ticketCountBadge">0ä»¶ è¨ˆæ¸¬ä¸­</span>

      <div class="tags-row">
        <label>ã‚¿ã‚°</label>
        <div id="newTagChips" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
    </div>
    <div class="tickets-grid" id="ticketsGrid">
      <div class="empty-state" id="emptyState"><div class="icon">ğŸ¥</div><p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p></div>
    </div>
    <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã¯æœ¬æ—¥ã‚¿ãƒ–ã¸ç§»å‹• -->
  </div>

  <div id="tab-today" class="tab-content">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:12px;box-shadow:var(--shadow);">
      <div id="todayStats" style="display:flex;gap:12px;flex-wrap:wrap;"></div>
    </div>
    <div id="todayGrid" class="tickets-grid"></div>
    <div id="todayEmpty" class="empty-state" style="display:none;"><div class="icon">ğŸ“…</div><p>æœ¬æ—¥ã®å®Œäº†ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç•ªå·ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>
  </div>

  <div id="tab-report" class="tab-content">
    <!-- CSVå‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:12px;box-shadow:var(--shadow);">
      <div style="font-size:12px;font-weight:900;margin-bottom:10px;">ğŸ“¤ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button class="btn-csv" onclick="exportWeeklyReport()" style="padding:8px 16px;font-size:12px;">â¬‡ é€±å ±CSVï¼ˆæœˆã€œæ—¥ï¼‰</button>
        <button class="btn-csv" onclick="exportMonthlyReport()" style="padding:8px 16px;font-size:12px;">â¬‡ æœˆå ±CSV</button>
        <select id="reportWeekSel" class="filter-input" style="font-size:11px;"></select>
        <select id="reportMonthSel" class="filter-input" style="font-size:11px;"></select>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--muted);">â€» è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ï¼‹ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã‚’çµ±åˆå‡ºåŠ›ã€‚ç¢ºèªæŠ¼å°æ¬„ä»˜ãã€‚</div>
    </div>

    <!-- è¨ˆæ¸¬åˆ†æ -->
    <div class="section-title" style="margin-top:0;">ğŸ“Š è¨ˆæ¸¬åˆ†æ</div>
    <div class="filter-bar">
      <label>æ—¥ä»˜</label><input type="date" class="filter-input" id="filterFrom"><label>ã€œ</label><input type="date" class="filter-input" id="filterTo">
      <label>ã‚¿ã‚°</label><select class="filter-input" id="filterTag"><option value="">ã™ã¹ã¦</option></select>
      <button class="btn-filter" onclick="updateAnalysis()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearFilter()">ã‚¯ãƒªã‚¢</button>
      <button id="outlierToggle" class="btn-filter sec" onclick="toggleOutlier()" style="margin-left:auto;display:flex;align-items:center;gap:5px;">
        <span id="outlierIcon">â—‹</span> å¤–ã‚Œå€¤ã‚’é™¤å¤–
      </button>
    </div>
    <div id="outlierInfo" style="display:none;background:var(--pause-soft);border:1px solid rgba(184,112,0,0.3);border-radius:8px;padding:8px 14px;font-size:11px;color:var(--pause);font-weight:700;margin-bottom:10px;"></div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="statTotal">-</div><div class="stat-label">å¹³å‡åˆè¨ˆæ™‚é–“</div></div>
      <div class="stat-card"><div class="stat-value" id="statSessions">0</div><div class="stat-label">å®Œäº†ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="statGiqiRate">-</div><div class="stat-label">ç–‘ç¾©ç…§ä¼šç‡</div></div>
      <div class="stat-card"><div class="stat-value" id="statBN">-</div><div class="stat-label">æœ€å¤šBNå·¥ç¨‹</div></div>
    </div>
    <div class="section-title">å·¥ç¨‹åˆ¥ å¹³å‡æ‰€è¦æ™‚é–“</div>
    <div class="chart-container" id="chartContainer"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">ç–‘ç¾©ç…§ä¼š åˆ†æ</div>
    <div class="chart-container" id="giqiChart"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>

    <!-- å±¥æ­´ -->
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:6px;margin-top:4px;">
      <div class="section-title" style="margin:0;">ğŸ“‹ è¨ˆæ¸¬å±¥æ­´</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <input type="date" class="filter-input" id="histFilterFrom" style="font-size:11px;">
        <label style="font-size:11px;color:var(--muted);">ã€œ</label>
        <input type="date" class="filter-input" id="histFilterTo" style="font-size:11px;">
        <select class="filter-input" id="histFilterTag" style="font-size:11px;"><option value="">ã‚¿ã‚°: ã™ã¹ã¦</option></select>
        <button class="btn-filter" onclick="updateHistory()" style="font-size:11px;padding:5px 10px;">çµè¾¼</button>
        <button class="btn-filter sec" onclick="clearHistFilter()" style="font-size:11px;padding:5px 10px;">ã‚¯ãƒªã‚¢</button>
        <button class="btn-csv" onclick="exportCSV()" style="font-size:11px;padding:5px 10px;">â¬‡CSV</button>
        <button class="btn-clear" onclick="clearHistory()" style="font-size:11px;padding:5px 10px;">å‰Šé™¤</button>
        <span style="font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;" id="histCount"></span>
      </div>
    </div>
    <div class="table-wrap" style="margin-bottom:12px;">
      <table class="data-table" style="min-width:900px;">
        <thead><tr><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ã‚¿ã‚°</th><th>å—ä»˜ãƒ»å…¥åŠ›</th><th>å‡¦æ–¹ç›£æŸ»ãƒ»ï¾‹ï¾Ÿï½¯ï½·ï¾ï½¸ï¾</th><th>ç›£æŸ»ãƒ»ç¢ºèª</th><th>æŠ•è–¬ãƒ»èª¬æ˜</th><th>åˆè¨ˆ</th><th>BNå·¥ç¨‹</th><th>ç–‘ç¾©</th><th>ç–‘ç¾©æ™‚é–“</th><th>ï¾‹ï¾”ï¾˜</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="14"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="tab-hiyari" class="tab-content">

    <!-- ğŸ”´ æœ¬æ—¥ã®æœªè¨˜è¼‰ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæœ€ä¸Šéƒ¨ï¼‰ -->
    <div id="hiyariPendingAlert" style="display:none;background:var(--hiyari);border-radius:12px;padding:12px 16px;margin-bottom:10px;color:#fff;">
      <div style="font-size:13px;font-weight:900;margin-bottom:8px;">âš  æœ¬æ—¥ã®æœªè¨˜è¼‰ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ â€” ã‚¿ãƒƒãƒ—ã—ã¦è¨˜è¼‰ã—ã¦ãã ã•ã„</div>
      <div id="hiyariPendingCards" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
    </div>

    <!-- æœ¬æ—¥åˆ†ä¸€è¦§ï¼ˆæœªè¨˜è¼‰ãŒä¸Šï¼‰ -->
    <div id="hiyariTodaySection">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:4px;">
        <div class="section-title" style="margin:0;color:var(--hiyari);">ğŸ“‹ æœ¬æ—¥ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ</div>
        <button class="btn-csv" onclick="exportHiyariCSV()" style="font-size:11px;padding:5px 10px;">â¬‡CSV</button>
      </div>
      <div class="table-wrap" style="margin-bottom:14px;">
        <table class="data-table" style="min-width:700px;">
          <thead><tr><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ç™ºç”Ÿå·¥ç¨‹</th><th>è¨˜è¼‰çŠ¶æ³</th><th>ãƒŸã‚¹å†…å®¹</th><th>ãƒ•ãƒªãƒ¼è¨˜è¼‰</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="hiyariTodayBody"><tr><td colspan="7"><div class="empty-state" style="padding:16px"><p>æœ¬æ—¥ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p></div></td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ã‚µãƒãƒªãƒ¼ -->
    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:10px;">
      <div class="stat-card"><div class="stat-value" id="hStatTotal">0</div><div class="stat-label">ç·ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="hStatPending" style="color:var(--hiyari)">0</div><div class="stat-label">æœªè¨˜è¼‰</div></div>
      <div class="stat-card"><div class="stat-value" id="hStatPendingRate" style="color:var(--hiyari)">-</div><div class="stat-label">æœªè¨˜è¼‰ç‡</div></div>
    </div>

    <!-- æœˆã®4é€±åˆ† å¯¾ç­–ãƒ¡ãƒ¢ -->
    <div class="section-title">ğŸ“ ä»Šæœˆã®é€±åˆ¥å¯¾ç­–ãƒ¡ãƒ¢ï¼ˆç¬¬1ã€œ4é€±ï¼‰</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;" id="weekMemoGrid"></div>

    <!-- æ—¥åˆ¥æœªè¨˜å…¥çŠ¶æ³ -->
    <div class="section-title">æ—¥åˆ¥ æœªè¨˜å…¥çŠ¶æ³ï¼ˆç›´è¿‘14æ—¥ï¼‰</div>
    <div class="chart-container" id="hiyariDailyChart"><div class="empty-state" style="padding:16px"><div class="icon">ğŸ“…</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>

    <!-- é€±é–“ãƒ»æœˆé–“ã‚µãƒãƒªãƒ¼ -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
      <div>
        <div class="section-title" style="margin-top:0;">é€±é–“ã‚µãƒãƒªãƒ¼ï¼ˆç›´è¿‘6é€±ï¼‰</div>
        <div class="chart-container" id="hiyariWeekChart"><div class="empty-state" style="padding:16px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div></div>
      </div>
      <div>
        <div class="section-title" style="margin-top:0;">æœˆé–“ã‚µãƒãƒªãƒ¼ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰</div>
        <div class="chart-container" id="hiyariMonthChart"><div class="empty-state" style="padding:16px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div></div>
      </div>
    </div>

    <!-- å·¥ç¨‹åˆ¥ãƒ»æ™‚é–“å¸¯åˆ¥ãƒ»åŸå›  -->
    <div class="section-title">å·¥ç¨‹åˆ¥ ç™ºç”Ÿä»¶æ•°</div>
    <div class="chart-container" id="hiyariStepChart"><div class="empty-state" style="padding:20px"><div class="icon">âš </div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">æ™‚é–“å¸¯åˆ¥ ç™ºç”Ÿä»¶æ•°</div>
    <div class="chart-container" id="hiyariTimeChart"><div class="empty-state" style="padding:20px"><div class="icon">â°</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">ãƒŸã‚¹å†…å®¹ãƒ»åŸå›  åˆ†æï¼ˆä¸Šä½10ä»¶ï¼‰</div>
    <div class="chart-container" id="hiyariCauseChart"><div class="empty-state" style="padding:20px"><div class="icon">ğŸ”</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>

    <!-- éå»åˆ†ä¸€è¦§ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px;">
      <div class="section-title" style="margin:0;">éå»ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆä¸€è¦§</div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <select class="filter-input" id="hiyariFilterStatus" style="font-size:11px;"><option value="">ã™ã¹ã¦</option><option value="pending">æœªè¨˜è¼‰</option><option value="done">è¨˜è¼‰æ¸ˆ</option></select>
        <input type="date" class="filter-input" id="hiyariFilterFrom" style="font-size:11px;">
        <label style="font-size:11px;color:var(--muted);">ã€œ</label>
        <input type="date" class="filter-input" id="hiyariFilterTo" style="font-size:11px;">
        <button class="btn-filter" onclick="updateHiyariTab()" style="font-size:11px;padding:5px 10px;">çµè¾¼</button>
        <button class="btn-filter sec" onclick="clearHiyariFilter()" style="font-size:11px;padding:5px 10px;">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div class="table-wrap">
      <table class="data-table" style="min-width:700px;">
        <thead><tr><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ç™ºç”Ÿå·¥ç¨‹</th><th>è¨˜è¼‰çŠ¶æ³</th><th>ãƒŸã‚¹å†…å®¹</th><th>ãƒ•ãƒªãƒ¼è¨˜è¼‰</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="hiyariBody"><tr><td colspan="8"><div class="empty-state" style="padding:24px"><div class="icon">âš </div><p>éå»ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p></div></td></tr></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- Modals -->
<div class="modal-overlay hidden" id="resumeModal">
  <div class="modal">
    <h3>å·¥ç¨‹ã‚’é¸æŠã—ã¦å†é–‹</h3>
    <div class="modal-sub" id="resumeModalSub"></div>
    <div class="step-select-list" id="resumeStepList"></div>
    <button class="modal-cancel-btn" onclick="closeResumeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="tagModal">
  <div class="modal">
    <h3>ğŸ· ã‚¿ã‚°ã‚’é¸æŠ</h3>
    <div class="modal-sub" id="tagModalSub">è¤‡æ•°é¸æŠã§ãã¾ã™</div>
    <div class="tag-modal-chips" id="tagModalChips"></div>
    <button class="btn-save-modal" onclick="saveTagModal()">ä¿å­˜</button>
    <button class="modal-cancel-btn" onclick="closeTagModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="hiyariPickModal">
  <div class="modal">
    <h3>âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆè¨˜éŒ²</h3>
    <div class="modal-sub" id="hiyariPickSub">ã©ã®å·¥ç¨‹ã§ç™ºç”Ÿã—ã¾ã—ãŸã‹ï¼Ÿ</div>
    <div class="step-picker" id="hiyariStepPicker"></div>
    <button class="btn-save-modal danger" onclick="flagHiyari('later')">ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦å¾Œã§è¨˜è¼‰ã™ã‚‹</button>
    <button class="btn-save-modal dark" style="margin-top:6px" onclick="flagHiyari('now')">ä»Šã™ãè¨˜è¼‰ã™ã‚‹ï¼ˆã“ã®ç•ªå·ã®æ™‚é–“ã‚’åœæ­¢ï¼‰</button>
    <button class="modal-cancel-btn" onclick="closeHiyariPickModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="hiyariWriteModal">
  <div class="modal">
    <h3>âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆè¨˜è¼‰</h3>
    <div class="modal-sub" id="hiyariWriteSub"></div>
    <div class="hiyari-section"><h4>â–¶ ä½•ã‚’é–“é•ãˆãŸã‹ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-mistake"></div></div>
    <div class="hiyari-section"><h4>â–¶ å„èª¿å‰¤æ©Ÿå™¨ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯å‡ºã¦ã„ãŸã‹ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-alert"></div></div>
    <div class="hiyari-section"><h4>â–¶ æ°—ã¥ã„ãŸãã£ã‹ã‘ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-notice"></div></div>
    <div class="hiyari-section"><h4>â–¶ ãƒŸã‚¹åŸå› ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-cause"></div></div>
    <div class="hiyari-section"><h4>â–¶ ãƒ•ãƒªãƒ¼è¨˜è¼‰</h4><textarea class="hiyari-textarea" id="hiyariNote" placeholder="è©³ç´°ãƒ»çŠ¶æ³ãƒ»å¯¾ç­–ãªã©è‡ªç”±ã«è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea></div>
    <button class="btn-save-modal danger" onclick="saveHiyariWrite()">ä¿å­˜ã™ã‚‹</button>
    <button class="modal-cancel-btn" onclick="closeHiyariWriteModal()">å¾Œã§è¨˜è¼‰ã™ã‚‹</button>
  </div>
</div>

<div class="modal-overlay hidden" id="numEditModal">
  <div class="modal">
    <h3>ğŸ”¢ ç•ªå·ã‚’å¤‰æ›´</h3>
    <div class="modal-sub" id="numEditSub"></div>
    <div style="display:flex;align-items:center;justify-content:center;gap:0;margin:16px 0;">
      <div class="num-spinner">
        <button class="spinner-btn" onmousedown="startRepeatEdit(-1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeatEdit(-1);return false;" ontouchend="stopRepeat()">âˆ’</button>
        <div class="sdiv"></div>
        <input type="number" class="ticket-input" id="numEditInput" min="1" max="999" value="1" style="font-size:32px;width:90px;">
        <div class="sdiv"></div>
        <button class="spinner-btn" onmousedown="startRepeatEdit(1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeatEdit(1);return false;" ontouchend="stopRepeat()">ï¼‹</button>
      </div>
    </div>
    <button class="btn-save-modal" onclick="confirmNumEdit()">å¤‰æ›´ã™ã‚‹</button>
    <button class="modal-cancel-btn" onclick="closeNumEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div class="modal-overlay hidden" id="numSwapModal">
  <div class="modal">
    <h3>ğŸ”„ ç•ªå·ãŒä½¿ç”¨ä¸­ã§ã™</h3>
    <div class="modal-sub" id="numSwapSub"></div>
    <button class="btn-save-modal" onclick="confirmSwap()" style="margin-top:8px">äº¤æ›ã™ã‚‹</button>
    <button class="modal-cancel-btn" onclick="closeSwapModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDKs (compatç‰ˆ = window.firebase ã«å…¬é–‹ã•ã‚Œã‚‹) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase init
// =============================
// åˆè¨€è‘‰ã¯ã“ã“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
var SECRET_WORD = 'red';
// =============================

firebase.initializeApp({
  apiKey:"AIzaSyDOfrlBz3QFG_XtBlwUe43tqPQKv8eiv4s",
  authDomain:"bottleneck-shiraberu.firebaseapp.com",
  databaseURL:"https://bottleneck-shiraberu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"bottleneck-shiraberu",
  storageBucket:"bottleneck-shiraberu.firebasestorage.app",
  messagingSenderId:"241290767512",
  appId:"1:241290767512:web:4290cf43b493fdc9f774ed"
});
var db = firebase.database();

var PROC=[{id:'reception',name:'å—ä»˜ãƒ»å…¥åŠ›',icon:'ğŸ“‹'},{id:'picking',name:'å‡¦æ–¹ç›£æŸ»ãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚°',icon:'ğŸ’Š'},{id:'audit',name:'ç›£æŸ»ãƒ»ç¢ºèª',icon:'ğŸ”'},{id:'dispensing',name:'æŠ•è–¬ãƒ»èª¬æ˜',icon:'ğŸ¤'}];
var TAGS=[{id:'ippoka',label:'ä¸€åŒ…åŒ–',type:'slow'},{id:'sanzai',label:'æ•£å‰¤',type:'slow'},{id:'suizai',label:'æ°´å‰¤',type:'slow'},{id:'nanko',label:'è»Ÿè†ç·´ã‚Š',type:'slow'},{id:'shika',label:'æ­¯ç§‘',type:'fast'},{id:'ganka',label:'çœ¼ç§‘',type:'fast'},{id:'normal',label:'ã‚¿ã‚°ãªã—',type:'normal'}];
var HM={mistake:['è–¬å“å','å‰¤å½¢','è¦æ ¼','ãƒ¡ãƒ¼ã‚«ãƒ¼å','æ•°é‡','ç”¨æ³•','ç”¨é‡','æ—¥æ•°','å°å­—','ãã®ä»–'],alert:['ãƒ¬ã‚»ã‚³ãƒ³','é‡é‡ç›£æŸ»æ©Ÿ','Musubi','onedy','DSX','åˆ†åŒ…æ©Ÿ','ãã®ä»–'],notice:['è‡ªå·±ç›£æŸ»','æœ€çµ‚ç›£æŸ»','èª¿å‰¤æ©Ÿå™¨ã‚¢ãƒ©ãƒ¼ãƒˆ','ä»–å¾“æ¥­å“¡ã‹ã‚‰ã®æŒ‡æ‘˜','ãŠå®¢æ§˜ã‹ã‚‰ã®æŒ‡æ‘˜','ãã®ä»–'],cause:['ã‚¢ãƒ©ãƒ¼ãƒˆç„¡è¦–','å…¥åŠ›æ™‚QRã‚³ãƒ¼ãƒ‰ä¸ä½¿ç”¨','é›»å­å‡¦æ–¹ç®‹ï¼ˆåŒ»å¸«å´ã®ãƒŸã‚¹ï¼‰','è‡ªå·±ç›£æŸ»æœªå®Ÿæ–½','é‡é‡ç›£æŸ»ä¸ä½¿ç”¨ï¼ˆHHTä½¿ç”¨ï¼‰','é‡é‡ç›£æŸ»æ©Ÿä¸é©åˆ‡ä½¿ç”¨','ç–‘ç¾©ç…§ä¼šæœªå®Ÿæ–½','ç›£æŸ»æ‰‹é †éµå®ˆã›ãš','Musubiã®ä¸é©åˆ‡ä½¿ç”¨','ä¼šè¨ˆæ™‚ã®HHTæœªä½¿ç”¨','ãã®ä»–']};

var SC='',allT={},histC=[],hiyC=[],tickInt=null,resumeId=null,tagId=null,newTags=[],hiyTickId=null,hiyStep=null,hiyEditId=null,pausedHiy=false,repT=null,repI=null,todayStr=getToday();
var unsub1=null,unsub2=null,unsub3=null;

function getToday(){return new Date().toISOString().slice(0,10);}
function fRef(p){return db.ref('stores/'+SC+'/'+p);}
function syncDot(s){document.getElementById('syncDot').className='sync-dot '+s;document.getElementById('syncLabel').textContent={synced:'åŒæœŸæ¸ˆ',syncing:'åŒæœŸä¸­â€¦',error:'ã‚¨ãƒ©ãƒ¼'}[s]||'--';}

// SETUP
function setupInputListeners(){
  var inp=document.getElementById('storeCodeInput');
  inp.addEventListener('input',function(){var v=this.value.replace(/\D/g,'');this.value=v;var h=document.getElementById('setupHint');if(v.length===5){h.textContent='âœ“ '+v+' â€” æº–å‚™OKï¼';h.className='setup-hint ok';}else if(v.length>0){h.textContent='æ•°å­—5æ¡ï¼ˆ'+v.length+'/5ï¼‰';h.className='setup-hint err';}else{h.textContent='ä¾‹ï¼šæœ¬åº— â†’ 00001';h.className='setup-hint';}});
  inp.addEventListener('keydown',function(e){if(e.key==='Enter')confirmStore();});
}
function confirmStore(){
  var code=document.getElementById('storeCodeInput').value.replace(/\D/g,'');
  if(code.length!==5){
    var h=document.getElementById('setupHint');
    h.textContent='âš  5æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';h.className='setup-hint err';
    document.getElementById('storeCodeInput').focus();return;
  }
  var secretEl=document.getElementById('secretInput');
  var secret=secretEl?secretEl.value.trim():'';
  if(secret!==SECRET_WORD){
    var sh=document.getElementById('secretHint');
    if(sh){sh.textContent='âš  åˆè¨€è‘‰ãŒé•ã„ã¾ã™';sh.className='setup-hint err';}
    if(secretEl){secretEl.value='';secretEl.focus();}
    return;
  }
  SC=code;localStorage.setItem('rx_store_code',code);launchApp();
}
function refreshTickets(){
  if(!confirm('ä»Šæ—¥ï¼ˆ'+todayStr+'ï¼‰ä»¥å¤–ã®ãƒã‚±ãƒƒãƒˆã‚’Firebaseã‹ã‚‰å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ãƒ»å¤ã„æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚'))return;
  fRef('tickets').once('value',function(snap){
    var raw=snap.val()||{};
    var count=0;
    Object.keys(raw).forEach(function(k){
      if(!raw[k].dateStr||raw[k].dateStr!==todayStr){
        fRef('tickets/'+k).remove();
        delete allT[k];
        count++;
      }
    });
    renderAll();updateCountBadge();
    showToast('ğŸ—‘ '+count+'ä»¶ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  });
}
function changeStore(){
  if(!confirm('åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ'))return;
  if(unsub1)unsub1();if(unsub2)unsub2();if(unsub3)unsub3();
  allT={};histC={};hiyC=[];
  if(tickInt){clearInterval(tickInt);tickInt=null;}
  document.getElementById('mainApp').style.display='none';
  document.getElementById('setupScreen').style.display='flex';
  document.getElementById('storeCodeInput').value='';
  document.getElementById('setupHint').textContent='ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002';
  document.getElementById('setupHint').className='setup-hint';
}
function setNextUnusedNum(){
  var used=usedToday();
  var n=1;
  while(used.has(String(n))&&n<999)n++;
  document.getElementById('ticketNumInput').value=n;

}

var numEditTargetId=null, swapTargetId=null, swapNewNum=null, swapConflictId=null;

function openNumEditModal(id){
  var t=allT[id];if(!t)return;
  numEditTargetId=id;
  document.getElementById('numEditSub').textContent='No.'+t.ticketNum+' ã®ç•ªå·ã‚’å¤‰æ›´ã—ã¾ã™';
  document.getElementById('numEditInput').value=t.ticketNum;
  document.getElementById('numEditModal').classList.remove('hidden');
}
function closeNumEditModal(){
  document.getElementById('numEditModal').classList.add('hidden');
  numEditTargetId=null;
}
function startRepeatEdit(d){
  var e=document.getElementById('numEditInput');
  e.value=Math.max(1,Math.min(999,(parseInt(e.value)||1)+d));
  repT=setTimeout(function(){repI=setInterval(function(){e.value=Math.max(1,Math.min(999,(parseInt(e.value)||1)+d));},80);},380);
}
function confirmNumEdit(){
  var t=allT[numEditTargetId];if(!t)return;
  var newNum=String(document.getElementById('numEditInput').value).trim();
  if(!newNum||newNum===t.ticketNum){closeNumEditModal();return;}
  // åŒã˜ç•ªå·ã‹ãƒã‚§ãƒƒã‚¯
  if(newNum===t.ticketNum){closeNumEditModal();return;}
  // ä½¿ç”¨ä¸­ã‹ãƒã‚§ãƒƒã‚¯
  var conflict=null;
  Object.values(allT).forEach(function(other){
    if(other.id!==numEditTargetId&&other.ticketNum===newNum&&['active','paused','giqi'].indexOf(other.status)>=0){
      conflict=other;
    }
  });
  if(conflict){
    // äº¤æ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
    swapTargetId=numEditTargetId;
    swapNewNum=newNum;
    swapConflictId=conflict.id;
    document.getElementById('numSwapSub').textContent=
      'No.'+newNum+' ã¯ã™ã§ã«è¨ˆæ¸¬ä¸­ã§ã™ã€‚\nNo.'+t.ticketNum+' â†” No.'+newNum+' ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ';
    closeNumEditModal();
    document.getElementById('numSwapModal').classList.remove('hidden');
  } else {
    // å˜ç´”ã«å¤‰æ›´
    t.ticketNum=newNum;
    pushT(t);
    closeNumEditModal();
    renderAll();
    showToast('No.'+newNum+' ã«å¤‰æ›´ã—ã¾ã—ãŸ');
  }
}
function confirmSwap(){
  var t1=allT[swapTargetId],t2=allT[swapConflictId];
  if(!t1||!t2){closeSwapModal();return;}
  var tmp=t1.ticketNum;
  t1.ticketNum=t2.ticketNum;
  t2.ticketNum=tmp;
  pushT(t1);pushT(t2);
  closeSwapModal();
  renderAll();
  showToast('No.'+t1.ticketNum+' â†” No.'+t2.ticketNum+' ã‚’äº¤æ›ã—ã¾ã—ãŸ');
}
function closeSwapModal(){
  document.getElementById('numSwapModal').classList.add('hidden');
  swapTargetId=null;swapNewNum=null;swapConflictId=null;
}

function cleanOldTickets(){
  var count=0;
  Object.keys(allT).forEach(function(k){
    var t=allT[k];
    if(!t.dateStr||t.dateStr!==todayStr){
      fRef('tickets/'+k).remove();
      delete allT[k];
      count++;
    }
  });
  if(count>0){renderAll();updateCountBadge();showToast('ğŸ—‘ '+count+'ä»¶ã®å¤ã„ç•ªå·ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');}
  else{showToast('å¤ã„ç•ªå·ã¯ã‚ã‚Šã¾ã›ã‚“');}
}

function launchApp(){
  document.getElementById('setupScreen').style.display='none';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('storeLabel').textContent=SC;
  buildTagChips();startListening();loadMemos();
  setInterval(updateClock,1000);updateClock();
  setInterval(function(){var d=getToday();if(d!==todayStr){todayStr=d;fRef('tickets').remove();allT={};renderAll();showToast('ğŸŒ… æ—¥ä»˜ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');}},30000);
}

// FIREBASE (compat SDK)
function startListening(){
  syncDot('syncing');
  unsub1=fRef('tickets').on('value',function(snap){
    var raw=snap.val()||{};
    var toDelete=[];
    Object.keys(raw).forEach(function(k){
      if(!raw[k].stepTimes)raw[k].stepTimes={};
      if(!raw[k].tags)raw[k].tags=[];
      // åˆ¥ã®æ—¥ä»˜ã®ãƒã‚±ãƒƒãƒˆã¯è‡ªå‹•å‰Šé™¤
      if(raw[k].dateStr && raw[k].dateStr!==todayStr){
        toDelete.push(k);
        delete raw[k];
      }
    });
    toDelete.forEach(function(k){fRef('tickets/'+k).remove();});
    allT=raw;
    syncDot('synced');renderAll();updateCountBadge();setNextUnusedNum();if(document.getElementById('tab-today').classList.contains('active'))updateTodayTab();
    if(Object.values(allT).some(function(t){return['active','giqi'].indexOf(t.status)>=0;})&&!tickInt){
      tickInt=setInterval(renderTimers,500);
    }
  },function(){syncDot('error');});
  unsub2=fRef('history').on('value',function(snap){var d=snap.val();histC=d?Object.values(d):[];updateHistory();updateAnalysis();populateTagFilters();});
  unsub3=fRef('hiyari').on('value',function(snap){
    var d=snap.val();hiyC=d?Object.values(d):[];
    // æœªè¨˜è¼‰ä»¶æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¿ãƒ–ã‚’ç›®ç«‹ãŸã›ã‚‹
    var totalPending=hiyC.filter(function(h){return!h.written;}).length;
    refreshHiyariTabBadge();
    var hbt=document.getElementById('hiyariTab');
    if(hbt){
      if(totalPending>0){
        hbt.textContent='âš  ãƒ’ãƒ¤ãƒª '+totalPending+'ä»¶';
        if(!hbt.classList.contains('active')){
          hbt.style.background='var(--hiyari-soft)';hbt.style.color='var(--hiyari)';
          hbt.style.animation='pulse 1.5s ease-in-out infinite';
        }
      }else{
        hbt.textContent='âš  ãƒ’ãƒ¤ãƒª';
        hbt.style.background='';hbt.style.color='';hbt.style.animation='';
      }
    }
    if(document.getElementById('tab-hiyari').classList.contains('active'))updateHiyariTab();
    renderAll();
  });
}
function stopListening(){
  if(unsub1)fRef('tickets').off('value',unsub1);
  if(unsub2)fRef('history').off('value',unsub2);
  if(unsub3)fRef('hiyari').off('value',unsub3);
}
function pushT(t){
  fRef('tickets/'+t.id).set({id:t.id,ticketNum:t.ticketNum,status:t.status,currentStep:t.currentStep,stepTimes:t.stepTimes||{},pauseCount:t.pauseCount||0,giqiCount:t.giqiCount||0,giqiTotalMs:t.giqiTotalMs||0,giqiStart:t.giqiStart||null,tags:t.tags||[],totalStart:t.totalStart,stepStart:t.stepStart,pauseStart:t.pauseStart||null,pauseAccum:t.pauseAccum||0,cancelledAt:t.cancelledAt||null,dateStr:t.dateStr||todayStr}).catch(function(){syncDot('error');});
}
function removeT(id){fRef('tickets/'+id).remove();}
function pushHist(e){
  var list=histC.slice();list.push(e);
  fRef('history').set(list).catch(function(){syncDot('error');});
}
function pushHiy(){fRef('hiyari').set(hiyC).catch(function(){syncDot('error');});}

// SPINNER
function changeNum(d){var e=document.getElementById('ticketNumInput');e.value=Math.max(1,Math.min(999,(parseInt(e.value)||1)+d));}
function clampNum(){var e=document.getElementById('ticketNumInput'),v=parseInt(e.value);if(isNaN(v)||v<1)e.value=1;else if(v>999)e.value=999;}
function startRepeat(d){changeNum(d);repT=setTimeout(function(){repI=setInterval(function(){changeNum(d);},80);},380);}
function stopRepeat(){clearTimeout(repT);clearInterval(repI);}

// TAGS
function buildTagChips(){
  var wrap=document.getElementById('newTagChips');wrap.innerHTML='';
  TAGS.forEach(function(tag){
    var chip=document.createElement('span');chip.className='tag-chip tag-'+tag.type;chip.dataset.id=tag.id;chip.textContent=tag.label;
    if(newTags.indexOf(tag.id)>=0)chip.classList.add('selected');
    chip.addEventListener('click',function(){
      var i=newTags.indexOf(tag.id);
      if(i>=0){newTags.splice(i,1);chip.classList.remove('selected');}
      else{newTags.push(tag.id);chip.classList.add('selected');}
    });
    wrap.appendChild(chip);
  });
}
function openTagModal(tid){
  tagId=tid;var t=allT[tid];var cur=t?(t.tags||[]):[];
  document.getElementById('tagModalSub').textContent='No.'+(t?t.ticketNum:'?')+' ã®ã‚¿ã‚°ã‚’å¤‰æ›´ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰';
  var chips=document.getElementById('tagModalChips');chips.innerHTML='';
  TAGS.forEach(function(tag){
    var chip=document.createElement('button');chip.className='tag-modal-chip';chip.dataset.id=tag.id;chip.textContent=tag.label;
    if(cur.indexOf(tag.id)>=0)chip.classList.add('sel-'+tag.type);
    chip.addEventListener('click',function(){var s='sel-'+tag.type;chip.classList.contains(s)?chip.classList.remove(s):chip.classList.add(s);});
    chips.appendChild(chip);
  });
  document.getElementById('tagModal').classList.remove('hidden');
}
function saveTagModal(){
  var sel=[];document.querySelectorAll('#tagModalChips .tag-modal-chip').forEach(function(c){if(c.classList.length>1)sel.push(c.dataset.id);});
  if(tagId&&allT[tagId]){allT[tagId].tags=sel;pushT(allT[tagId]);}
  closeTagModal();
}
function closeTagModal(){document.getElementById('tagModal').classList.add('hidden');tagId=null;}

// TICKETS
function updateCountBadge(){
  var n=Object.values(allT).filter(function(t){return['active','paused','giqi'].indexOf(t.status)>=0;}).length;
  document.getElementById('ticketCountBadge').textContent=n+'ä»¶ è¨ˆæ¸¬ä¸­';
}
function usedToday(){
  // æœ¬æ—¥ä½¿ã£ãŸç•ªå·ã¯ã™ã¹ã¦ä½¿ç”¨æ¸ˆã¿ï¼ˆè¨ˆæ¸¬ä¸­ãƒ»å®Œäº†ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«å…¨éƒ¨ï¼‰
  var s=new Set();
  Object.values(allT).forEach(function(t){
    if(t.dateStr===todayStr)s.add(t.ticketNum);
  });
  // å±¥æ­´ã«ã‚ã‚‹æœ¬æ—¥å®Œäº†åˆ†ã‚‚å«ã‚ã‚‹ï¼ˆallTã‹ã‚‰æ¶ˆãˆãŸã‚‚ã®ï¼‰
  histC.forEach(function(h){
    if(h.dateISO===todayStr)s.add(h.ticketNum);
  });
  return s;
}
function addTicket(){
  var numEl=document.getElementById('ticketNumInput'),num=numEl.value.trim();
  if(!num)return;

  // ä½¿ç”¨æ¸ˆã¿ãªã‚‰æ¬¡ã®ä½¿ãˆã‚‹ç•ªå·ã«è‡ªå‹•ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é–‹å§‹
  if(usedToday().has(num)){
    setNextUnusedNum();
    num=String(numEl.value);
    if(usedToday().has(num)){showToast('âš  æœ¬æ—¥ä½¿ç”¨ã§ãã‚‹ç•ªå·ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  }
  var tags=newTags.length>0?newTags.slice():['normal'];
  var id='T'+Date.now(),now=Date.now();
  var t={id:id,ticketNum:num,status:'active',currentStep:0,stepTimes:{},pauseCount:0,giqiCount:0,giqiTotalMs:0,giqiStart:null,tags:tags,stepStart:now,pauseStart:null,pauseAccum:0,totalStart:now,dateStr:todayStr};
  allT[id]=t;pushT(t);
  setNextUnusedNum();
  var em=document.getElementById('emptyState');if(em)em.remove();
  renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}
function completeStep(id){
  var t=allT[id];if(!t||t.status!=='active')return;
  var now=Date.now();t.stepTimes[PROC[t.currentStep].id]=(now-t.stepStart)-t.pauseAccum;t.pauseAccum=0;
  if(t.currentStep>=PROC.length-1){
    t.status='done';t.totalEnd=now;pushT(t);saveToHistory(t);
    setTimeout(function(){removeT(id);delete allT[id];renderAll();updateCountBadge();},1500);
    renderAll();updateAnalysis();updateCountBadge();
  }else{t.currentStep++;t.stepStart=now;pushT(t);renderAll();}
}
function pauseTicket(id){var t=allT[id];if(!t||t.status!=='active')return;t.status='paused';t.pauseStart=Date.now();t.pauseCount++;pushT(t);renderAll();updateCountBadge();}
function toggleGiqi(id){
  var t=allT[id];if(!t)return;var now=Date.now();
  if(t.status==='giqi'){var el=now-t.giqiStart;t.giqiTotalMs=(t.giqiTotalMs||0)+el;t.pauseAccum=(t.pauseAccum||0)+el;t.status='active';t.giqiStart=null;showToast('ç–‘ç¾©ç…§ä¼šçµ‚äº† '+fmt(el));}
  else if(t.status==='active'){t.status='giqi';t.giqiStart=now;t.giqiCount=(t.giqiCount||0)+1;if(!t.pauseStart)t.pauseStart=now;showToast('ğŸ“ ç–‘ç¾©ç…§ä¼šä¸­â€¦');}
  else return;
  pushT(t);renderAll();updateCountBadge();
}
function resumeTicket_OLD(id){
  var t=allT[id];if(!t||t.status!=='paused')return;resumeId=id;
  var stepList=document.getElementById('resumeStepList');stepList.innerHTML='';
  PROC.forEach(function(p,i){
    var ts=t.stepTimes[p.id]?fmt(t.stepTimes[p.id]):'';
    var note=i===t.currentStep?'åœæ­¢ä¸­':i<t.currentStep?'å†è¨ˆæ¸¬':'';
    var btn=document.createElement('button');btn.className='step-select-btn';
    btn.innerHTML='<span class="step-sel-icon">'+p.icon+'</span><span>'+p.name+(note?'<span style="font-size:10px;color:var(--muted);margin-left:4px">ï¼ˆ'+note+'ï¼‰</span>':'')+'</span>'+(ts?'<span class="step-sel-time">'+ts+'</span>':'');
    (function(idx){btn.addEventListener('click',function(){confirmResume(idx);});})(i);
    stepList.appendChild(btn);
  });
  document.getElementById('resumeModalSub').textContent='No.'+t.ticketNum+' â€” ã©ã®å·¥ç¨‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ';
  document.getElementById('resumeModal').classList.remove('hidden');
}
function confirmResume_OLD(si){
  var id=resumeId;if(!id)return;var t=allT[id],now=Date.now();
  PROC.forEach(function(_,i){if(i>=si)delete t.stepTimes[PROC[i].id];});
  t.currentStep=si;t.stepStart=now;t.pauseAccum=0;t.pauseStart=null;t.status='active';
  pushT(t);closeResumeModal();renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}
function closeResumeModal_OLD(){document.getElementById('resumeModal').classList.add('hidden');resumeId=null;}

// ã‚·ãƒ³ãƒ—ãƒ«ãªå†é–‹
function resumeTicket(id){
  var t=allT[id];if(!t||t.status!=='paused')return;
  var now=Date.now();
  if(t.pauseStart){t.pauseAccum=(t.pauseAccum||0)+(now-t.pauseStart);}
  t.pauseStart=null;t.status='active';
  pushT(t);renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}

function cancelTicket(id){
  var t=allT[id];if(!t||['active','paused','giqi'].indexOf(t.status)<0)return;
  if(!confirm('No.'+t.ticketNum+' ã®è¨ˆæ¸¬ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ'))return;
  t.status='cancelled';t.cancelledAt=Date.now();pushT(t);renderAll();updateCountBadge();
  showToast('No.'+t.ticketNum+' ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
}
function restoreTicket(id){
  var t=allT[id];if(!t||t.status!=='cancelled')return;
  var now=Date.now();t.status='active';t.stepStart=now;t.pauseAccum=0;t.pauseStart=null;t.cancelledAt=null;
  pushT(t);renderAll();updateCountBadge();showToast('No.'+t.ticketNum+' ã‚’å¾©æ´»ã—ã¾ã—ãŸ');
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}

// RENDER
function stepElapsed(t){
  if(['paused','giqi'].indexOf(t.status)>=0)return Math.max(0,(t.pauseStart?t.pauseStart:Date.now())-t.stepStart-(t.pauseAccum||0));
  return Math.max(0,(Date.now()-t.stepStart)-(t.pauseAccum||0));
}
function totalElapsed(t){return(t.totalEnd||t.cancelledAt||Date.now())-t.totalStart;}

function renderAll(){
  var grid=document.getElementById('ticketsGrid');
  var savedScroll=grid.scrollTop;
  grid.querySelectorAll('.ticket-card').forEach(function(c){c.remove();});
  var emptyEl=document.getElementById('emptyState');
  var active=Object.values(allT).filter(function(t){return['active','paused','giqi'].indexOf(t.status)>=0;});
  var done=Object.values(allT).filter(function(t){return t.status==='done';});
  // cancelled ã¯æœ¬æ—¥ã‚¿ãƒ–ã§è¡¨ç¤º
  if(active.length+done.length===0){
    if(!emptyEl){var d=document.createElement('div');d.className='empty-state';d.id='emptyState';d.innerHTML='<div class="icon">ğŸ¥</div><p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>';grid.appendChild(d);}
    stopTicker();
  }else{
    if(emptyEl)emptyEl.remove();
    active.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
    done.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
    active.concat(done).forEach(function(t){renderCard(t,grid);});
    if(active.length===0)stopTicker();
  }
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
  grid.scrollTop=savedScroll;
  // æœ¬æ—¥ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚Œã°æ›´æ–°
  if(document.getElementById('tab-today').classList.contains('active'))updateTodayTab();
}

function renderCard(t,grid){
  var si=Math.min(t.currentStep,PROC.length-1),proc=PROC[si];
  var card=document.createElement('div');
  var sc=t.status==='giqi'?'giqi':t.status;
  card.className='ticket-card status-'+sc;card.id='card-'+t.id;
  var bl={active:'è¨ˆæ¸¬ä¸­',paused:'ä¸€æ™‚åœæ­¢',giqi:'ç–‘ç¾©ç…§ä¼šä¸­',done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[t.status]||t.status;
  var stepsHtml=PROC.map(function(p,i){
    var cls=i<t.currentStep||t.status==='done'?'done-step':i===t.currentStep&&['active','paused','giqi'].indexOf(t.status)>=0?'current'+(t.status==='paused'?' paused':t.status==='giqi'?' giqi':''):'pending';
    var ts=t.stepTimes&&t.stepTimes[p.id]?fmt(t.stepTimes[p.id]):cls.indexOf('current')>=0?'â€¦':'';
    return '<div class="step '+cls+'" title="'+p.name+'">'+p.icon+'<div class="step-time">'+ts+'</div></div>';
  }).join('');
  var tags=t.tags||[];
  var canEdit=['active','paused','giqi','cancelled'].indexOf(t.status)>=0;
  var tagsHtml='<div class="card-tags">'+tags.map(function(tid){var tag=TAGS.find(function(x){return x.id===tid;});return tag?'<span class="card-tag '+tag.type+'">'+tag.label+'</span>':'';}).join('')+(canEdit?'<button class="btn-tag-edit" onclick="openTagModal(\''+t.id+'\')">âœ ã‚¿ã‚°ç·¨é›†</button>':'')+'</div>';
  var hFlags=hiyC.filter(function(h){return h.ticketId===t.id&&!h.written;});
  var hFlagHtml=hFlags.length>0?'<div class="hiyari-flag"><span class="hf-dot"></span>ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆæœªè¨˜è¼‰ '+hFlags.length+'ä»¶</div>':'';
  var cpHtml='';
  if(['active','paused','giqi'].indexOf(t.status)>=0){
    var tc=t.status==='giqi'?'var(--giqi)':t.status==='paused'?'var(--pause)':'var(--accent)';
    var blink=['paused','giqi'].indexOf(t.status)>=0?' blinking':'';
    cpHtml='<div class="current-process"><span class="proc-icon">'+proc.icon+'</span><span class="proc-name">'+proc.name+'</span><span class="proc-timer'+blink+'" style="color:'+tc+'"><span id="timer-'+t.id+'">00:00</span></span></div>';
  }else if(t.status==='done'){cpHtml='<div class="current-process"><span class="proc-icon">âœ…</span><span class="proc-name" style="color:var(--success)">å…¨å·¥ç¨‹å®Œäº†</span></div>';}
  else{cpHtml='<div class="current-process"><span class="proc-icon">âŒ</span><span class="proc-name" style="color:var(--muted)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</span></div>';}
  var giqiHtml=(t.giqiCount||0)>0?'<div class="giqi-info">ğŸ“ ç–‘ç¾©ç…§ä¼š <span>'+t.giqiCount+'å›</span>ã€€è¨ˆ <span>'+fmt(t.giqiTotalMs||0)+'</span>'+(t.status==='giqi'?' â±é€²è¡Œä¸­':'')+'</div>':'';
  var pauseHtml=(t.pauseCount||0)>0?'<div class="sub-info">â¸ ä¸€æ™‚åœæ­¢ '+t.pauseCount+'å›</div>':'';
  var canEditNum=['active','paused','giqi'].indexOf(t.status)>=0;
  card.innerHTML='<div class="ticket-header"><div class="ticket-num"'+(canEditNum?' onclick="openNumEditModal(\''+t.id+'\')" style="cursor:pointer;text-decoration:underline dotted;" title="ç•ªå·ã‚’å¤‰æ›´"':'')+'>No.'+t.ticketNum+'</div><span class="ticket-badge badge-'+sc+'">'+bl+'</span></div>'+tagsHtml+hFlagHtml+'<div class="steps">'+stepsHtml+'</div>'+cpHtml+'<div class="total-time" id="total-'+t.id+'">åˆè¨ˆ: <span>'+fmt(totalElapsed(t))+'</span></div>'+giqiHtml+pauseHtml+'<div class="ticket-buttons" id="btns-'+t.id+'"></div>';

  // ãƒœã‚¿ãƒ³ã‚’JSã§ç›´æ¥ç”Ÿæˆã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
  var btnWrap=card.querySelector('#btns-'+t.id);
  var tid=t.id;
  function mkBtn(cls,label,fn,extraStyle){
    var b=document.createElement('button');
    b.className='tbtn '+cls;b.textContent=label;
    if(extraStyle)b.style.cssText=extraStyle;
    b.addEventListener('click',fn);
    btnWrap.appendChild(b);
  }
  if(t.status==='active'){
    var isLast=t.currentStep>=PROC.length-1;
    mkBtn('tbtn-next',isLast?'âœ… æŠ•è–¬å®Œäº†':'âœ” æ¬¡ã®å·¥ç¨‹ã¸',function(){completeStep(tid);},'flex:2');
    mkBtn('tbtn-pause','ä¸€æ™‚åœæ­¢',function(){pauseTicket(tid);});
    mkBtn('tbtn-giqi','ç–‘ç¾©ç…§ä¼š',function(){toggleGiqi(tid);});
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='giqi'){
    mkBtn('tbtn-giqi on','ç–‘ç¾©ç…§ä¼šã‚’çµ‚äº†ã™ã‚‹',function(){toggleGiqi(tid);},'flex:2');
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='paused'){
    mkBtn('tbtn-resume','â–¶ ä¸€æ™‚åœæ­¢ã‚’è§£é™¤ã—ã¦å†é–‹',function(){resumeTicket(tid);},'flex:2');
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='cancelled'){
    mkBtn('tbtn-restore','ğŸ”„ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å–ã‚Šæ¶ˆã—ã¦å†é–‹ã™ã‚‹',function(){restoreTicket(tid);},'flex:2');
  }
  if(!btnWrap.children.length)btnWrap.style.display='none';
  grid.appendChild(card);
  if(['active','giqi'].indexOf(t.status)>=0)updTimer(t.id);
}

function renderTimers(){
  Object.values(allT).forEach(function(t){
    if(['active','giqi'].indexOf(t.status)<0)return;
    updTimer(t.id);
    var el=document.getElementById('total-'+t.id);
    if(el)el.innerHTML='åˆè¨ˆ: <span>'+fmt(totalElapsed(t))+'</span>';
  });
}
function updTimer(id){var t=allT[id];if(!t)return;var el=document.getElementById('timer-'+id);if(el)el.textContent=fmt(stepElapsed(t));}
function stopTicker(){if(!Object.values(allT).some(function(t){return['active','giqi'].indexOf(t.status)>=0;})&&tickInt){clearInterval(tickInt);tickInt=null;}}

// HISTORY
function saveToHistory(t){
  var dt=new Date(),total=Object.values(t.stepTimes||{}).reduce(function(a,b){return a+b;},0);
  var bnId=null,bnMs=0;
  Object.entries(t.stepTimes||{}).forEach(function(e){if(e[1]>bnMs){bnMs=e[1];bnId=e[0];}});
  var bnP=PROC.find(function(p){return p.id===bnId;});
  pushHist({storeCode:SC,ticketNum:t.ticketNum,date:dt.toLocaleDateString('ja-JP'),time:dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),dateISO:dt.toISOString().slice(0,10),ts:Date.now(),status:t.status,stepTimes:Object.assign({},t.stepTimes||{}),total:total,bottleneck:bnP?bnP.name:null,pauseCount:t.pauseCount||0,hasPause:(t.pauseCount||0)>0,giqiCount:t.giqiCount||0,giqiTotalMs:t.giqiTotalMs||0,tags:t.tags||[]});
}
function populateTagFilters(){
  var at=new Set();histC.forEach(function(h){(h.tags||[]).forEach(function(t){at.add(t);});});
  ['filterTag','histFilterTag'].forEach(function(fid){
    var sel=document.getElementById(fid),cur=sel.value;sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
    TAGS.forEach(function(tag){if(at.has(tag.id)){var o=document.createElement('option');o.value=tag.id;o.textContent=tag.label;if(cur===tag.id)o.selected=true;sel.appendChild(o);}});
  });
}
function getFiltered(fid,tid,tagid){
  var from=document.getElementById(fid).value,to=document.getElementById(tid).value,tag=document.getElementById(tagid).value;
  return histC.filter(function(h){if(from&&h.dateISO<from)return false;if(to&&h.dateISO>to)return false;if(tag&&(h.tags||[]).indexOf(tag)<0)return false;return true;});
}
function updateHistory(){
  var history=getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  document.getElementById('histCount').textContent=history.length+'ä»¶';
  var tbody=document.getElementById('historyBody');
  if(!history.length){tbody.innerHTML='<tr><td colspan="14"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';return;}
  tbody.innerHTML=history.slice().reverse().map(function(h){
    var steps=PROC.map(function(p){return h.stepTimes&&h.stepTimes[p.id]?fmt(h.stepTimes[p.id]):'-';}).join('</td><td>');
    var stTag=h.status==='done'?'<span class="tag tag-done">å®Œäº†</span>':'<span class="tag tag-cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
    var tagHtml=(h.tags||[]).map(function(tid){var tag=TAGS.find(function(x){return x.id===tid;});return tag?'<span class="card-tag '+tag.type+'" style="font-size:10px">'+tag.label+'</span>':'';}).join(' ');
    var giqiHtml=(h.giqiCount||0)>0?'<span class="tag tag-giqi">'+h.giqiCount+'å›</span>':'<span style="color:var(--muted)">-</span>';
    var hiyN=hiyC.filter(function(hh){return hh.ticketNum===h.ticketNum&&hh.dateISO===h.dateISO;}).length;
    var hiyHtml=hiyN>0?'<span class="tag tag-hiyari">'+hiyN+'ä»¶</span>':'<span style="color:var(--muted)">-</span>';
    return '<tr><td style="font-family:\'JetBrains Mono\',monospace">'+(h.date||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace">'+(h.time||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace;font-weight:700">No.'+h.ticketNum+'</td><td>'+(tagHtml||'-')+'</td><td>'+steps+'</td><td style="font-family:\'JetBrains Mono\',monospace;font-weight:700">'+(h.total?fmt(h.total):'-')+'</td><td class="bn-text">'+(h.bottleneck||'-')+'</td><td>'+giqiHtml+'</td><td style="font-family:\'JetBrains Mono\',monospace">'+((h.giqiTotalMs||0)>0?fmt(h.giqiTotalMs):'-')+'</td><td>'+hiyHtml+'</td><td>'+stTag+'</td></tr>';
  }).join('');
}
function clearFilter(){document.getElementById('filterFrom').value='';document.getElementById('filterTo').value='';document.getElementById('filterTag').value='';updateAnalysis();}
function clearHistFilter(){document.getElementById('histFilterFrom').value='';document.getElementById('histFilterTo').value='';document.getElementById('histFilterTag').value='';updateHistory();}
function clearHistory(){if(!confirm('ã“ã®åº—èˆ—ã®å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;histC=[];fRef('history').remove();updateHistory();updateAnalysis();showToast('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');}
function exportAnalysisCSV(){
  var done=getFiltered('filterFrom','filterTo','filterTag').filter(function(h){return h.status==='done';});
  if(!done.length){showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var avgs={},cnts={};
  PROC.forEach(function(p){avgs[p.id]=0;cnts[p.id]=0;});
  done.forEach(function(h){
    PROC.forEach(function(p){
      if(h.stepTimes&&h.stepTimes[p.id]){avgs[p.id]+=h.stepTimes[p.id];cnts[p.id]++;}
    });
  });
  PROC.forEach(function(p){avgs[p.id]=cnts[p.id]?avgs[p.id]/cnts[p.id]:0;});
  var headers=['é›†è¨ˆæœŸé–“','å®Œäº†ä»¶æ•°','å¹³å‡åˆè¨ˆ(ç§’)']
    .concat(PROC.map(function(p){return p.name+'å¹³å‡(ç§’)';})).concat(['ç–‘ç¾©ç…§ä¼šç‡','ç–‘ç¾©ç…§ä¼šå¹³å‡(ç§’)','BNå·¥ç¨‹']);
  var from=document.getElementById('filterFrom').value||(done.length?done[done.length-1].dateISO:'');
  var to=document.getElementById('filterTo').value||(done.length?done[0].dateISO:'');
  var gD=done.filter(function(h){return(h.giqiCount||0)>0;});
  var avgTotal=done.reduce(function(a,h){return a+(h.total||0);},0)/done.length;
  var avgGiqi=gD.length?gD.reduce(function(a,h){return a+(h.giqiTotalMs||0);},0)/gD.length:0;
  var bnEntry=Object.entries(avgs).sort(function(a,b){return b[1]-a[1];})[0];
  var bnName=bnEntry?(PROC.find(function(p){return p.id===bnEntry[0];})||{}).name||'-':'-';
  var row=[from+'~'+to,done.length,(avgTotal/1000).toFixed(1)]
    .concat(PROC.map(function(p){return (avgs[p.id]/1000).toFixed(1);}))
    .concat([Math.round((gD.length/done.length)*100)+'%',(avgGiqi/1000).toFixed(1),bnName]);
  function q(v){return '"'+String(v).replace(/"/g,'""')+'"';}
  var lines=[headers.map(q).join(','),row.map(q).join(',')];
  var csv='\uFEFF'+lines.join('\r\n');
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download='åˆ†æ_'+SC+'_'+getToday()+'.csv';
  a.click();URL.revokeObjectURL(a.href);
  showToast('åˆ†æCSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}


function exportCSV(){
  var history=getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  if(!history.length){showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var headers=['åº—èˆ—ã‚³ãƒ¼ãƒ‰','æ—¥ä»˜','æ™‚åˆ»','å‘¼ã³å‡ºã—ç•ªå·','ã‚¿ã‚°'].concat(PROC.map(function(p){return p.name;})).concat(['åˆè¨ˆæ™‚é–“(s)','BNå·¥ç¨‹','ç–‘ç¾©ç…§ä¼šå›æ•°','ç–‘ç¾©ç…§ä¼šæ™‚é–“(s)','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆä»¶æ•°','ä¸€æ™‚åœæ­¢å›æ•°','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']);
  var rows=history.slice().reverse().map(function(h){
    return [SC,h.date||'',h.time||'','No.'+h.ticketNum,(h.tags||[]).map(function(tid){var t=TAGS.find(function(x){return x.id===tid;});return t?t.label:tid;}).join('ãƒ»')].concat(PROC.map(function(p){return h.stepTimes&&h.stepTimes[p.id]?((h.stepTimes[p.id]/1000).toFixed(1)):'-';})).concat([h.total?(h.total/1000).toFixed(1):'-',h.bottleneck||'',h.giqiCount||0,(h.giqiTotalMs||0)>0?((h.giqiTotalMs/1000).toFixed(1)):'-',hiyC.filter(function(hh){return hh.ticketNum===h.ticketNum&&hh.dateISO===h.dateISO;}).length,h.pauseCount||0,{done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[h.status]||h.status]);
  });
  var csv='\uFEFF'+[headers].concat(rows).map(function(r){return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(',');}).join('\r\n');
  var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download='èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯_'+SC+'_'+getToday()+'.csv';a.click();URL.revokeObjectURL(a.href);showToast('âœ“ CSVå‡ºåŠ› '+rows.length+'ä»¶');
}

// TODAY TAB
function updateTodayTab(){
  var grid=document.getElementById('todayGrid');
  var emptyEl=document.getElementById('todayEmpty');
  grid.innerHTML='';

  // å®Œäº†ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆallTã‹ã‚‰å½“æ—¥åˆ†ï¼‰
  var finishedActive=Object.values(allT).filter(function(t){
    return t.dateStr===todayStr&&['done','cancelled'].indexOf(t.status)>=0;
  });
  // å±¥æ­´ã‹ã‚‰å½“æ—¥å®Œäº†åˆ†ï¼ˆallTã«æ®‹ã£ã¦ã„ãªã„ã‚‚ã®ï¼‰
  var histToday=histC.filter(function(h){return h.dateISO===todayStr;});

  var cntDone=0,cntCancelled=0;

  // allTã«ã‚ã‚‹å®Œäº†ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  finishedActive.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
  finishedActive.forEach(function(t){
    if(t.status==='done')cntDone++;
    if(t.status==='cancelled')cntCancelled++;
    renderTodayCard(t,grid,false);
  });

  // å±¥æ­´ã«ã®ã¿ã‚ã‚‹å®Œäº†åˆ†ï¼ˆallTã‹ã‚‰æ¶ˆãˆãŸã‚‚ã®ï¼‰
  histToday.forEach(function(h){
    var inActive=finishedActive.find(function(t){return t.ticketNum===h.ticketNum;});
    if(!inActive){
      cntDone++;
      renderTodayCard(h,grid,true);
    }
  });

  var total=cntDone+cntCancelled;
  document.getElementById('todayStats').innerHTML=
    '<div style="background:var(--success-soft);border:1px solid rgba(0,122,56,0.2);border-radius:9px;padding:8px 14px;font-size:12px;font-weight:700;color:var(--success)">âœ… å®Œäº† '+cntDone+'ä»¶</div>'+
    '<div style="background:var(--danger-soft);border:1px solid rgba(217,0,25,0.15);border-radius:9px;padding:8px 14px;font-size:12px;font-weight:700;color:var(--danger)">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« '+cntCancelled+'ä»¶</div>'+
    '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 14px;font-size:12px;font-weight:700;color:var(--muted)">åˆè¨ˆ '+total+'ç•ªå·</div>';

  if(total===0){
    grid.style.display='none';emptyEl.style.display='block';
  }else{
    grid.style.display='';emptyEl.style.display='none';
  }
}

function renderTodayCard(t,grid,isHistOnly){
  var card=document.createElement('div');
  var sc=t.status==='done'?'done':'cancelled';
  card.className='ticket-card status-'+sc;
  var bl=t.status==='done'?'å®Œäº†':'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
  var tags=t.tags||[];
  var tagsHtml='<div class="card-tags">'+tags.map(function(tid){
    var tag=TAGS.find(function(x){return x.id===tid;});
    return tag?'<span class="card-tag '+tag.type+'">'+tag.label+'</span>':'';
  }).join('')+'</div>';

  // å·¥ç¨‹æ™‚é–“
  var stepTimes=t.stepTimes||{};
  var stepsHtml=PROC.map(function(p){
    var done=stepTimes[p.id]>0;
    var cls=done?'done-step':'pending';
    var ts=done?fmt(stepTimes[p.id]):'';
    return '<div class="step '+cls+'" title="'+p.name+'">'+p.icon+'<div class="step-time">'+ts+'</div></div>';
  }).join('');

  var total=t.total||Object.values(stepTimes).reduce(function(a,b){return a+b;},0);
  var totalStr=total>0?fmt(total):'-';

  // BNå·¥ç¨‹
  var bnId=null,bnMs=0;
  Object.entries(stepTimes).forEach(function(e){if(e[1]>bnMs){bnMs=e[1];bnId=e[0];}});
  var bnP=PROC.find(function(p){return p.id===bnId;});
  var bnStr=bnP?'<span style="font-size:11px;color:var(--danger);font-weight:700;">BN: '+bnP.name+'</span>':'';

  var statusBadge='<span class="ticket-badge badge-'+sc+'">'+bl+'</span>';

  // è¨ˆæ¸¬ä¸­ã«æˆ»ã™ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã¿ã€å±¥æ­´ã®ã¿ã®ã‚‚ã®ã¯ä¸å¯ï¼‰
  var restoreBtn='';
  if(t.status==='cancelled'&&!isHistOnly&&t.id){
    restoreBtn='<button class="tbtn tbtn-restore" style="margin-top:8px;flex:1" id="restore-'+t.id+'">â–¶ è¨ˆæ¸¬ä¸­ã«æˆ»ã™</button>';
  }
  // å®Œäº†ã‚’è¨ˆæ¸¬ä¸­ã«æˆ»ã™ï¼ˆallTã«ã‚ã‚‹å ´åˆï¼‰
  var reopenBtn='';
  if(t.status==='done'&&!isHistOnly&&t.id){
    reopenBtn='<button class="tbtn" style="margin-top:8px;flex:1;background:var(--pause-soft);color:var(--pause);border:1px solid rgba(184,112,0,0.22);" id="reopen-'+t.id+'">â†© æœ€çµ‚å·¥ç¨‹ã‹ã‚‰å†è¨ˆæ¸¬</button>';
  }

  card.innerHTML=
    '<div class="ticket-header"><div class="ticket-num">No.'+t.ticketNum+'</div>'+statusBadge+'</div>'+
    tagsHtml+
    '<div class="steps">'+stepsHtml+'</div>'+
    '<div class="total-time">åˆè¨ˆ: <span>'+totalStr+'</span></div>'+
    bnStr+
    (restoreBtn||reopenBtn?'<div class="ticket-buttons">'+(restoreBtn||reopenBtn)+'</div>':'');

  grid.appendChild(card);

  // ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
  if(t.id){
    var rb=card.querySelector('#restore-'+t.id);
    if(rb)(function(id){rb.addEventListener('click',function(){restoreTicket(id);switchTab('measure');});})(t.id);
    var rpb=card.querySelector('#reopen-'+t.id);
    if(rpb)(function(id){rpb.addEventListener('click',function(){reopenTicket(id);switchTab('measure');});})(t.id);
  }
}

function reopenTicket(id){
  var t=allT[id];if(!t||t.status!=='done')return;
  var now=Date.now();
  // æœ€å¾Œã®å·¥ç¨‹ã‚’å‰Šé™¤ã—ã¦å†è¨ˆæ¸¬
  var lastStep=PROC[PROC.length-1];
  delete t.stepTimes[lastStep.id];
  t.currentStep=PROC.length-1;
  t.status='active';t.stepStart=now;t.pauseAccum=0;t.pauseStart=null;t.totalEnd=null;
  pushT(t);renderAll();updateCountBadge();showToast('No.'+t.ticketNum+' ã‚’è¨ˆæ¸¬ä¸­ã«æˆ»ã—ã¾ã—ãŸ');
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}


// ANALYSIS
var outlierEnabled=false;
function toggleOutlier(){
  outlierEnabled=!outlierEnabled;
  var btn=document.getElementById('outlierToggle');
  document.getElementById('outlierIcon').textContent=outlierEnabled?'â—':'â—‹';
  btn.style.background=outlierEnabled?'var(--accent)':'';
  btn.style.color=outlierEnabled?'#fff':'';
  btn.style.borderColor=outlierEnabled?'var(--accent)':'';
  updateAnalysis();
}

// IQRæ³•ã§å¤–ã‚Œå€¤ã‚’æ¤œå‡ºã—ã¦é™¤å¤–ã€ãƒˆãƒªãƒ å¹³å‡ã§è£œå¼·
function removeOutliers(arr){
  if(arr.length<4)return{clean:arr,removed:0};
  var sorted=arr.slice().sort(function(a,b){return a-b;});
  var q1=sorted[Math.floor(sorted.length*0.25)];
  var q3=sorted[Math.floor(sorted.length*0.75)];
  var iqr=q3-q1;
  var lo=q1-1.5*iqr, hi=q3+1.5*iqr;
  // ãƒˆãƒªãƒ å¹³å‡ã§ã‚‚è£œå¼·ï¼šä¸Šä¸‹10%é™¤å¤–ã—ãŸå¹³å‡ã‚’ç®—å‡ºã—ã¦hiã®ä¸Šé™ã‚’è£œæ­£
  var trim=Math.floor(sorted.length*0.1);
  var trimmed=sorted.slice(trim,sorted.length-trim);
  var trimMean=trimmed.reduce(function(a,b){return a+b;},0)/trimmed.length;
  // IQRã¨ãƒˆãƒªãƒ å¹³å‡ã®ä¸¡æ–¹ã§å¤–ã‚Œå€¤ã¨åˆ¤å®šã•ã‚ŒãŸã‚‚ã®ã‚’é™¤å¤–
  var clean=arr.filter(function(v){
    var iqrOk=v>=lo&&v<=hi;
    var trimOk=v<=trimMean*3; // ãƒˆãƒªãƒ å¹³å‡ã®3å€è¶…ã¯å¤–ã‚Œå€¤
    return iqrOk&&trimOk;
  });
  if(clean.length===0)clean=arr; // å…¨éƒ¨é™¤å¤–ã•ã‚ŒãŸã‚‰å…ƒã«æˆ»ã™
  return{clean:clean,removed:arr.length-clean.length};
}

function updateAnalysis(){
  var all=getFiltered('filterFrom','filterTo','filterTag'),done=all.filter(function(h){return h.status==='done';});
  var totalRemoved=0;

  // å¤–ã‚Œå€¤é™¤å¤–
  var usedDone=done;
  if(outlierEnabled&&done.length>=4){
    var totalVals=done.map(function(h){return h.total||0;});
    var totalResult=removeOutliers(totalVals);
    var cleanTotals=new Set(totalResult.clean.map(function(_,i){return i;}));
    // totalåŸºæº–ã§ãƒ•ã‚£ãƒ«ã‚¿
    var cleanIdxs=[];
    totalVals.forEach(function(v,i){
      if(totalResult.clean.indexOf(v)>=0)cleanIdxs.push(i);
    });
    // é‡è¤‡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¯¾å¿œï¼šå¤–ã‚Œå€¤ã§ãªã„ã‚‚ã®ã ã‘æ®‹ã™
    var totalSet=[];
    var tmpClean=totalResult.clean.slice();
    usedDone=done.filter(function(h){
      var v=h.total||0;
      var idx=tmpClean.indexOf(v);
      if(idx>=0){tmpClean.splice(idx,1);return true;}
      return false;
    });
    totalRemoved+=totalResult.removed;

    // å„å·¥ç¨‹ã”ã¨ã«ã‚‚é™¤å¤–
    PROC.forEach(function(p){
      var vals=usedDone.map(function(h){return h.stepTimes&&h.stepTimes[p.id]?h.stepTimes[p.id]:null;}).filter(function(v){return v!==null;});
      if(vals.length>=4){
        var r=removeOutliers(vals);
        totalRemoved+=r.removed;
      }
    });
  }

  var infoEl=document.getElementById('outlierInfo');
  if(outlierEnabled&&totalRemoved>0){
    infoEl.style.display='block';
    infoEl.textContent='âš  å¤–ã‚Œå€¤ã¨ã—ã¦ '+totalRemoved+'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’é™¤å¤–ã—ã¦é›†è¨ˆã—ã¦ã„ã¾ã™ï¼ˆ'+done.length+'ä»¶ä¸­ '+usedDone.length+'ä»¶ã‚’ä½¿ç”¨ï¼‰';
  } else if(outlierEnabled){
    infoEl.style.display='block';
    infoEl.textContent='âœ“ å¤–ã‚Œå€¤ãªã—ï¼ˆå…¨'+done.length+'ä»¶ã‚’é›†è¨ˆï¼‰';
  } else {
    infoEl.style.display='none';
  }

  document.getElementById('statSessions').textContent=done.length+(outlierEnabled&&usedDone.length<done.length?' (æœ‰åŠ¹:'+usedDone.length+')':'');
  var gD=done.filter(function(h){return(h.giqiCount||0)>0;});
  document.getElementById('statGiqiRate').textContent=done.length?Math.round(gD.length/done.length*100)+'%':'-';

  if(!usedDone.length){
    document.getElementById('statTotal').textContent='-';document.getElementById('statBN').textContent='-';
    document.getElementById('chartContainer').innerHTML='<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    document.getElementById('giqiChart').innerHTML='<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }

  // å·¥ç¨‹ã”ã¨ã«å¤–ã‚Œå€¤é™¤å¤–ã—ã¦å¹³å‡ç®—å‡º
  var avgs={};
  PROC.forEach(function(p){
    var vals=usedDone.map(function(h){return h.stepTimes&&h.stepTimes[p.id]?h.stepTimes[p.id]:null;}).filter(function(v){return v!==null;});
    if(outlierEnabled&&vals.length>=4){
      vals=removeOutliers(vals).clean;
    }
    avgs[p.id]=vals.length?vals.reduce(function(a,b){return a+b;},0)/vals.length:0;
  });

  // åˆè¨ˆã®å¹³å‡ï¼ˆå¤–ã‚Œå€¤é™¤å¤–æ¸ˆã¿usedDoneãƒ™ãƒ¼ã‚¹ï¼‰
  var totalVals2=usedDone.map(function(h){return h.total||0;});
  if(outlierEnabled&&totalVals2.length>=4) totalVals2=removeOutliers(totalVals2).clean;
  var avgTotal=totalVals2.length?totalVals2.reduce(function(a,b){return a+b;},0)/totalVals2.length:0;

  document.getElementById('statTotal').textContent=fmt(avgTotal);
  var maxMs=Math.max.apply(null,Object.values(avgs).concat([1]));
  var bnEntry=Object.entries(avgs).sort(function(a,b){return b[1]-a[1];})[0];
  var bnId=bnEntry?bnEntry[0]:null;
  document.getElementById('statBN').textContent=bnId?(PROC.find(function(p){return p.id===bnId;})||{}).name||'-':'-';
  document.getElementById('chartContainer').innerHTML=PROC.filter(function(p){return avgs[p.id]>0;}).map(function(p){
    var pct=maxMs?avgs[p.id]/maxMs*100:0,isBN=p.id===bnId,cls=isBN?'bn':pct>60?'nrm':'fst';
    return '<div class="bar-row"><div class="bar-label">'+p.icon+' '+p.name+'</div><div class="bar-wrap"><div class="bar-fill '+cls+'" style="width:'+Math.max(pct,4)+'%">'+fmt(avgs[p.id])+'</div></div>'+(isBN?'<span class="bn-badge">BN</span>':'<span style="width:36px;flex-shrink:0"></span>')+'</div>';
  }).join('')||'<div class="empty-state" style="padding:24px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';

  var avgGT=gD.length?gD.reduce(function(a,h){return a+(h.giqiTotalMs||0);},0)/gD.length:0;
  document.getElementById('giqiChart').innerHTML='<div class="bar-row"><div class="bar-label">ç–‘ç¾©ç…§ä¼šç‡</div><div class="bar-wrap"><div class="bar-fill giq" style="width:'+Math.max(done.length?gD.length/done.length*100:0,2)+'%">'+(done.length?Math.round(gD.length/done.length*100):0)+'%</div></div><span style="width:36px;flex-shrink:0"></span></div><div class="bar-row"><div class="bar-label">å¹³å‡ç–‘ç¾©ç…§ä¼šæ™‚é–“</div><div class="bar-wrap"><div class="bar-fill giq" style="width:'+(avgGT>0?'50%':'2%')+'">'+fmt(avgGT)+'</div></div><span style="width:36px;flex-shrink:0"></span></div>';
}

// HIYARI
function openHiyariPickModal(tid){
  var t=allT[tid];if(!t)return;hiyTickId=tid;hiyStep=null;
  document.getElementById('hiyariPickSub').textContent='No.'+t.ticketNum+' â€” ã©ã®å·¥ç¨‹ã§ç™ºç”Ÿã—ã¾ã—ãŸã‹ï¼Ÿ';
  var picker=document.getElementById('hiyariStepPicker');picker.innerHTML='';
  PROC.forEach(function(p,i){
    var btn=document.createElement('button');btn.className='step-pick-btn';btn.textContent=p.icon+' '+p.name;
    btn.addEventListener('click',function(){picker.querySelectorAll('.step-pick-btn').forEach(function(b){b.classList.remove('sel');});btn.classList.add('sel');hiyStep=i;});
    picker.appendChild(btn);
  });
  document.getElementById('hiyariPickModal').classList.remove('hidden');
}
function flagHiyari(mode){
  if(hiyStep===null){showToast('âš  å·¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  var t=allT[hiyTickId],dt=new Date();
  var entry={id:'H'+Date.now(),ticketId:hiyTickId,ticketNum:t?t.ticketNum:'?',step:hiyStep,stepName:PROC[hiyStep].name,date:dt.toLocaleDateString('ja-JP'),time:dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),hour:dt.getHours(),dateISO:dt.toISOString().slice(0,10),ts:Date.now(),written:false,mistake:[],alert:[],notice:[],cause:[],note:''};
  closeHiyariPickModal();
  if(mode==='now'){
    if(t&&t.status==='active'){t.status='paused';t.pauseStart=Date.now();t.pauseCount++;pushT(t);renderAll();pausedHiy=true;}
    hiyEditId=entry.id;hiyC.push(entry);openHiyariWriteModal(entry);
  }else{hiyC.push(entry);pushHiy();showToast('âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¾ã—ãŸ');}
}
function closeHiyariPickModal(){document.getElementById('hiyariPickModal').classList.add('hidden');hiyTickId=null;hiyStep=null;}
function openHiyariWriteModal(entry){
  document.getElementById('hiyariWriteSub').textContent=(entry.ticketNum?'No.'+entry.ticketNum+' â€” ':'')+entry.stepName+' ã§ç™ºç”Ÿ';
  document.getElementById('hiyariNote').value=entry.note||'';
  Object.entries(HM).forEach(function(kv){
    var key=kv[0],items=kv[1];
    var wrap=document.getElementById('chips-'+key);wrap.innerHTML='';
    items.forEach(function(item){
      var chip=document.createElement('button');chip.className='hiyari-chip';chip.textContent=item;
      if((entry[key]||[]).indexOf(item)>=0)chip.classList.add('sel');
      chip.addEventListener('click',function(){chip.classList.toggle('sel');});
      wrap.appendChild(chip);
    });
  });
  document.getElementById('hiyariWriteModal').classList.remove('hidden');
}
function openHiyariWriteById(id){var entry=hiyC.find(function(h){return h.id===id;});if(!entry)return;hiyEditId=id;openHiyariWriteModal(entry);}
function saveHiyariWrite(){
  var idx=hiyC.findIndex(function(h){return h.id===hiyEditId;});if(idx===-1)return;
  var entry=hiyC[idx];
  Object.keys(HM).forEach(function(key){entry[key]=Array.from(document.querySelectorAll('#chips-'+key+' .hiyari-chip.sel')).map(function(c){return c.textContent;});});
  entry.note=document.getElementById('hiyariNote').value;entry.written=true;
  if(pausedHiy&&entry.ticketId&&allT[entry.ticketId]&&allT[entry.ticketId].status==='paused'){var t=allT[entry.ticketId],now=Date.now();t.pauseAccum+=(now-t.pauseStart);t.pauseStart=null;t.status='active';pushT(t);renderAll();}
  var noteVal=entry.note;
  var savedId=entry.id;
  pausedHiy=false;hiyEditId=null;pushHiy();closeHiyariWriteModal();showToast('âœ“ ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');

}
function closeHiyariWriteModal(){
  document.getElementById('hiyariWriteModal').classList.add('hidden');
  if(pausedHiy){
    var entry=hiyC.find(function(h){return h.id===hiyEditId;});
    if(entry&&entry.ticketId&&allT[entry.ticketId]&&allT[entry.ticketId].status==='paused'){var t=allT[entry.ticketId],now=Date.now();t.pauseAccum+=(now-t.pauseStart);t.pauseStart=null;t.status='active';pushT(t);renderAll();}
    pausedHiy=false;pushHiy();
  }
  hiyEditId=null;
}
// ---- ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----
function getWeekKey(d){
  var day=d.getDay();
  var mon=new Date(d);mon.setDate(d.getDate()-(day===0?6:day-1));
  return mon.toISOString().slice(0,10);
}
function getMonthKey(d){return d.toISOString().slice(0,7);}

// ãƒ¡ãƒ¢ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
// æœˆã®ç¬¬Né€±ï¼ˆ1ã€œ4ï¼‰ã®é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’è¿”ã™ï¼ˆ1æ—¥å§‹ã¾ã‚Šã€5é€±ç›®ã¯4é€±ç›®ã«çµ±åˆï¼‰
function getMonthWeekRange(year, month, weekNum){
  // ç¬¬Né€±ã®é–‹å§‹æ—¥ = 1 + (weekNum-1)*7
  var startDay = 1 + (weekNum - 1) * 7;
  var lastDay = new Date(year, month + 1, 0).getDate();
  // 5é€±ç›®ä»¥é™ã¯4é€±ç›®ã«çµ±åˆã™ã‚‹ã®ã§ç¬¬4é€±ã®çµ‚ã‚ã‚Šã¯æœˆæœ«
  var endDay = weekNum === 4 ? lastDay : Math.min(startDay + 6, lastDay);
  return {
    start: new Date(year, month, startDay),
    end: new Date(year, month, endDay),
    startDay: startDay,
    endDay: endDay
  };
}

function renderWeekMemoGrid(){
  var now=new Date();
  var year=now.getFullYear(),month=now.getMonth();
  var grid=document.getElementById('weekMemoGrid');
  if(!grid)return;
  grid.innerHTML='';
  for(var w=1;w<=4;w++){
    (function(wn){
      var range=getMonthWeekRange(year,month,wn);
      var m=month+1;
      var label='ç¬¬'+wn+'é€±ï¼ˆ'+m+'/'+range.startDay+'ã€œ'+m+'/'+range.endDay+'ï¼‰';
      if(wn===4){label='ç¬¬4é€±ï¼ˆ'+m+'/'+range.startDay+'ã€œæœˆæœ«ï¼‰';}
      var key='monthweek_'+year+'_'+month+'_'+wn;
      var div=document.createElement('div');
      div.className='chart-container';
      div.style.margin='0';
      div.innerHTML=
        '<div style="font-size:11px;font-weight:900;color:var(--accent);margin-bottom:6px;">ğŸ“ '+label+'</div>'
        +'<textarea class="hiyari-textarea" id="wmemo-'+wn+'" style="min-height:90px;" placeholder="ã“ã®é€±ã®å¯¾ç­–ãƒ»æŒ¯ã‚Šè¿”ã‚Šã‚’è¨˜å…¥ï¼ˆä¿å­˜å¿…é ˆï¼‰..."></textarea>'
        +'<div style="display:flex;gap:6px;margin-top:6px;">'
        +'<button onclick="saveMonthWeekMemo('+wn+')" style="flex:1;padding:8px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:sans-serif;">ä¿å­˜</button>'
        +'<div id="wstamp-'+wn+'" style="display:none;flex:1;padding:8px;background:var(--success-soft);border:1px solid var(--success);border-radius:7px;font-size:11px;font-weight:700;color:var(--success);text-align:center;"></div>'
        +'</div>';
      grid.appendChild(div);
      fRef('memos/'+key).once('value',function(snap){
        var data=snap.val();
        if(data){
          var el=document.getElementById('wmemo-'+wn);
          if(el)el.value=data.text||data;
          var stamp=document.getElementById('wstamp-'+wn);
          if(stamp&&data.savedBy){
            stamp.style.display='block';
            stamp.textContent='âœ“ '+data.savedBy+' '+data.savedAt;
          }
        }
      });
    })(w);
  }
}

function saveMonthWeekMemo(wn){
  var el=document.getElementById('wmemo-'+wn);
  if(!el||!el.value.trim()){showToast('âš  å¯¾ç­–å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var now=new Date();
  var key='monthweek_'+now.getFullYear()+'_'+now.getMonth()+'_'+wn;
  var savedAt=now.toLocaleDateString('ja-JP',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  fRef('memos/'+key).set({text:el.value,savedBy:SC,savedAt:savedAt});
  var stamp=document.getElementById('wstamp-'+wn);
  if(stamp){stamp.style.display='block';stamp.textContent='âœ“ '+SC+' '+savedAt;}
  showToast('ç¬¬'+wn+'é€±ã®å¯¾ç­–ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

// æ—§é–¢æ•°ï¼ˆäº’æ›ï¼‰
function saveWeekMemo(){showToast('é€±é–“ãƒ¡ãƒ¢ã¯ç¬¬Né€±ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„');}
function saveMonthMemo(){showToast('æœˆé–“ãƒ¡ãƒ¢ã¯ç¬¬Né€±ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„');}

function loadMemos(){
  // é€±4æ ã¯renderWeekMemoGridå†…ã§èª­ã¿è¾¼ã‚€
}

// ãƒãƒ¼HTMLç”Ÿæˆï¼ˆå¤šã„ã»ã©å¼·èª¿è‰²ï¼‰
function makeBar(label,pend,total,isBiggest){
  if(total===0)return '';
  var rate=Math.round(pend/total*100);
  var hot=pend>0;
  var cls=isBiggest?'bn':hot?'hiy':'fst';
  var badge=isBiggest?'<span class="bn-badge">æœ€å¤š</span>':'<span style="width:50px;flex-shrink:0;text-align:right;font-size:10px;font-weight:700;color:'+(hot?'var(--hiyari)':'var(--success)')+'">'+rate+'%</span>';
  return '<div class="bar-row">'
    +'<div class="bar-label" style="font-size:11px;font-family:\'JetBrains Mono\',monospace;">'+label+'</div>'
    +'<div class="bar-wrap"><div class="bar-fill '+cls+'" style="width:'+Math.max(rate,pend>0?4:0)+'%">'+pend+'/'+total+'</div></div>'
    +badge+'</div>';
}

// ã‚¿ãƒ–å¼·èª¿
function refreshHiyariTabBadge(){
  var tp=hiyC.filter(function(h){return!h.written;}).length;
  var btn=document.getElementById('hiyariTab');
  if(!btn)return;
  if(tp>0){
    btn.textContent='âš  ãƒ’ãƒ¤ãƒª '+tp+'ä»¶';
    btn.style.background=btn.classList.contains('active')?'var(--hiyari)':'var(--hiyari-soft)';
    btn.style.color=btn.classList.contains('active')?'#fff':'var(--hiyari)';
    btn.style.animation='pulse 1.5s ease-in-out infinite';
  }else{
    btn.textContent='âš  ãƒ’ãƒ¤ãƒª';
    btn.style.background='';btn.style.color='';btn.style.animation='';
  }
}

function updateHiyariTab(){
  refreshHiyariTabBadge();
  // é€±4æ ãƒ¡ãƒ¢æç”»
  renderWeekMemoGrid();
  // æœªè¨˜è¼‰ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæœ¬æ—¥åˆ†ã®ã¿ï¼‰
  var todayPending=hiyC.filter(function(h){return h.dateISO===todayStr&&!h.written;});
  var alertEl=document.getElementById('hiyariPendingAlert');
  var cardsEl=document.getElementById('hiyariPendingCards');
  if(alertEl&&cardsEl){
    if(todayPending.length>0){
      alertEl.style.display='block';
      cardsEl.innerHTML=todayPending.map(function(h){
        return '<div style="background:rgba(255,255,255,0.2);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:700;" id="palert-'+h.id+'">'
          +'No.'+h.ticketNum+' '+h.stepName+'<br><span style="font-size:10px;opacity:0.8;">'+h.time+'</span></div>';
      }).join('');
      todayPending.forEach(function(h){
        var el=document.getElementById('palert-'+h.id);
        if(el)(function(hid){el.addEventListener('click',function(){openHiyariWriteById(hid);});})(h.id);
      });
    }else{
      alertEl.style.display='none';
    }
  }

  var from=document.getElementById('hiyariFilterFrom').value;
  var to=document.getElementById('hiyariFilterTo').value;
  var st=document.getElementById('hiyariFilterStatus').value;
  var filtered=hiyC.filter(function(h){
    if(from&&h.dateISO<from)return false;
    if(to&&h.dateISO>to)return false;
    if(st==='pending'&&h.written)return false;
    if(st==='done'&&!h.written)return false;
    return true;
  });

  // å…¨æœŸé–“ã‚µãƒãƒªãƒ¼
  var allPend=hiyC.filter(function(h){return!h.written;}).length;
  document.getElementById('hStatTotal').textContent=hiyC.length;
  document.getElementById('hStatPending').textContent=allPend;
  document.getElementById('hStatPendingRate').textContent=hiyC.length?Math.round(allPend/hiyC.length*100)+'%':'-';

  // â”€â”€ æ—¥åˆ¥ï¼ˆç›´è¿‘14æ—¥ï¼‰â”€â”€
  var days=[];
  for(var di=13;di>=0;di--){var dd=new Date();dd.setDate(dd.getDate()-di);days.push(dd.toISOString().slice(0,10));}
  var dayBars=days.map(function(iso){
    var items=hiyC.filter(function(h){return h.dateISO===iso;});
    if(!items.length)return '';
    return makeBar(iso.slice(5).replace('-','/'), items.filter(function(h){return!h.written;}).length, items.length, false);
  }).filter(Boolean).join('');
  // æœ€å¤šã®æ—¥ã‚’å¼·èª¿
  var dayTotals=days.map(function(iso){return hiyC.filter(function(h){return h.dateISO===iso;}).length;});
  var mxDay=Math.max.apply(null,dayTotals.concat([0]));
  if(mxDay>0){
    var dayBarsArr=days.map(function(iso){
      var items=hiyC.filter(function(h){return h.dateISO===iso;});
      if(!items.length)return '';
      return makeBar(iso.slice(5).replace('-','/'), items.filter(function(h){return!h.written;}).length, items.length, items.length===mxDay);
    }).filter(Boolean);
    dayBars=dayBarsArr.join('');
  }
  document.getElementById('hiyariDailyChart').innerHTML=dayBars||'<div class="empty-state" style="padding:16px"><div class="icon">ğŸ“…</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';

  // â”€â”€ é€±åˆ¥ï¼ˆç›´è¿‘6é€±ï¼‰â”€â”€
  var weekRows=[];
  for(var wi=5;wi>=0;wi--){
    var wd=new Date();wd.setDate(wd.getDate()-wi*7);
    var wk=getWeekKey(wd);
    var wkEnd=new Date(wk);wkEnd.setDate(wkEnd.getDate()+6);
    var wkEndIso=wkEnd.toISOString().slice(0,10);
    var wItems=hiyC.filter(function(h){return h.dateISO>=wk&&h.dateISO<=wkEndIso;});
    if(wItems.length)weekRows.push({label:wk.slice(5).replace('-','/')+'ã€œ'+wkEndIso.slice(5).replace('-','/'),total:wItems.length,pend:wItems.filter(function(h){return!h.written;}).length});
  }
  var mxW=Math.max.apply(null,weekRows.map(function(w){return w.total;}).concat([0]));
  document.getElementById('hiyariWeekChart').innerHTML=weekRows.length
    ?weekRows.map(function(w){return makeBar(w.label,w.pend,w.total,w.total===mxW);}).join('')
    :'<div class="empty-state" style="padding:16px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';

  // â”€â”€ æœˆåˆ¥ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰â”€â”€
  var monthRows=[];
  for(var mi=5;mi>=0;mi--){
    var md=new Date();md.setMonth(md.getMonth()-mi);
    var mk=getMonthKey(md);
    var mItems=hiyC.filter(function(h){return h.dateISO&&h.dateISO.slice(0,7)===mk;});
    if(mItems.length)monthRows.push({label:mk,total:mItems.length,pend:mItems.filter(function(h){return!h.written;}).length});
  }
  var mxM=Math.max.apply(null,monthRows.map(function(m){return m.total;}).concat([0]));
  document.getElementById('hiyariMonthChart').innerHTML=monthRows.length
    ?monthRows.map(function(m){return makeBar(m.label,m.pend,m.total,m.total===mxM);}).join('')
    :'<div class="empty-state" style="padding:16px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';

  // â”€â”€ å·¥ç¨‹åˆ¥ï¼ˆå¤šã„é †ã«å¼·èª¿ï¼‰â”€â”€
  var sc={};PROC.forEach(function(p){sc[p.id]=0;});
  filtered.forEach(function(h){var p=PROC[h.step];if(p)sc[p.id]++;});
  var mxSc=Math.max.apply(null,Object.values(sc).concat([0]));
  var sortedProc=PROC.slice().sort(function(a,b){return sc[b.id]-sc[a.id];});
  document.getElementById('hiyariStepChart').innerHTML=sortedProc.filter(function(p){return sc[p.id]>0;}).map(function(p){
    var isBig=sc[p.id]===mxSc&&mxSc>0;
    return '<div class="bar-row"><div class="bar-label">'+p.icon+' '+p.name+'</div>'
      +'<div class="bar-wrap"><div class="bar-fill '+(isBig?'bn':'hiy')+'" style="width:'+Math.max(sc[p.id]/mxSc*100,4)+'%">'+sc[p.id]+'ä»¶</div></div>'
      +(isBig?'<span class="bn-badge">æœ€å¤š</span>':'<span style="width:50px;flex-shrink:0"></span>')+'</div>';
  }).join('')||'<div class="empty-state" style="padding:20px"><div class="icon">âš </div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';

  // â”€â”€ æ™‚é–“å¸¯åˆ¥ â”€â”€
  var hc={};for(var hi=0;hi<24;hi++)hc[hi]=0;
  filtered.forEach(function(h){if(h.hour!==undefined)hc[h.hour]++;});
  var mxH=Math.max.apply(null,Object.values(hc).concat([0]));
  var hd=Object.entries(hc).filter(function(e){return e[1]>0;});
  document.getElementById('hiyariTimeChart').innerHTML=hd.length?hd.map(function(e){
    var isBig=parseInt(e[1])===mxH&&mxH>0;
    return '<div class="bar-row"><div class="bar-label" style="font-family:\'JetBrains Mono\',monospace">'+String(e[0]).padStart(2,'0')+':00ã€œ</div>'
      +'<div class="bar-wrap"><div class="bar-fill '+(isBig?'bn':'hiy')+'" style="width:'+Math.max(e[1]/mxH*100,4)+'%">'+e[1]+'ä»¶</div></div>'
      +(isBig?'<span class="bn-badge">æœ€å¤š</span>':'<span style="width:50px;flex-shrink:0"></span>')+'</div>';
  }).join(''):'<div class="empty-state" style="padding:20px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';

  // â”€â”€ åŸå› åˆ†æ â”€â”€
  var cc={};
  filtered.filter(function(h){return h.written;}).forEach(function(h){
    (h.cause||[]).forEach(function(c){cc[c]=(cc[c]||0)+1;});
    (h.mistake||[]).forEach(function(c){cc['é–“é•ã„ï¼š'+c]=(cc['é–“é•ã„ï¼š'+c]||0)+1;});
  });
  var ce=Object.entries(cc).sort(function(a,b){return b[1]-a[1];}).slice(0,10);
  var mxC=Math.max.apply(null,ce.map(function(e){return e[1];}).concat([0]));
  document.getElementById('hiyariCauseChart').innerHTML=ce.length?ce.map(function(e,i){
    var isBig=i===0&&mxC>0;
    return '<div class="bar-row"><div class="bar-label" style="font-size:10px">'+e[0]+'</div>'
      +'<div class="bar-wrap"><div class="bar-fill '+(isBig?'bn':'hiy')+'" style="width:'+Math.max(e[1]/mxC*100,4)+'%">'+e[1]+'ä»¶</div></div>'
      +(isBig?'<span class="bn-badge">æœ€å¤š</span>':'<span style="width:50px;flex-shrink:0"></span>')+'</div>';
  }).join(''):'<div class="empty-state" style="padding:20px"><p>è¨˜è¼‰æ¸ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';

  // â”€â”€ æœ¬æ—¥åˆ†ï¼ˆæœªè¨˜è¼‰â†’è¨˜è¼‰æ¸ˆã®é †ã€æœ€ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰ â”€â”€
  var todayItems=hiyC.filter(function(h){return h.dateISO===todayStr;});
  todayItems.sort(function(a,b){
    if(!a.written&&b.written)return -1;
    if(a.written&&!b.written)return 1;
    return (a.ts||0)-(b.ts||0);
  });
  var todayTbody=document.getElementById('hiyariTodayBody');
  if(todayTbody){
    if(!todayItems.length){
      todayTbody.innerHTML='<tr><td colspan="7"><div class="empty-state" style="padding:14px"><p>æœ¬æ—¥ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';
    }else{
      todayTbody.innerHTML='';
      todayItems.forEach(function(h){
        var stH=h.written?'<span class="tag tag-done">è¨˜è¼‰æ¸ˆ</span>':'<span class="pending-badge">æœªè¨˜è¼‰</span>';
        var tr=document.createElement('tr');
        if(!h.written)tr.style.cssText='background:var(--hiyari-soft);font-weight:700;';
        var btnId='hbtn-t-'+h.id;
        var btnHtml=h.written
          ?'<button class="btn-write" style="background:var(--muted)" id="'+btnId+'">ç·¨é›†</button>'
          :'<button class="btn-write" id="'+btnId+'" style="background:var(--hiyari);">è¨˜è¼‰ã™ã‚‹ï¼</button>';
        tr.innerHTML=
          '<td style="font-family:monospace">'+(h.time||'')+'</td>'
          +'<td style="font-family:monospace;font-weight:700">No.'+h.ticketNum+'</td>'
          +'<td>'+(h.stepName||'')+'</td>'
          +'<td>'+stH+'</td>'
          +'<td style="font-size:11px">'+((h.mistake||[]).slice(0,3).join('ãƒ»')||'-')+'</td>'
          +'<td style="font-size:11px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(h.note||'-')+'</td>'
          +'<td>'+btnHtml+'</td>';
        todayTbody.appendChild(tr);
        var btn=document.getElementById(btnId);
        if(btn)(function(hid){btn.addEventListener('click',function(){openHiyariWriteById(hid);});})(h.id);
      });
    }
  }

  // â”€â”€ éå»åˆ†ï¼ˆãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ãƒ»æœ¬æ—¥é™¤ããƒ»æ—¥æ™‚é™é †ï¼‰ â”€â”€
  var pastItems=filtered.filter(function(h){return h.dateISO!==todayStr;});
  pastItems.sort(function(a,b){return (b.ts||0)-(a.ts||0);});
  var tbody=document.getElementById('hiyariBody');
  if(!pastItems.length){
    tbody.innerHTML='<tr><td colspan="8"><div class="empty-state" style="padding:20px"><p>éå»ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';
  }else{
    tbody.innerHTML='';
    pastItems.forEach(function(h){
      var stH=h.written?'<span class="tag tag-done">è¨˜è¼‰æ¸ˆ</span>':'<span class="pending-badge">æœªè¨˜è¼‰</span>';
      var tr=document.createElement('tr');
      var btnId='hbtn-p-'+h.id;
      var btnHtml=h.written
        ?'<button class="btn-write" style="background:var(--muted)" id="'+btnId+'">ç·¨é›†</button>'
        :'<span style="font-size:10px;color:var(--muted);">å½“æ—¥ã®ã¿è¨˜è¼‰å¯</span>';
      tr.innerHTML=
        '<td style="font-family:monospace">'+(h.date||'')+'</td>'
        +'<td style="font-family:monospace">'+(h.time||'')+'</td>'
        +'<td style="font-family:monospace;font-weight:700">No.'+h.ticketNum+'</td>'
        +'<td>'+(h.stepName||'')+'</td>'
        +'<td>'+stH+'</td>'
        +'<td style="font-size:11px">'+((h.mistake||[]).slice(0,3).join('ãƒ»')||'-')+'</td>'
        +'<td style="font-size:11px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+(h.note||'-')+'</td>'
        +'<td>'+btnHtml+'</td>';
      tbody.appendChild(tr);
      var btn=document.getElementById(btnId);
      if(btn)(function(hid){btn.addEventListener('click',function(){openHiyariWriteById(hid);});})(h.id);
    });
  }
}

function clearHiyariFilter(){
  document.getElementById('hiyariFilterFrom').value='';
  document.getElementById('hiyariFilterTo').value='';
  document.getElementById('hiyariFilterStatus').value='';
  updateHiyariTab();
}

// ãƒ•ãƒªãƒ¼è¨˜è¼‰ã¯ãã®ã¾ã¾ä¿å­˜ï¼ˆå€‹åˆ¥å¯¾å¿œï¼‰
var lastSavedHiyariId=null;

// ---- ãƒ¬ãƒãƒ¼ãƒˆCSV selectåˆæœŸåŒ– ----
function initReportSelects(){
  var wSel=document.getElementById('reportWeekSel');
  var mSel=document.getElementById('reportMonthSel');
  if(!wSel||!mSel)return;
  // é€±ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆç›´è¿‘8é€±ï¼‰
  wSel.innerHTML='';
  for(var wi=0;wi<8;wi++){
    var wd=new Date();wd.setDate(wd.getDate()-wi*7);
    var wk=getWeekKey(wd);
    var wkEnd=new Date(wk);wkEnd.setDate(wkEnd.getDate()+6);
    var wkIso=wkEnd.toISOString().slice(0,10);
    var opt=document.createElement('option');
    opt.value=wk+'|'+wkIso;
    opt.textContent='é€±: '+wk.slice(5).replace('-','/')+'ã€œ'+wkIso.slice(5).replace('-','/');
    wSel.appendChild(opt);
  }
  // æœˆã‚»ãƒ¬ã‚¯ãƒˆï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰
  mSel.innerHTML='';
  for(var mi=0;mi<6;mi++){
    var md=new Date();md.setMonth(md.getMonth()-mi);
    var mk=getMonthKey(md);
    var opt2=document.createElement('option');
    opt2.value=mk;
    opt2.textContent='æœˆ: '+mk;
    mSel.appendChild(opt2);
  }
}

// ---- çµ±åˆCSVç”Ÿæˆ ----
function buildIntegratedCSV(from, to, label){
  var q=function(v){return '"'+String(v||'').replace(/"/g,'""')+'"';};
  var rows=[['===è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿===','','','','','','','','','','','','','','','']];
  var measHeader=['æ—¥ä»˜','æ™‚åˆ»','ç•ªå·','ã‚¿ã‚°','å—ä»˜(ç§’)','ï¾‹ï¾Ÿï½¯ï½·ï¾ï½¸ï¾(ç§’)','ç›£æŸ»(ç§’)','æŠ•è–¬(ç§’)','åˆè¨ˆ(ç§’)','BNå·¥ç¨‹','ç–‘ç¾©å›æ•°','ç–‘ç¾©æ™‚é–“(ç§’)','ãƒ’ãƒ¤ãƒª','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
  rows.push(measHeader);
  var measData=histC.filter(function(h){return h.dateISO>=from&&h.dateISO<=to;});
  measData.forEach(function(h){
    var bnId=null,bnMs=0;
    Object.entries(h.stepTimes||{}).forEach(function(e){if(e[1]>bnMs){bnMs=e[1];bnId=e[0];}});
    var bnP=PROC.find(function(p){return p.id===bnId;});
    rows.push([h.dateISO||'',h.time||'','No.'+(h.ticketNum||''),(h.tags||[]).join('ãƒ»'),
      ((h.stepTimes&&h.stepTimes.reception||0)/1000).toFixed(1),
      ((h.stepTimes&&h.stepTimes.picking||0)/1000).toFixed(1),
      ((h.stepTimes&&h.stepTimes.audit||0)/1000).toFixed(1),
      ((h.stepTimes&&h.stepTimes.dispensing||0)/1000).toFixed(1),
      ((h.total||0)/1000).toFixed(1),bnP?bnP.name:'-',
      h.giqiCount||0,((h.giqiTotalMs||0)/1000).toFixed(1),
      h.hiyari?'ã‚ã‚Š':'ãªã—',h.status==='done'?'å®Œäº†':'ã‚­ãƒ£ãƒ³ã‚»ãƒ«']);
  });
  rows.push(['','','','','','','','','','','','','','']);
  rows.push(['===ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿===','','','','','','','','','','','','','','','']);
  var hiyHeader=['æ—¥ä»˜','æ™‚åˆ»','ç•ªå·','ç™ºç”Ÿå·¥ç¨‹','è¨˜è¼‰çŠ¶æ³','ãƒŸã‚¹å†…å®¹','ã‚¢ãƒ©ãƒ¼ãƒˆ','æ°—ã¥ã','åŸå› ','AIã‚¿ã‚°','ãƒ•ãƒªãƒ¼è¨˜è¼‰'];
  rows.push(hiyHeader);
  var hiyData=hiyC.filter(function(h){return h.dateISO>=from&&h.dateISO<=to;});
  hiyData.forEach(function(h){
    rows.push([h.date||'',h.time||'','No.'+(h.ticketNum||''),h.stepName||'',
      h.written?'è¨˜è¼‰æ¸ˆ':'æœªè¨˜è¼‰',
      (h.mistake||[]).join('ãƒ»'),(h.alert||[]).join('ãƒ»'),
      (h.notice||[]).join('ãƒ»'),(h.cause||[]).join('ãƒ»'),
      (h.autoTags||[]).join('ãƒ»'),h.note||'']);
  });
  rows.push(['','','','','','','','','','','']);
  rows.push(['===ç¢ºèªæ¬„===','','','','','','','','','','','','','','','']);
  rows.push(['æœŸé–“','ç¢ºèªè€…','æŠ¼å°','ç¢ºèªæ—¥','å‚™è€ƒ']);
  rows.push([label,'','ï¼ˆã‚µã‚¤ãƒ³ï¼‰','','']);
  rows.push([label,'','ï¼ˆã‚µã‚¤ãƒ³ï¼‰','','']);
  rows.push([label,'','ï¼ˆã‚µã‚¤ãƒ³ï¼‰','','']);

  return 'ï»¿'+rows.map(function(r){return r.map(q).join(',');}).join('\r\n');
}

function exportWeeklyReport(){
  var sel=document.getElementById('reportWeekSel');
  if(!sel||!sel.value){showToast('é€±ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  var parts=sel.value.split('|');
  var from=parts[0],to=parts[1];
  var label='é€±å ±: '+from.slice(5).replace('-','/')+'ã€œ'+to.slice(5).replace('-','/');
  var csv=buildIntegratedCSV(from,to,label);
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download='é€±å ±_'+SC+'_'+from+'.csv';
  a.click();URL.revokeObjectURL(a.href);
  showToast('é€±å ±CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}

function exportMonthlyReport(){
  var sel=document.getElementById('reportMonthSel');
  if(!sel||!sel.value){showToast('æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  var mk=sel.value;
  var from=mk+'-01';
  var lastDay=new Date(parseInt(mk.slice(0,4)),parseInt(mk.slice(5,7)),0).getDate();
  var to=mk+'-'+String(lastDay).padStart(2,'0');
  var label='æœˆå ±: '+mk;
  var csv=buildIntegratedCSV(from,to,label);
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download='æœˆå ±_'+SC+'_'+mk+'.csv';
  a.click();URL.revokeObjectURL(a.href);
  showToast('æœˆå ±CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}

function exportHiyariCSV(){
  if(!hiyC.length){showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var headers=['æ—¥ä»˜','æ™‚åˆ»','ç•ªå·','ç™ºç”Ÿå·¥ç¨‹','è¨˜è¼‰çŠ¶æ³','ä½•ã‚’é–“é•ãˆãŸã‹','ã‚¢ãƒ©ãƒ¼ãƒˆ','æ°—ã¥ã„ãŸãã£ã‹ã‘','åŸå› ','ãƒ¡ãƒ¢'];
  var rows=hiyC.slice().sort(function(a,b){return(b.ts||0)-(a.ts||0);}).map(function(h){
    return [h.date||'',h.time||'','No.'+h.ticketNum,h.stepName||'',h.written?'è¨˜è¼‰æ¸ˆ':'æœªè¨˜è¼‰',
      (h.mistake||[]).join('ãƒ»'),(h.alert||[]).join('ãƒ»'),(h.notice||[]).join('ãƒ»'),
      (h.cause||[]).join('ãƒ»'),h.note||''];
  });
  var csv='\uFEFF'+[headers].concat(rows).map(function(r){
    return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(',');
  }).join('\r\n');
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download='ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ_'+SC+'_'+getToday()+'.csv';
  a.click();URL.revokeObjectURL(a.href);
  showToast('âœ“ ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆCSV '+rows.length+'ä»¶');
}

// UTILS
function fmt(ms){var s=Math.floor(ms/1000);return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2800);}
function toggleHistory(){switchTab('report');}

function switchTab(name){
  document.querySelectorAll('.tab').forEach(function(t,i){
    t.classList.toggle('active',['measure','today','hiyari','report'][i]===name);
  });
  document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active');});
  var el=document.getElementById('tab-'+name);
  if(el)el.classList.add('active');
  if(name==='today')updateTodayTab();
  if(name==='report'){updateAnalysis();updateHistory();initReportSelects();}
  if(name==='hiyari'){
    updateHiyariTab();
    var hbt=document.getElementById('hiyariTab');
    if(hbt&&hbt.style.animation)hbt.style.animation='none';
  }
}
function updateClock(){var n=new Date();document.getElementById('clockDisplay').textContent=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0');}

setupInputListeners();
var saved=localStorage.getItem('rx_store_code');
if(saved&&saved.length===5){
  // å‰å›ã®åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ãŒåˆè¨€è‘‰ã¯æ¯å›å¿…è¦
  document.getElementById('storeCodeInput').value=saved;
  document.getElementById('secretInput').focus();
}
</script>
</body>
</html>
