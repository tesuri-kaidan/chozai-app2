<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f4f3ef;--surface:#fff;--surface2:#eeecea;
  --accent:#1a5cff;--accent-soft:#e8eeff;
  --danger:#d90019;--danger-soft:#fff0f1;
  --success:#007a38;--success-soft:#e6f5ed;
  --pause:#b87000;--pause-soft:#fff7e0;
  --text:#1a1a1a;--muted:#8a8a84;--border:#dedad4;
  --shadow:0 2px 10px rgba(0,0,0,0.06);--shadow-lg:0 8px 32px rgba(0,0,0,0.13);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;}

/* SETUP */
#setupScreen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 32px;width:100%;max-width:400px;box-shadow:var(--shadow-lg);text-align:center;}
.setup-card .logo{font-size:42px;margin-bottom:12px;}
.setup-card h2{font-size:20px;font-weight:900;margin-bottom:6px;}
.setup-card p{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.7;}
.setup-code-input{width:100%;text-align:center;font-family:'JetBrains Mono',monospace;font-size:34px;font-weight:700;letter-spacing:10px;background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:14px 10px;outline:none;color:var(--text);transition:border-color 0.15s;margin-bottom:8px;}
.setup-code-input:focus{border-color:var(--accent);}
.setup-hint{font-size:12px;color:var(--muted);margin-bottom:20px;font-family:'JetBrains Mono',monospace;}
.setup-hint.ok{color:var(--success);font-weight:700;}
.setup-hint.err{color:var(--danger);font-weight:700;}
.btn-setup{width:100%;padding:15px;background:var(--accent);color:#fff;border:none;border-radius:11px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;box-shadow:0 3px 10px rgba(26,92,255,0.3);}
.btn-setup:hover{filter:brightness(1.1);}

/* MAIN */
#mainApp{display:none;}
.container{max-width:1040px;margin:0 auto;padding:16px 14px;}
header{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;background:var(--surface);border-radius:14px;margin-bottom:13px;box-shadow:var(--shadow);border:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.header-left{display:flex;align-items:center;gap:10px;}
.store-badge{background:var(--accent-soft);border:1.5px solid var(--accent);border-radius:8px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;user-select:none;}
.store-badge:hover{background:#d4e0ff;}
.header-title{font-size:16px;font-weight:900;}
.header-right{display:flex;align-items:center;gap:12px;}
.sync-wrap{display:flex;align-items:center;gap:5px;}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:background 0.3s;flex-shrink:0;}
.sync-dot.synced{background:var(--success);}
.sync-dot.syncing{background:var(--pause);animation:pulse 0.8s ease-in-out infinite;}
.sync-dot.error{background:var(--danger);}
.sync-label{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);}
.clock{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;}

.tabs{display:flex;gap:4px;margin-bottom:13px;background:var(--surface);padding:4px;border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);}
.tab{flex:1;padding:9px 4px;text-align:center;border-radius:7px;cursor:pointer;font-size:13px;font-weight:700;color:var(--muted);transition:all 0.18s;border:none;background:none;font-family:'Noto Sans JP',sans-serif;}
.tab.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(26,92,255,0.28);}
.tab-content{display:none;}
.tab-content.active{display:block;}

/* Input bar */
.new-ticket-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 15px;margin-bottom:13px;box-shadow:var(--shadow);}
.new-ticket-bar label{font-size:13px;color:var(--muted);white-space:nowrap;font-weight:500;}
.num-spinner{display:flex;align-items:center;border:2px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface2);}
.num-spinner:focus-within{border-color:var(--accent);}
.spinner-btn{width:50px;height:54px;border:none;background:var(--surface2);color:var(--text);font-size:24px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.1s;user-select:none;-webkit-user-select:none;touch-action:manipulation;flex-shrink:0;}
.spinner-btn:hover{background:var(--border);}
.spinner-btn:active{background:var(--accent);color:#fff;}
.sdiv{width:1px;height:30px;background:var(--border);flex-shrink:0;}
.ticket-input{width:76px;background:transparent;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;padding:0 4px;text-align:center;outline:none;-moz-appearance:textfield;}
.ticket-input::-webkit-inner-spin-button,.ticket-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
.btn-add{padding:0 22px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;white-space:nowrap;box-shadow:0 2px 8px rgba(26,92,255,0.28);touch-action:manipulation;height:54px;}
.btn-add:hover{filter:brightness(1.1);}
.btn-add:active{transform:scale(0.97);}
.ticket-count-badge{margin-left:auto;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;}

/* Tags row in input bar */
.tags-row{width:100%;display:flex;flex-wrap:wrap;gap:6px;padding-top:4px;border-top:1px solid var(--border);margin-top:4px;}
.tags-row label{font-size:12px;color:var(--muted);font-weight:500;align-self:center;white-space:nowrap;}
.tag-chip{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:99px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;user-select:none;touch-action:manipulation;}
.tag-chip:hover{border-color:var(--accent);color:var(--accent);}
.tag-chip.selected{border-color:var(--accent);background:var(--accent-soft);color:var(--accent);}
.tag-chip.tag-fast.selected{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-chip.tag-slow.selected{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}

/* Tickets grid */
.tickets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(285px,1fr));gap:11px;max-height:68vh;overflow-y:auto;padding-bottom:4px;}
.tickets-grid::-webkit-scrollbar{width:4px;}
.tickets-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Ticket card */
.ticket-card{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:15px;transition:border-color 0.2s,box-shadow 0.2s;box-shadow:var(--shadow);}
.ticket-card.status-active{border-color:var(--accent);box-shadow:0 4px 18px rgba(26,92,255,0.13);}
.ticket-card.status-paused{border-color:var(--pause);box-shadow:0 4px 14px rgba(184,112,0,0.11);}
.ticket-card.status-cancelled{border-color:var(--border);opacity:0.5;box-shadow:none;}
.ticket-card.status-done{border-color:var(--success);box-shadow:0 4px 14px rgba(0,122,56,0.11);}
.ticket-card.remote-card{border-style:dashed;}

.ticket-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.ticket-num{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;}
.status-active .ticket-num{color:var(--accent);}
.status-paused .ticket-num{color:var(--pause);}
.status-done .ticket-num{color:var(--success);}
.status-cancelled .ticket-num{color:var(--muted);}
.ticket-badge{font-size:10px;font-family:'JetBrains Mono',monospace;padding:3px 9px;border-radius:99px;font-weight:700;}
.badge-active{background:var(--accent-soft);color:var(--accent);}
.badge-paused{background:var(--pause-soft);color:var(--pause);}
.badge-cancelled{background:var(--danger-soft);color:var(--danger);}
.badge-done{background:var(--success-soft);color:var(--success);}

/* Tags on card */
.card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;min-height:0;}
.card-tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;border:1px solid;}
.card-tag.slow{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.card-tag.fast{background:var(--success-soft);color:var(--success);border-color:rgba(0,122,56,0.3);}
.card-tag.normal{background:var(--surface2);color:var(--muted);border-color:var(--border);}
.btn-tag-edit{font-size:10px;padding:2px 7px;border-radius:99px;border:1px dashed var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.btn-tag-edit:hover{border-color:var(--accent);color:var(--accent);}

.steps{display:flex;gap:3px;margin-bottom:9px;}
.step{flex:1;text-align:center;padding:5px 2px;border-radius:5px;font-size:9px;font-weight:700;transition:all 0.2s;}
.step.pending{background:var(--surface2);color:var(--muted);}
.step.current{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.28);}
.step.current.paused{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.step.done-step{background:var(--success-soft);color:var(--success);}
.step-time{font-family:'JetBrains Mono',monospace;font-size:8px;margin-top:2px;}

.current-process{display:flex;align-items:center;gap:9px;background:var(--surface2);border-radius:9px;padding:10px 12px;margin-bottom:8px;}
.proc-icon{font-size:17px;}
.proc-name{font-size:12px;font-weight:700;flex:1;}
.proc-timer{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--accent);}
.status-paused .proc-timer{color:var(--pause);}
.total-time{font-size:11px;color:var(--muted);margin-bottom:7px;font-family:'JetBrains Mono',monospace;}
.total-time span{color:var(--text);font-weight:700;}
.pause-info{font-size:10px;color:var(--pause);font-family:'JetBrains Mono',monospace;margin-bottom:2px;}

.ticket-buttons{display:flex;gap:5px;margin-top:8px;}
.tbtn{flex:1;padding:10px 4px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:700;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;touch-action:manipulation;}
.tbtn:disabled{opacity:0.3;cursor:not-allowed;}
.tbtn-complete{background:var(--accent);color:#fff;box-shadow:0 2px 6px rgba(26,92,255,0.22);}
.tbtn-complete:hover{filter:brightness(1.1);}
.tbtn-pause{background:var(--pause-soft);color:var(--pause);border:1px solid rgba(184,112,0,0.22);flex:0;padding:10px 13px;}
.tbtn-resume{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.22);}
.tbtn-cancel{background:var(--danger-soft);color:var(--danger);border:1px solid rgba(217,0,25,0.18);flex:0;padding:10px 13px;}

.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:38px;margin-bottom:10px;}
.empty-state p{font-size:14px;}

/* Analysis */
.filter-bar{display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;box-shadow:var(--shadow);flex-wrap:wrap;}
.filter-bar label{font-size:12px;color:var(--muted);font-weight:500;}
.filter-input{background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 9px;outline:none;}
.filter-input:focus{border-color:var(--accent);}
.btn-filter{padding:7px 13px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-filter.sec{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:12px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:13px;text-align:center;box-shadow:var(--shadow);}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:19px;font-weight:700;color:var(--accent);}
.stat-label{font-size:10px;color:var(--muted);margin-top:3px;font-weight:500;}
.section-title{font-size:10px;font-family:'JetBrains Mono',monospace;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;}
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:12px;box-shadow:var(--shadow);}
.bar-row{display:flex;align-items:center;gap:9px;margin-bottom:8px;}
.bar-label{width:130px;font-size:11px;color:var(--text);flex-shrink:0;text-align:right;font-weight:500;}
.bar-wrap{flex:1;height:26px;background:var(--surface2);border-radius:5px;overflow:hidden;}
.bar-fill{height:100%;border-radius:5px;transition:width 0.8s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;color:#fff;min-width:52px;}
.bar-fill.bottleneck{background:linear-gradient(90deg,var(--danger),#ff4520);}
.bar-fill.normal{background:linear-gradient(90deg,var(--accent),#3d77ff);}
.bar-fill.fast{background:linear-gradient(90deg,var(--success),#00a84e);}
.bn-badge{background:var(--danger-soft);border:1px solid var(--danger);color:var(--danger);font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 7px;border-radius:4px;flex-shrink:0;font-weight:700;}

/* History */
.history-controls{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap;}
.btn-csv{padding:9px 16px;background:var(--success);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;box-shadow:0 2px 8px rgba(0,122,56,0.22);transition:all 0.15s;}
.btn-csv:hover{filter:brightness(1.1);}
.btn-clear{padding:9px 13px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-clear:hover{color:var(--danger);border-color:var(--danger);}
.history-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);overflow-x:auto;}
.history-table{width:100%;border-collapse:collapse;font-size:12px;min-width:750px;}
.history-table th{text-align:left;padding:9px 11px;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap;}
.history-table td{padding:9px 11px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;}
.history-table tr:last-child td{border-bottom:none;}
.history-table tr:hover td{background:var(--surface2);}
.bn-text{color:var(--danger);font-weight:700;}
.tag{display:inline-block;font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;}
.tag-done{background:var(--success-soft);color:var(--success);}
.tag-cancelled{background:var(--danger-soft);color:var(--danger);}
.tag-pause-info{background:var(--pause-soft);color:var(--pause);}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.42);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.modal-overlay.hidden{display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;width:380px;max-width:93vw;box-shadow:var(--shadow-lg);}
.modal h3{font-size:16px;font-weight:900;margin-bottom:4px;}
.modal .modal-sub{font-size:12px;color:var(--muted);margin-bottom:14px;}
.step-select-list{display:flex;flex-direction:column;gap:6px;margin-bottom:13px;}
.step-select-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:9px;background:var(--surface2);border:1.5px solid var(--border);color:var(--text);cursor:pointer;font-size:13px;font-weight:600;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;text-align:left;touch-action:manipulation;}
.step-select-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-soft);}
.step-sel-icon{font-size:17px;}
.step-sel-time{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--success);font-weight:700;}
.modal-cancel-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-top:6px;}
.modal-cancel-btn:hover{color:var(--text);}

/* Tag modal chips */
.tag-modal-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.tag-modal-chip{padding:9px 16px;border-radius:99px;border:2px solid var(--border);background:var(--surface2);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.tag-modal-chip:hover{border-color:var(--accent);}
.tag-modal-chip.sel-slow{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}
.tag-modal-chip.sel-fast{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-modal-chip.sel-normal{border-color:var(--muted);background:var(--surface2);color:var(--muted);}
.btn-tag-save{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:9px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;box-shadow:0 2px 8px rgba(26,92,255,0.25);}
.btn-tag-save:hover{filter:brightness(1.1);}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--text);color:#fff;padding:10px 22px;border-radius:99px;font-size:13px;font-weight:700;transition:transform 0.3s;z-index:300;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.blinking{animation:pulse 1s ease-in-out infinite;}

@media(max-width:600px){
  .container{padding:10px;}
  header{padding:10px 12px;border-radius:11px;margin-bottom:10px;}
  .header-title{font-size:14px;}
  .clock{font-size:11px;}
  .sync-label{display:none;}
  .tab{font-size:12px;padding:9px 3px;}
  .new-ticket-bar{padding:11px 12px;gap:8px;}
  .spinner-btn{width:54px;height:58px;font-size:27px;}
  .ticket-input{font-size:27px;width:70px;}
  .btn-add{font-size:14px;height:58px;padding:0 16px;}
  .ticket-count-badge{width:100%;text-align:right;margin-left:0;}
  .tickets-grid{grid-template-columns:1fr;max-height:none;}
  .proc-timer{font-size:20px;}
  .tbtn{font-size:13px;padding:12px 4px;min-height:46px;}
  .tbtn-pause,.tbtn-cancel{padding:12px 13px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .stat-value{font-size:17px;}
  .filter-input{font-size:12px;max-width:130px;}
  .bar-label{width:100px;font-size:10px;}
  .modal{padding:16px;}
  .step-select-btn{min-height:52px;}
}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setupScreen">
  <div class="setup-card">
    <div class="logo">ğŸ¥</div>
    <h2>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</h2>
    <p>ã“ã®ç«¯æœ«ãŒä½¿ç”¨ã™ã‚‹<strong>åº—èˆ—ã‚³ãƒ¼ãƒ‰ï¼ˆ5æ¡ï¼‰</strong>ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>åŒã˜ã‚³ãƒ¼ãƒ‰ã®ç«¯æœ«é–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åŒæœŸã•ã‚Œã¾ã™ã€‚</p>
    <input type="text" class="setup-code-input" id="storeCodeInput"
      placeholder="00000" maxlength="5" inputmode="numeric">
    <div class="setup-hint" id="setupHint">ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002</div>
    <button class="btn-setup" onclick="confirmStore()">ã“ã®åº—èˆ—ã‚³ãƒ¼ãƒ‰ã§å§‹ã‚ã‚‹</button>
  </div>
</div>

<!-- MAIN -->
<div id="mainApp">
<div class="container">
  <header>
    <div class="header-left">
      <div class="store-badge" onclick="changeStore()">ğŸª <span id="storeLabel">-----</span></div>
      <div class="header-title">èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</div>
    </div>
    <div class="header-right">
      <div class="sync-wrap">
        <div class="sync-dot" id="syncDot"></div>
        <span class="sync-label" id="syncLabel">--</span>
      </div>
      <div class="clock" id="clockDisplay"></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('measure')">â± è¨ˆæ¸¬</button>
    <button class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</button>
    <button class="tab" onclick="switchTab('history')">ğŸ“‹ å±¥æ­´</button>
  </div>

  <!-- MEASURE -->
  <div id="tab-measure" class="tab-content active">
    <div class="new-ticket-bar">
      <label>å‘¼ã³å‡ºã—ç•ªå·</label>
      <div class="num-spinner">
        <button class="spinner-btn" onmousedown="startRepeat(-1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(-1);return false;" ontouchend="stopRepeat()">âˆ’</button>
        <div class="sdiv"></div>
        <input type="number" class="ticket-input" id="ticketNumInput" min="1" max="999" value="1" oninput="clampNum()" onkeydown="if(event.key==='Enter')addTicket()">
        <div class="sdiv"></div>
        <button class="spinner-btn" onmousedown="startRepeat(1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(1);return false;" ontouchend="stopRepeat()">ï¼‹</button>
      </div>
      <button class="btn-add" onclick="addTicket()">â–¶ è¨ˆæ¸¬é–‹å§‹</button>
      <span class="ticket-count-badge" id="ticketCountBadge">0 / 30ä»¶</span>
      <!-- Tags -->
      <div class="tags-row">
        <label>ã‚¿ã‚°</label>
        <div id="newTagChips"></div>
      </div>
    </div>
    <div class="tickets-grid" id="ticketsGrid">
      <div class="empty-state" id="emptyState">
        <div class="icon">ğŸ¥</div>
        <p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </div>

  <!-- ANALYSIS -->
  <div id="tab-analysis" class="tab-content">
    <div class="filter-bar">
      <label>æ—¥ä»˜</label>
      <input type="date" class="filter-input" id="filterFrom">
      <label>ã€œ</label>
      <input type="date" class="filter-input" id="filterTo">
      <label>ã‚¿ã‚°</label>
      <select class="filter-input" id="filterTag"><option value="">ã™ã¹ã¦</option></select>
      <button class="btn-filter" onclick="updateAnalysis()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="statTotal">-</div><div class="stat-label">å¹³å‡åˆè¨ˆæ™‚é–“</div></div>
      <div class="stat-card"><div class="stat-value" id="statSessions">0</div><div class="stat-label">å®Œäº†ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="statCancelled">0</div><div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="statBN">-</div><div class="stat-label">æœ€å¤šBNå·¥ç¨‹</div></div>
    </div>
    <div class="section-title">å·¥ç¨‹åˆ¥ å¹³å‡æ‰€è¦æ™‚é–“</div>
    <div class="chart-container" id="chartContainer">
      <div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="tab-history" class="tab-content">
    <div class="filter-bar">
      <label>æ—¥ä»˜</label>
      <input type="date" class="filter-input" id="histFilterFrom">
      <label>ã€œ</label>
      <input type="date" class="filter-input" id="histFilterTo">
      <label>ã‚¿ã‚°</label>
      <select class="filter-input" id="histFilterTag"><option value="">ã™ã¹ã¦</option></select>
      <button class="btn-filter" onclick="updateHistory()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearHistFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="history-controls">
      <button class="btn-csv" onclick="exportCSV()">â¬‡ CSVå‡ºåŠ›</button>
      <button class="btn-clear" onclick="clearHistory()">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      <span style="margin-left:auto;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace" id="histCount"></span>
    </div>
    <div class="history-table-wrap">
      <table class="history-table">
        <thead>
          <tr>
            <th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ã‚¿ã‚°</th>
            <th>å—ä»˜ãƒ»å…¥åŠ›</th><th>å‡¦æ–¹ç›£æŸ»ãƒ»ï¾‹ï¾Ÿï½¯ï½·ï¾ï½¸ï¾</th><th>ç›£æŸ»ãƒ»ç¢ºèª</th><th>æŠ•è–¬ãƒ»èª¬æ˜</th>
            <th>åˆè¨ˆ</th><th>BNå·¥ç¨‹</th><th>ä¸€æ™‚åœæ­¢</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="12"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- Resume Modal -->
<div class="modal-overlay hidden" id="resumeModal">
  <div class="modal">
    <h3>å·¥ç¨‹ã‚’é¸æŠã—ã¦å†é–‹</h3>
    <div class="modal-sub" id="resumeModalSub"></div>
    <div class="step-select-list" id="resumeStepList"></div>
    <button class="modal-cancel-btn" onclick="closeResumeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Tag Modal -->
<div class="modal-overlay hidden" id="tagModal">
  <div class="modal">
    <h3>ğŸ· ã‚¿ã‚°ã‚’é¸æŠ</h3>
    <div class="modal-sub" id="tagModalSub">è¤‡æ•°é¸æŠã§ãã¾ã™</div>
    <div class="tag-modal-chips" id="tagModalChips"></div>
    <button class="btn-tag-save" onclick="saveTagModal()">ä¿å­˜</button>
    <button class="modal-cancel-btn" onclick="closeTagModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDOfrlBz3QFG_XtBlwUe43tqPQKv8eiv4s",
  authDomain: "bottleneck-shiraberu.firebaseapp.com",
  databaseURL: "https://bottleneck-shiraberu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bottleneck-shiraberu",
  storageBucket: "bottleneck-shiraberu.firebasestorage.app",
  messagingSenderId: "241290767512",
  appId: "1:241290767512:web:4290cf43b493fdc9f774ed"
};

const fbApp = initializeApp(firebaseConfig);
const db = getDatabase(fbApp);

const PROCESSES = [
  { id:'reception', name:'å—ä»˜ãƒ»å…¥åŠ›',         icon:'ğŸ“‹' },
  { id:'picking',   name:'å‡¦æ–¹ç›£æŸ»ãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚°', icon:'ğŸ’Š' },
  { id:'audit',     name:'ç›£æŸ»ãƒ»ç¢ºèª',          icon:'ğŸ”' },
  { id:'dispensing',name:'æŠ•è–¬ãƒ»èª¬æ˜',          icon:'ğŸ¤' },
];

const TAGS = [
  { id:'ippoka',  label:'ä¸€åŒ…åŒ–',   type:'slow' },
  { id:'sanzai',  label:'æ•£å‰¤',     type:'slow' },
  { id:'suizai',  label:'æ°´å‰¤',     type:'slow' },
  { id:'nanko',   label:'è»Ÿè†ç·´ã‚Š', type:'slow' },
  { id:'shika',   label:'æ­¯ç§‘',     type:'fast' },
  { id:'ganka',   label:'çœ¼ç§‘',     type:'fast' },
  { id:'normal',  label:'ã‚¿ã‚°ãªã—', type:'normal' },
];

let storeCode = '';
let myTickets = {};        // tickets owned by this device
let allTickets = {};       // all tickets from Firebase (active)
let historyCache = [];
let tickerInterval = null;
let pendingResumeId = null;
let pendingTagId = null;   // null = new ticket tag selection
let selectedNewTags = [];
let repeatTimer = null;
let repeatInterval = null;
let fbTicketsUnsub = null;
let fbHistoryUnsub = null;
const deviceId = 'dev_' + Math.random().toString(36).slice(2,10);

// ===== REFS =====
function ticketsRef() { return ref(db, 'stores/' + storeCode + '/tickets'); }
function ticketRef(id) { return ref(db, 'stores/' + storeCode + '/tickets/' + id); }
function historyRef() { return ref(db, 'stores/' + storeCode + '/history'); }

// ===== SYNC STATUS =====
function setSyncStatus(s) {
  document.getElementById('syncDot').className = 'sync-dot ' + s;
  document.getElementById('syncLabel').textContent = {synced:'åŒæœŸæ¸ˆ',syncing:'åŒæœŸä¸­â€¦',error:'ã‚¨ãƒ©ãƒ¼'}[s]||'--';
}

// ===== STORE SETUP =====
function setupInputListeners() {
  const inp = document.getElementById('storeCodeInput');
  inp.addEventListener('input', function() {
    const v = this.value.replace(/\D/g,'');
    this.value = v;
    const hint = document.getElementById('setupHint');
    if (v.length === 5) {
      hint.textContent = 'âœ“ ã‚³ãƒ¼ãƒ‰ ' + v + ' â€” æº–å‚™OKï¼';
      hint.className = 'setup-hint ok';
    } else if (v.length > 0) {
      hint.textContent = 'æ•°å­—5æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ' + v.length + '/5ï¼‰';
      hint.className = 'setup-hint err';
    } else {
      hint.textContent = 'ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002';
      hint.className = 'setup-hint';
    }
  });
  inp.addEventListener('keydown', function(e) { if (e.key === 'Enter') confirmStore(); });
}

function confirmStore() {
  const code = document.getElementById('storeCodeInput').value.replace(/\D/g,'');
  if (code.length !== 5) {
    const hint = document.getElementById('setupHint');
    hint.textContent = 'âš  æ•°å­—5æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ' + code.length + '/5ï¼‰';
    hint.className = 'setup-hint err';
    document.getElementById('storeCodeInput').focus();
    return;
  }
  storeCode = code;
  localStorage.setItem('rx_store_code', code);
  launchApp();
}
window.confirmStore = confirmStore;

function changeStore() {
  if (!confirm('åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) return;
  if (fbTicketsUnsub) fbTicketsUnsub();
  if (fbHistoryUnsub) fbHistoryUnsub();
  myTickets = {}; allTickets = {}; historyCache = [];
  if (tickerInterval) { clearInterval(tickerInterval); tickerInterval = null; }
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('setupScreen').style.display = 'flex';
  document.getElementById('storeCodeInput').value = '';
  document.getElementById('setupHint').textContent = 'ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002';
  document.getElementById('setupHint').className = 'setup-hint';
}
window.changeStore = changeStore;

function launchApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('storeLabel').textContent = storeCode;
  buildTagChips();
  startListening();
  setInterval(updateClock, 1000); updateClock();
}

// ===== FIREBASE LISTENERS =====
function startListening() {
  setSyncStatus('syncing');

  // Listen to active tickets
  fbTicketsUnsub = onValue(ticketsRef(), (snap) => {
    const data = snap.val() || {};
    allTickets = data;
    // Merge remote data into myTickets for ones we own
    Object.keys(myTickets).forEach(id => {
      if (data[id]) {
        // update stepTimes from remote but keep local timer state
        myTickets[id].stepTimes = data[id].stepTimes || {};
      }
    });
    setSyncStatus('synced');
    renderAll();
  }, () => setSyncStatus('error'));

  // Listen to history
  fbHistoryUnsub = onValue(historyRef(), (snap) => {
    const data = snap.val();
    historyCache = data ? (Array.isArray(data) ? data : Object.values(data)) : [];
    updateHistory();
    updateAnalysis();
    populateTagFilters();
  });
}

function pushTicket(t) {
  // Push serializable snapshot of ticket to Firebase
  const snap = {
    id: t.id,
    ticketNum: t.ticketNum,
    status: t.status,
    currentStep: t.currentStep,
    stepTimes: t.stepTimes || {},
    pauseCount: t.pauseCount || 0,
    tags: t.tags || [],
    totalStart: t.totalStart,
    deviceId,
  };
  set(ticketRef(t.id), snap).catch(() => setSyncStatus('error'));
}

function removeTicket(id) {
  remove(ticketRef(id)).catch(() => {});
}

function pushHistory(entry) {
  const history = [...historyCache];
  history.push(entry);
  set(historyRef(), history).catch(() => setSyncStatus('error'));
}

// ===== SPINNER =====
function changeNum(d) {
  const el = document.getElementById('ticketNumInput');
  el.value = Math.max(1, Math.min(999, (parseInt(el.value)||1) + d));
}
function clampNum() {
  const el = document.getElementById('ticketNumInput');
  const v = parseInt(el.value);
  if (isNaN(v)||v<1) el.value=1; else if(v>999) el.value=999;
}
function startRepeat(d) {
  changeNum(d);
  repeatTimer = setTimeout(()=>{ repeatInterval = setInterval(()=>changeNum(d),80); },380);
}
function stopRepeat() { clearTimeout(repeatTimer); clearInterval(repeatInterval); }
window.clampNum=clampNum; window.startRepeat=startRepeat; window.stopRepeat=stopRepeat;

// ===== TAGS =====
function buildTagChips() {
  const wrap = document.getElementById('newTagChips');
  wrap.innerHTML = '';
  TAGS.forEach(tag => {
    const chip = document.createElement('span');
    chip.className = 'tag-chip tag-' + tag.type;
    chip.dataset.id = tag.id;
    chip.textContent = tag.label;
    if (selectedNewTags.includes(tag.id)) chip.classList.add('selected');
    chip.addEventListener('click', () => {
      if (selectedNewTags.includes(tag.id)) {
        selectedNewTags = selectedNewTags.filter(t => t !== tag.id);
        chip.classList.remove('selected');
      } else {
        selectedNewTags.push(tag.id);
        chip.classList.add('selected');
      }
    });
    wrap.appendChild(chip);
  });
}

function openTagModal(ticketId) {
  pendingTagId = ticketId;
  const t = myTickets[ticketId] || allTickets[ticketId];
  const currentTags = t ? (t.tags || []) : [];
  document.getElementById('tagModalSub').textContent = ticketId ? `No.${t?.ticketNum} ã®ã‚¿ã‚°ã‚’å¤‰æ›´` : 'è¤‡æ•°é¸æŠã§ãã¾ã™';
  const chips = document.getElementById('tagModalChips');
  chips.innerHTML = '';
  TAGS.forEach(tag => {
    const chip = document.createElement('button');
    chip.className = 'tag-modal-chip';
    chip.dataset.id = tag.id;
    chip.textContent = tag.label;
    if (currentTags.includes(tag.id)) chip.classList.add('sel-' + tag.type);
    chip.addEventListener('click', () => {
      const sel = 'sel-' + tag.type;
      if (chip.classList.contains(sel)) {
        chip.classList.remove(sel);
      } else {
        chip.classList.add(sel);
      }
    });
    chips.appendChild(chip);
  });
  document.getElementById('tagModal').classList.remove('hidden');
}
window.openTagModal = openTagModal;

function saveTagModal() {
  const chips = document.querySelectorAll('#tagModalChips .tag-modal-chip');
  const selected = [];
  chips.forEach(c => {
    if (c.classList.length > 1) selected.push(c.dataset.id); // has a sel-* class
  });

  if (pendingTagId && myTickets[pendingTagId]) {
    myTickets[pendingTagId].tags = selected;
    pushTicket(myTickets[pendingTagId]);
    renderAll();
  }
  closeTagModal();
}
window.saveTagModal = saveTagModal;

function closeTagModal() {
  document.getElementById('tagModal').classList.add('hidden');
  pendingTagId = null;
}
window.closeTagModal = closeTagModal;

// ===== TICKETS =====
function updateCountBadge() {
  const n = Object.keys(myTickets).filter(id=>['active','paused'].includes(myTickets[id].status)).length;
  document.getElementById('ticketCountBadge').textContent = n + ' / 30ä»¶';
}

function addTicket() {
  const numEl = document.getElementById('ticketNumInput');
  const num = numEl.value.trim();
  if (!num) return;
  const active = Object.values(myTickets).filter(t=>['active','paused'].includes(t.status));
  if (active.length >= 30) { showToast('âš  åŒæ™‚è¨ˆæ¸¬ã¯30ä»¶ã¾ã§ã§ã™'); return; }
  if (Object.values(myTickets).some(t=>t.ticketNum===num&&['active','paused'].includes(t.status))) {
    showToast('âš  ãã®ç•ªå·ã¯ã™ã§ã«è¨ˆæ¸¬ä¸­ã§ã™'); return;
  }

  const id = 'T' + Date.now(), now = Date.now();
  const t = {
    id, ticketNum:num, status:'active', currentStep:0, stepTimes:{},
    pauseCount:0, tags:[...selectedNewTags],
    stepStart:now, pauseStart:null, pauseAccum:0, totalStart:now
  };
  myTickets[id] = t;
  pushTicket(t);

  // Auto-increment number
  const next = Math.min(999, parseInt(num) + 1);
  numEl.value = next;

  document.getElementById('emptyState')?.remove();
  renderAll(); updateCountBadge();
  if (!tickerInterval) tickerInterval = setInterval(renderTimers, 500);
}
window.addTicket = addTicket;

function completeStep(id) {
  const t = myTickets[id]; if (!t||t.status!=='active') return;
  const now = Date.now();
  t.stepTimes[PROCESSES[t.currentStep].id] = (now - t.stepStart) - t.pauseAccum;
  t.pauseAccum = 0;
  if (t.currentStep >= PROCESSES.length - 1) {
    t.status = 'done'; t.totalEnd = now;
    pushTicket(t);
    saveToHistory(t);
    setTimeout(() => { removeTicket(id); delete myTickets[id]; renderAll(); updateCountBadge(); }, 1500);
    renderAll(); updateAnalysis(); updateCountBadge();
  } else {
    t.currentStep++; t.stepStart = now;
    pushTicket(t); renderAll();
  }
}
window.completeStep = completeStep;

function pauseTicket(id) {
  const t = myTickets[id]; if (!t||t.status!=='active') return;
  t.status = 'paused'; t.pauseStart = Date.now(); t.pauseCount++;
  pushTicket(t); renderAll(); updateCountBadge();
}
window.pauseTicket = pauseTicket;

function resumeTicket(id) {
  const t = myTickets[id]; if (!t||t.status!=='paused') return;
  pendingResumeId = id;
  document.getElementById('resumeStepList').innerHTML = PROCESSES.map((p,i) => {
    const ts = t.stepTimes[p.id] ? formatTime(t.stepTimes[p.id]) : '';
    const note = i===t.currentStep?'åœæ­¢ä¸­':i<t.currentStep?'å†è¨ˆæ¸¬':'';
    return `<button class="step-select-btn" onclick="confirmResume(${i})">
      <span class="step-sel-icon">${p.icon}</span>
      <span>${p.name}${note?`<span style="font-size:10px;color:var(--muted);margin-left:4px">ï¼ˆ${note}ï¼‰</span>`:''}</span>
      ${ts?`<span class="step-sel-time">${ts}</span>`:''}
    </button>`;
  }).join('');
  document.getElementById('resumeModalSub').textContent = `No.${t.ticketNum} â€” ã©ã®å·¥ç¨‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ`;
  document.getElementById('resumeModal').classList.remove('hidden');
}
window.resumeTicket = resumeTicket;

function confirmResume(si) {
  const id = pendingResumeId; if (!id) return;
  const t = myTickets[id], now = Date.now();
  PROCESSES.forEach((_,i) => { if(i>=si) delete t.stepTimes[PROCESSES[i].id]; });
  t.currentStep = si; t.stepStart = now; t.pauseAccum = 0; t.pauseStart = null; t.status = 'active';
  pushTicket(t); closeResumeModal(); renderAll(); updateCountBadge();
  if (!tickerInterval) tickerInterval = setInterval(renderTimers, 500);
}
window.confirmResume = confirmResume;

function closeResumeModal() {
  document.getElementById('resumeModal').classList.add('hidden');
  pendingResumeId = null;
}
window.closeResumeModal = closeResumeModal;

function cancelTicket(id) {
  const t = myTickets[id]; if (!t||!['active','paused'].includes(t.status)) return;
  if (!confirm('No.'+t.ticketNum+' ã®è¨ˆæ¸¬ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  t.status = 'cancelled'; t.cancelledAt = Date.now();
  saveToHistory(t);
  removeTicket(id); delete myTickets[id];
  renderAll(); updateHistory(); updateCountBadge();
}
window.cancelTicket = cancelTicket;

// ===== RENDER =====
function getStepElapsed(t) {
  if (t.status==='paused') return Math.max(0,(t.pauseStart-t.stepStart)-t.pauseAccum);
  return Math.max(0,(Date.now()-t.stepStart)-t.pauseAccum);
}
function getTotalElapsed(t) { return (t.totalEnd||t.cancelledAt||Date.now())-t.totalStart; }

function renderAll() {
  const grid = document.getElementById('ticketsGrid');
  grid.querySelectorAll('.ticket-card').forEach(c=>c.remove());
  const emptyEl = document.getElementById('emptyState');

  // Merge: own tickets + remote tickets (not owned by this device)
  const remoteActive = Object.values(allTickets).filter(t => t.deviceId !== deviceId && ['active','paused'].includes(t.status));
  const myActive = Object.values(myTickets).filter(t => ['active','paused'].includes(t.status));
  const myInactive = Object.values(myTickets).filter(t => ['done','cancelled'].includes(t.status));

  const total = myActive.length + remoteActive.length + myInactive.length;
  if (total === 0) {
    if (!emptyEl) {
      const d = document.createElement('div'); d.className='empty-state'; d.id='emptyState';
      d.innerHTML='<div class="icon">ğŸ¥</div><p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>';
      grid.appendChild(d);
    }
    stopTicker(); return;
  }
  if (emptyEl) emptyEl.remove();

  // Sort my active by ticket number
  myActive.sort((a,b)=>parseInt(a.ticketNum)-parseInt(b.ticketNum));
  remoteActive.sort((a,b)=>parseInt(a.ticketNum)-parseInt(b.ticketNum));

  myActive.forEach(t => renderCard(t, grid, false));
  remoteActive.forEach(t => renderCard(t, grid, true));
  myInactive.forEach(t => renderCard(t, grid, false));

  if (myActive.length === 0) stopTicker();
}

function renderCard(t, grid, isRemote) {
  const si = Math.min(t.currentStep, PROCESSES.length-1);
  const proc = PROCESSES[si];
  const card = document.createElement('div');
  card.className = 'ticket-card status-' + t.status + (isRemote?' remote-card':'');
  card.id = 'card-' + t.id;

  const bl = {active:'è¨ˆæ¸¬ä¸­',paused:'ä¸€æ™‚åœæ­¢',done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[t.status];
  const stepsHtml = PROCESSES.map((p,i) => {
    let cls = i<t.currentStep||t.status==='done' ? 'done-step' : i===t.currentStep&&['active','paused'].includes(t.status) ? 'current'+(t.status==='paused'?' paused':'') : 'pending';
    const ts = t.stepTimes?.[p.id] ? formatTime(t.stepTimes[p.id]) : cls.includes('current')?'â€¦':'';
    return `<div class="step ${cls}" title="${p.name}">${p.icon}<div class="step-time">${ts}</div></div>`;
  }).join('');

  // Tags
  const tags = t.tags || [];
  let tagsHtml = '';
  if (tags.length > 0) {
    tagsHtml = '<div class="card-tags">' + tags.map(tid => {
      const tag = TAGS.find(x=>x.id===tid);
      return tag ? `<span class="card-tag ${tag.type}">${tag.label}</span>` : '';
    }).join('') + (isRemote ? '' : `<button class="btn-tag-edit" onclick="openTagModal('${t.id}')">âœ ç·¨é›†</button>`) + '</div>';
  } else if (!isRemote) {
    tagsHtml = `<div class="card-tags"><button class="btn-tag-edit" onclick="openTagModal('${t.id}')">ï¼‹ ã‚¿ã‚°è¿½åŠ </button></div>`;
  }

  let cpHtml = '';
  if (['active','paused'].includes(t.status)) {
    const timerVal = isRemote ? '--:--' : '00:00';
    cpHtml = `<div class="current-process"><span class="proc-icon">${proc.icon}</span><span class="proc-name">${proc.name}</span><span class="proc-timer${t.status==='paused'?' blinking':''}"><span id="timer-${t.id}">${timerVal}</span></span></div>`;
  } else if (t.status==='done') {
    cpHtml = `<div class="current-process"><span class="proc-icon">âœ…</span><span class="proc-name" style="color:var(--success)">å…¨å·¥ç¨‹å®Œäº†</span></div>`;
  } else {
    cpHtml = `<div class="current-process"><span class="proc-icon">âŒ</span><span class="proc-name" style="color:var(--muted)">${proc.name}ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span></div>`;
  }

  const remoteLabel = isRemote ? '<span style="font-size:10px;color:var(--muted);margin-left:4px">ï¼ˆä»–ç«¯æœ«ï¼‰</span>' : '';
  const pauseInfo = (t.pauseCount||0)>0 ? `<div class="pause-info">â¸ ä¸€æ™‚åœæ­¢ ${t.pauseCount}å›</div>` : '';

  let btns = '';
  if (!isRemote) {
    if (t.status==='active') {
      const isLast = t.currentStep>=PROCESSES.length-1;
      btns = `<button class="tbtn tbtn-complete" onclick="completeStep('${t.id}')">${isLast?'âœ… å®Œäº†':'âœ” å®Œäº† â†’ æ¬¡ã¸'}</button><button class="tbtn tbtn-pause" onclick="pauseTicket('${t.id}')">â¸</button><button class="tbtn tbtn-cancel" onclick="cancelTicket('${t.id}')">âœ•</button>`;
    } else if (t.status==='paused') {
      btns = `<button class="tbtn tbtn-resume" onclick="resumeTicket('${t.id}')">â–¶ å†é–‹ï¼ˆå·¥ç¨‹é¸æŠï¼‰</button><button class="tbtn tbtn-cancel" onclick="cancelTicket('${t.id}')">âœ•</button>`;
    }
  }

  card.innerHTML = `
    <div class="ticket-header">
      <div class="ticket-num">No.${t.ticketNum}${remoteLabel}</div>
      <span class="ticket-badge badge-${t.status}">${bl}</span>
    </div>
    ${tagsHtml}
    <div class="steps">${stepsHtml}</div>
    ${cpHtml}
    <div class="total-time" id="total-${t.id}">åˆè¨ˆ: <span>${formatTime(getTotalElapsed(t))}</span></div>
    ${pauseInfo}
    ${btns?`<div class="ticket-buttons">${btns}</div>`:''}
  `;
  grid.appendChild(card);
  if (!isRemote && ['active','paused'].includes(t.status)) updateTimerEl(t.id);
}

function renderTimers() {
  Object.values(myTickets).forEach(t => {
    if (t.status!=='active') return;
    updateTimerEl(t.id);
    const el = document.getElementById('total-'+t.id);
    if (el) el.innerHTML = 'åˆè¨ˆ: <span>' + formatTime(getTotalElapsed(t)) + '</span>';
  });
}
function updateTimerEl(id) {
  const el = document.getElementById('timer-'+id);
  if (el) el.textContent = formatTime(getStepElapsed(myTickets[id]));
}
function stopTicker() {
  if (!Object.values(myTickets).some(t=>t.status==='active') && tickerInterval) {
    clearInterval(tickerInterval); tickerInterval = null;
  }
}

// ===== HISTORY =====
function saveToHistory(t) {
  const dt = new Date();
  const total = Object.values(t.stepTimes||{}).reduce((a,b)=>a+b,0);
  let bnId=null, bnMs=0;
  Object.entries(t.stepTimes||{}).forEach(([id,ms])=>{ if(ms>bnMs){bnMs=ms;bnId=id;} });
  const bnProc = PROCESSES.find(p=>p.id===bnId);
  const entry = {
    storeCode, ticketNum:t.ticketNum,
    date:dt.toLocaleDateString('ja-JP'),
    time:dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),
    dateISO:dt.toISOString().slice(0,10),
    ts:Date.now(), status:t.status,
    stepTimes:{...t.stepTimes||{}}, total,
    bottleneck:bnProc?bnProc.name:null,
    pauseCount:t.pauseCount||0, hasPause:(t.pauseCount||0)>0,
    tags:t.tags||[],
  };
  pushHistory(entry);
}

function populateTagFilters() {
  const allTags = new Set();
  historyCache.forEach(h => (h.tags||[]).forEach(t => allTags.add(t)));
  ['filterTag','histFilterTag'].forEach(id => {
    const sel = document.getElementById(id);
    const cur = sel.value;
    sel.innerHTML = '<option value="">ã™ã¹ã¦</option>';
    TAGS.forEach(tag => {
      if (allTags.has(tag.id)) {
        const opt = document.createElement('option');
        opt.value = tag.id; opt.textContent = tag.label;
        if (cur === tag.id) opt.selected = true;
        sel.appendChild(opt);
      }
    });
  });
}

function getFiltered(fromId, toId, tagId) {
  const from = document.getElementById(fromId).value;
  const to = document.getElementById(toId).value;
  const tag = document.getElementById(tagId).value;
  return historyCache.filter(h => {
    if (from && h.dateISO < from) return false;
    if (to && h.dateISO > to) return false;
    if (tag && !(h.tags||[]).includes(tag)) return false;
    return true;
  });
}

function updateHistory() {
  const history = getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  document.getElementById('histCount').textContent = history.length+'ä»¶';
  const tbody = document.getElementById('historyBody');
  if (!history.length) {
    tbody.innerHTML='<tr><td colspan="12"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';
    return;
  }
  tbody.innerHTML = [...history].reverse().map(h => {
    const steps = PROCESSES.map(p=>h.stepTimes?.[p.id]?formatTime(h.stepTimes[p.id]):'-').join('</td><td>');
    const stTag = h.status==='done'?'<span class="tag tag-done">å®Œäº†</span>':'<span class="tag tag-cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
    const pTag = h.hasPause?`<span class="tag tag-pause-info">${h.pauseCount}å›</span>`:'<span style="color:var(--muted)">ãªã—</span>';
    const tagHtml = (h.tags||[]).map(tid=>{
      const tag=TAGS.find(x=>x.id===tid);
      return tag?`<span class="card-tag ${tag.type}" style="font-size:10px;padding:1px 6px;">${tag.label}</span>`:'';
    }).join(' ');
    return `<tr>
      <td style="font-family:'JetBrains Mono',monospace">${h.date||''}</td>
      <td style="font-family:'JetBrains Mono',monospace">${h.time||''}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:700">No.${h.ticketNum}</td>
      <td>${tagHtml||'<span style="color:var(--muted)">-</span>'}</td>
      <td>${steps}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-weight:700">${h.total?formatTime(h.total):'-'}</td>
      <td class="bn-text">${h.bottleneck||'-'}</td>
      <td>${pTag}</td>
      <td>${stTag}</td>
    </tr>`;
  }).join('');
}
window.updateHistory = updateHistory;

async function clearHistory() {
  if (!confirm('ã“ã®åº—èˆ—ã®å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  historyCache = [];
  await remove(historyRef());
  updateHistory(); updateAnalysis(); showToast('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}
window.clearHistory = clearHistory;

function clearFilter() {
  document.getElementById('filterFrom').value='';
  document.getElementById('filterTo').value='';
  document.getElementById('filterTag').value='';
  updateAnalysis();
}
function clearHistFilter() {
  document.getElementById('histFilterFrom').value='';
  document.getElementById('histFilterTo').value='';
  document.getElementById('histFilterTag').value='';
  updateHistory();
}
window.clearFilter=clearFilter; window.clearHistFilter=clearHistFilter;

function exportCSV() {
  const history = getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  if (!history.length) { showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const headers = ['åº—èˆ—ã‚³ãƒ¼ãƒ‰','æ—¥ä»˜','æ™‚åˆ»','å‘¼ã³å‡ºã—ç•ªå·','ã‚¿ã‚°',...PROCESSES.map(p=>p.name),'åˆè¨ˆæ™‚é–“(s)','ãƒœãƒˆãƒ«ãƒãƒƒã‚¯å·¥ç¨‹','ä¸€æ™‚åœæ­¢å›æ•°','ä¸€æ™‚åœæ­¢ã‚ã‚Š','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹'];
  const rows = [...history].reverse().map(h => [
    h.storeCode||storeCode, h.date||'', h.time||'', 'No.'+h.ticketNum,
    (h.tags||[]).map(tid=>TAGS.find(x=>x.id===tid)?.label||tid).join('ãƒ»'),
    ...PROCESSES.map(p=>h.stepTimes?.[p.id]?((h.stepTimes[p.id]/1000).toFixed(1)):'-'),
    h.total?(h.total/1000).toFixed(1):'-',
    h.bottleneck||'-', h.pauseCount||0, h.hasPause?'ã‚ã‚Š':'ãªã—',
    {done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[h.status]||h.status
  ]);
  const csv = '\uFEFF'+[headers,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const from = document.getElementById('histFilterFrom').value;
  const to = document.getElementById('histFilterTo').value;
  a.download = `èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯_${storeCode}${from?'_'+from:''}${to?'_'+to:''}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
  showToast(`âœ“ CSVå‡ºåŠ› ${rows.length}ä»¶`);
}
window.exportCSV = exportCSV;

function updateAnalysis() {
  const all = getFiltered('filterFrom','filterTo','filterTag');
  const done = all.filter(h=>h.status==='done');
  document.getElementById('statSessions').textContent = done.length;
  document.getElementById('statCancelled').textContent = all.filter(h=>h.status==='cancelled').length;
  if (!done.length) {
    document.getElementById('statTotal').textContent='-';
    document.getElementById('statBN').textContent='-';
    document.getElementById('chartContainer').innerHTML='<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    return;
  }
  const sums={}, counts={};
  PROCESSES.forEach(p=>{sums[p.id]=0;counts[p.id]=0;});
  let totalSum=0;
  done.forEach(h=>{
    totalSum+=h.total||0;
    PROCESSES.forEach(p=>{ if(h.stepTimes?.[p.id]){sums[p.id]+=h.stepTimes[p.id];counts[p.id]++;} });
  });
  document.getElementById('statTotal').textContent=formatTime(totalSum/done.length);
  const avgs={};
  PROCESSES.forEach(p=>{avgs[p.id]=counts[p.id]?sums[p.id]/counts[p.id]:0;});
  const maxMs=Math.max(...Object.values(avgs));
  const bnId=Object.entries(avgs).sort((a,b)=>b[1]-a[1])[0]?.[0];
  document.getElementById('statBN').textContent=PROCESSES.find(p=>p.id===bnId)?.name||'-';
  const withData=PROCESSES.filter(p=>avgs[p.id]>0);
  document.getElementById('chartContainer').innerHTML=withData.map(p=>{
    const pct=maxMs?(avgs[p.id]/maxMs*100):0;
    const isBN=p.id===bnId;
    const cls=isBN?'bottleneck':pct>60?'normal':'fast';
    return `<div class="bar-row"><div class="bar-label">${p.icon} ${p.name}</div><div class="bar-wrap"><div class="bar-fill ${cls}" style="width:${Math.max(pct,4)}%">${formatTime(avgs[p.id])}</div></div>${isBN?'<span class="bn-badge">BN</span>':'<span style="width:36px;flex-shrink:0"></span>'}</div>`;
  }).join('')||'<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
}
window.updateAnalysis = updateAnalysis;

// ===== UTILS =====
function formatTime(ms){ const s=Math.floor(ms/1000); return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600); }
function switchTab(name){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['measure','analysis','history'][i]===name));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='analysis') updateAnalysis();
  if(name==='history') updateHistory();
}
window.switchTab = switchTab;
function updateClock(){ const n=new Date(); document.getElementById('clockDisplay').textContent=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0'); }

// ===== BOOT =====
setupInputListeners();
const saved = localStorage.getItem('rx_store_code');
if (saved && saved.length===5) {
  storeCode = saved;
  document.getElementById('storeCodeInput').value = saved;
  launchApp();
}
</script>
</body>
</html>
