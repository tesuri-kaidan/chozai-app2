<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f3ef;--surface:#fff;--surface2:#eeecea;
  --accent:#1a5cff;--accent-soft:#e8eeff;
  --danger:#d90019;--danger-soft:#fff0f1;
  --success:#007a38;--success-soft:#e6f5ed;
  --pause:#b87000;--pause-soft:#fff7e0;
  --giqi:#7c00c8;--giqi-soft:#f3e8ff;
  --hiyari:#c80050;--hiyari-soft:#ffe8f0;
  --text:#1a1a1a;--muted:#8a8a84;--border:#dedad4;
  --shadow:0 2px 10px rgba(0,0,0,0.06);--shadow-lg:0 8px 32px rgba(0,0,0,0.13);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;}
#setupScreen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:36px 32px;width:100%;max-width:400px;box-shadow:var(--shadow-lg);text-align:center;}
.setup-card .logo{font-size:42px;margin-bottom:12px;}
.setup-card h2{font-size:20px;font-weight:900;margin-bottom:6px;}
.setup-card p{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.7;}
.setup-code-input{width:100%;text-align:center;font-family:'JetBrains Mono',monospace;font-size:34px;font-weight:700;letter-spacing:10px;background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:14px 10px;outline:none;color:var(--text);transition:border-color 0.15s;margin-bottom:8px;}
.setup-code-input:focus{border-color:var(--accent);}
.setup-hint{font-size:12px;color:var(--muted);margin-bottom:20px;font-family:'JetBrains Mono',monospace;}
.setup-hint.ok{color:var(--success);font-weight:700;}
.setup-hint.err{color:var(--danger);font-weight:700;}
.btn-setup{width:100%;padding:15px;background:var(--accent);color:#fff;border:none;border-radius:11px;font-size:16px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;box-shadow:0 3px 10px rgba(26,92,255,0.3);}
.btn-setup:hover{filter:brightness(1.1);}
#mainApp{display:none;}
.container{max-width:1060px;margin:0 auto;padding:16px 14px;}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--surface);border-radius:14px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.header-left{display:flex;align-items:center;gap:10px;}
.store-badge{background:var(--accent-soft);border:1.5px solid var(--accent);border-radius:8px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;user-select:none;}
.store-badge:hover{background:#d4e0ff;}
.header-title{font-size:16px;font-weight:900;}
.header-right{display:flex;align-items:center;gap:12px;}
.sync-wrap{display:flex;align-items:center;gap:5px;}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:background 0.3s;flex-shrink:0;}
.sync-dot.synced{background:var(--success);}
.sync-dot.syncing{background:var(--pause);animation:pulse 0.8s ease-in-out infinite;}
.sync-dot.error{background:var(--danger);}
.sync-label{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);}
.clock{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;}
.tabs{display:flex;gap:3px;margin-bottom:12px;background:var(--surface);padding:4px;border-radius:10px;border:1px solid var(--border);box-shadow:var(--shadow);}
.tab{flex:1;padding:8px 2px;text-align:center;border-radius:7px;cursor:pointer;font-size:12px;font-weight:700;color:var(--muted);transition:all 0.18s;border:none;background:none;font-family:'Noto Sans JP',sans-serif;}
.tab.active{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(26,92,255,0.28);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.new-ticket-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:12px 15px;margin-bottom:12px;box-shadow:var(--shadow);}
.new-ticket-bar label{font-size:13px;color:var(--muted);white-space:nowrap;font-weight:500;}
.num-spinner{display:flex;align-items:center;border:2px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface2);}
.num-spinner:focus-within{border-color:var(--accent);}
.spinner-btn{width:50px;height:54px;border:none;background:var(--surface2);color:var(--text);font-size:24px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.1s;user-select:none;-webkit-user-select:none;touch-action:manipulation;flex-shrink:0;}
.spinner-btn:hover{background:var(--border);}
.spinner-btn:active{background:var(--accent);color:#fff;}
.sdiv{width:1px;height:30px;background:var(--border);flex-shrink:0;}
.ticket-input{width:76px;background:transparent;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:26px;font-weight:700;padding:0 4px;text-align:center;outline:none;-moz-appearance:textfield;}
.ticket-input::-webkit-inner-spin-button,.ticket-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
.btn-add{padding:0 22px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all 0.15s;white-space:nowrap;box-shadow:0 2px 8px rgba(26,92,255,0.28);touch-action:manipulation;height:54px;}
.btn-add:hover{filter:brightness(1.1);}
.btn-add:active{transform:scale(0.97);}
.ticket-count-badge{margin-left:auto;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;}
.tags-row{width:100%;display:flex;flex-wrap:wrap;gap:6px;padding-top:6px;border-top:1px solid var(--border);margin-top:2px;align-items:center;}
.tags-row label{font-size:12px;color:var(--muted);font-weight:500;white-space:nowrap;}
.tag-chip{display:inline-flex;align-items:center;padding:5px 10px;border-radius:99px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;user-select:none;touch-action:manipulation;}
.tag-chip:hover{border-color:var(--accent);}
.tag-chip.selected{border-color:var(--accent);background:var(--accent-soft);color:var(--accent);}
.tag-chip.tag-fast.selected{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-chip.tag-slow.selected{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}
.tickets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:11px;max-height:68vh;overflow-y:auto;padding-bottom:4px;}
.tickets-grid::-webkit-scrollbar{width:4px;}
.tickets-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.ticket-card{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:14px;transition:border-color 0.2s,box-shadow 0.2s;box-shadow:var(--shadow);}
.ticket-card.status-active{border-color:var(--accent);box-shadow:0 4px 18px rgba(26,92,255,0.12);}
.ticket-card.status-paused{border-color:var(--pause);box-shadow:0 4px 14px rgba(184,112,0,0.10);}
.ticket-card.status-giqi{border-color:var(--giqi);box-shadow:0 4px 14px rgba(124,0,200,0.12);}
.ticket-card.status-cancelled{border-color:var(--border);opacity:0.6;box-shadow:none;}
.ticket-card.status-done{border-color:var(--success);box-shadow:0 4px 14px rgba(0,122,56,0.10);}
.ticket-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.ticket-num{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;}
.status-active .ticket-num{color:var(--accent);}
.status-paused .ticket-num{color:var(--pause);}
.status-giqi .ticket-num{color:var(--giqi);}
.status-done .ticket-num{color:var(--success);}
.status-cancelled .ticket-num{color:var(--muted);}
.ticket-badge{font-size:10px;font-family:'JetBrains Mono',monospace;padding:3px 9px;border-radius:99px;font-weight:700;}
.badge-active{background:var(--accent-soft);color:var(--accent);}
.badge-paused{background:var(--pause-soft);color:var(--pause);}
.badge-giqi{background:var(--giqi-soft);color:var(--giqi);}
.badge-cancelled{background:var(--danger-soft);color:var(--danger);}
.badge-done{background:var(--success-soft);color:var(--success);}
.card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:7px;align-items:center;}
.card-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:99px;border:1px solid;}
.card-tag.slow{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.card-tag.fast{background:var(--success-soft);color:var(--success);border-color:rgba(0,122,56,0.3);}
.card-tag.normal{background:var(--surface2);color:var(--muted);border-color:var(--border);}
.btn-tag-edit{font-size:10px;padding:2px 8px;border-radius:99px;border:1px dashed var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.btn-tag-edit:hover{border-color:var(--accent);color:var(--accent);}
.hiyari-flag{display:flex;align-items:center;gap:5px;background:var(--hiyari-soft);border:1px solid rgba(200,0,80,0.25);border-radius:7px;padding:4px 9px;margin-bottom:7px;font-size:11px;color:var(--hiyari);font-weight:700;}
.hiyari-flag .hf-dot{width:6px;height:6px;border-radius:50%;background:var(--hiyari);animation:pulse 1s ease-in-out infinite;flex-shrink:0;}
.steps{display:flex;gap:3px;margin-bottom:8px;}
.step{flex:1;text-align:center;padding:5px 2px;border-radius:5px;font-size:9px;font-weight:700;transition:all 0.2s;}
.step.pending{background:var(--surface2);color:var(--muted);}
.step.current{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.28);}
.step.current.paused{background:var(--pause-soft);color:var(--pause);border-color:rgba(184,112,0,0.3);}
.step.current.giqi{background:var(--giqi-soft);color:var(--giqi);border-color:rgba(124,0,200,0.3);}
.step.done-step{background:var(--success-soft);color:var(--success);}
.step-time{font-family:'JetBrains Mono',monospace;font-size:8px;margin-top:2px;}
.current-process{display:flex;align-items:center;gap:9px;background:var(--surface2);border-radius:9px;padding:9px 12px;margin-bottom:8px;}
.proc-icon{font-size:17px;}
.proc-name{font-size:12px;font-weight:700;flex:1;}
.proc-timer{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;}
.giqi-info{font-size:11px;color:var(--giqi);font-family:'JetBrains Mono',monospace;margin-bottom:5px;}
.giqi-info span{font-weight:700;}
.total-time{font-size:11px;color:var(--muted);margin-bottom:6px;font-family:'JetBrains Mono',monospace;}
.total-time span{color:var(--text);font-weight:700;}
.sub-info{font-size:10px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:2px;}
.ticket-buttons{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap;}
.tbtn{padding:9px 6px;border-radius:8px;border:none;cursor:pointer;font-size:11px;font-weight:700;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;touch-action:manipulation;white-space:nowrap;line-height:1.3;flex:1;}
.tbtn-next{background:var(--accent);color:#fff;flex:2;box-shadow:0 2px 6px rgba(26,92,255,0.20);}
.tbtn-next:hover{filter:brightness(1.1);}
.tbtn-pause{background:var(--pause-soft);color:var(--pause);border:1px solid rgba(184,112,0,0.22);}
.tbtn-giqi{background:var(--giqi-soft);color:var(--giqi);border:1px solid rgba(124,0,200,0.22);}
.tbtn-giqi.on{background:var(--giqi);color:#fff;}
.tbtn-hiyari{background:var(--hiyari-soft);color:var(--hiyari);border:1px solid rgba(200,0,80,0.22);}
.tbtn-resume{background:var(--accent-soft);color:var(--accent);border:1px solid rgba(26,92,255,0.22);flex:2;}
.tbtn-cancel{background:var(--danger-soft);color:var(--danger);border:1px solid rgba(217,0,25,0.18);}
.tbtn-restore{background:var(--success);color:#fff;flex:2;}
.tbtn-restore:hover{filter:brightness(1.1);}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:38px;margin-bottom:10px;}
.empty-state p{font-size:14px;}
.cancelled-section{margin-top:16px;}
.cancelled-header{font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-bottom:8px;padding:0 2px;}
.filter-bar{display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;box-shadow:var(--shadow);flex-wrap:wrap;}
.filter-bar label{font-size:12px;color:var(--muted);font-weight:500;}
.filter-input{background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;padding:6px 9px;outline:none;}
.filter-input:focus{border-color:var(--accent);}
.btn-filter{padding:7px 13px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-filter.sec{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;margin-bottom:12px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:13px;text-align:center;box-shadow:var(--shadow);}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--accent);}
.stat-label{font-size:10px;color:var(--muted);margin-top:3px;font-weight:500;}
.section-title{font-size:10px;font-family:'JetBrains Mono',monospace;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;margin-top:14px;}
.section-title:first-child{margin-top:0;}
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:var(--shadow);}
.bar-row{display:flex;align-items:center;gap:9px;margin-bottom:7px;}
.bar-label{width:130px;font-size:11px;color:var(--text);flex-shrink:0;text-align:right;font-weight:500;}
.bar-wrap{flex:1;height:24px;background:var(--surface2);border-radius:5px;overflow:hidden;}
.bar-fill{height:100%;border-radius:5px;transition:width 0.7s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:700;color:#fff;min-width:44px;}
.bar-fill.bn{background:linear-gradient(90deg,var(--danger),#ff4520);}
.bar-fill.nrm{background:linear-gradient(90deg,var(--accent),#3d77ff);}
.bar-fill.fst{background:linear-gradient(90deg,var(--success),#00a84e);}
.bar-fill.giq{background:linear-gradient(90deg,var(--giqi),#a020f0);}
.bar-fill.hiy{background:linear-gradient(90deg,var(--hiyari),#ff2060);}
.bn-badge{background:var(--danger-soft);border:1px solid var(--danger);color:var(--danger);font-size:10px;font-family:'JetBrains Mono',monospace;padding:2px 7px;border-radius:4px;flex-shrink:0;font-weight:700;}
.history-controls{display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap;}
.btn-csv{padding:9px 16px;background:var(--success);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;box-shadow:0 2px 8px rgba(0,122,56,0.22);}
.btn-csv:hover{filter:brightness(1.1);}
.btn-clear{padding:9px 13px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-clear:hover{color:var(--danger);border-color:var(--danger);}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--shadow);overflow-x:auto;margin-bottom:12px;}
.data-table{width:100%;border-collapse:collapse;font-size:11px;}
.data-table th{text-align:left;padding:8px 10px;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:9px;letter-spacing:1px;border-bottom:1px solid var(--border);background:var(--surface2);white-space:nowrap;}
.data-table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle;white-space:nowrap;}
.data-table tr:last-child td{border-bottom:none;}
.data-table tr:hover td{background:var(--surface2);}
.bn-text{color:var(--danger);font-weight:700;}
.tag{display:inline-block;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:700;}
.tag-done{background:var(--success-soft);color:var(--success);}
.tag-cancelled{background:var(--danger-soft);color:var(--danger);}
.tag-giqi{background:var(--giqi-soft);color:var(--giqi);}
.tag-hiyari{background:var(--hiyari-soft);color:var(--hiyari);}
.pending-badge{background:var(--hiyari-soft);color:var(--hiyari);font-size:10px;padding:2px 7px;border-radius:4px;font-weight:700;border:1px solid rgba(200,0,80,0.3);}
.btn-write{padding:5px 11px;background:var(--hiyari);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;}
.btn-write:hover{filter:brightness(1.1);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px);padding:16px;}
.modal-overlay.hidden{display:none;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;width:100%;max-width:420px;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;}
.modal h3{font-size:16px;font-weight:900;margin-bottom:4px;}
.modal .modal-sub{font-size:12px;color:var(--muted);margin-bottom:14px;}
.step-select-list{display:flex;flex-direction:column;gap:6px;margin-bottom:13px;}
.step-select-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:9px;background:var(--surface2);border:1.5px solid var(--border);color:var(--text);cursor:pointer;font-size:13px;font-weight:600;font-family:'Noto Sans JP',sans-serif;transition:all 0.13s;text-align:left;touch-action:manipulation;width:100%;}
.step-select-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-soft);}
.step-sel-icon{font-size:17px;}
.step-sel-time{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--success);font-weight:700;}
.modal-cancel-btn{width:100%;padding:10px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-top:8px;}
.modal-cancel-btn:hover{color:var(--text);}
.btn-save-modal{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:9px;font-size:14px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;margin-bottom:6px;}
.btn-save-modal:hover{filter:brightness(1.1);}
.btn-save-modal.danger{background:var(--hiyari);}
.btn-save-modal.dark{background:var(--text);}
.tag-modal-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.tag-modal-chip{padding:9px 16px;border-radius:99px;border:2px solid var(--border);background:var(--surface2);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.tag-modal-chip.sel-slow{border-color:var(--pause);background:var(--pause-soft);color:var(--pause);}
.tag-modal-chip.sel-fast{border-color:var(--success);background:var(--success-soft);color:var(--success);}
.tag-modal-chip.sel-normal{border-color:var(--muted);background:var(--surface2);color:var(--muted);}
.hiyari-section{margin-bottom:14px;}
.hiyari-section h4{font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;}
.hiyari-chips{display:flex;flex-wrap:wrap;gap:6px;}
.hiyari-chip{padding:7px 12px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.hiyari-chip.sel{border-color:var(--hiyari);background:var(--hiyari-soft);color:var(--hiyari);}
.hiyari-chip:hover{border-color:var(--hiyari);}
.hiyari-textarea{width:100%;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;font-size:13px;font-family:'Noto Sans JP',sans-serif;color:var(--text);outline:none;resize:vertical;min-height:70px;margin-top:8px;}
.hiyari-textarea:focus{border-color:var(--hiyari);}
.step-picker{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.step-pick-btn{padding:9px 12px;border-radius:9px;border:1.5px solid var(--border);background:var(--surface2);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.13s;font-family:'Noto Sans JP',sans-serif;touch-action:manipulation;}
.step-pick-btn.sel{border-color:var(--hiyari);background:var(--hiyari-soft);color:var(--hiyari);}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--text);color:#fff;padding:10px 22px;border-radius:99px;font-size:13px;font-weight:700;transition:transform 0.3s;z-index:400;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.blinking{animation:pulse 1s ease-in-out infinite;}
@media(max-width:600px){
  .container{padding:10px;} header{padding:10px 12px;border-radius:11px;margin-bottom:10px;}
  .header-title{font-size:14px;} .clock{font-size:11px;} .sync-label{display:none;}
  .tab{font-size:11px;padding:8px 2px;}
  .spinner-btn{width:54px;height:58px;font-size:27px;} .ticket-input{font-size:27px;width:70px;}
  .btn-add{font-size:14px;height:58px;padding:0 16px;}
  .ticket-count-badge{width:100%;text-align:right;margin-left:0;}
  .tickets-grid{grid-template-columns:1fr;max-height:none;}
  .tbtn{font-size:11px;padding:10px 5px;min-height:44px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .stat-value{font-size:16px;} .filter-input{font-size:12px;max-width:120px;}
  .bar-label{width:95px;font-size:10px;} .modal{padding:16px;}
}
</style>
</head>
<body>

<div id="setupScreen">
  <div class="setup-card">
    <div class="logo">ğŸ¥</div>
    <h2>èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</h2>
    <p>ã“ã®ç«¯æœ«ãŒä½¿ç”¨ã™ã‚‹<strong>åº—èˆ—ã‚³ãƒ¼ãƒ‰ï¼ˆ5æ¡ï¼‰</strong>ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>åŒã˜ã‚³ãƒ¼ãƒ‰ã®ç«¯æœ«é–“ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«åŒæœŸãƒ»æ“ä½œã§ãã¾ã™ã€‚</p>
    <input type="text" class="setup-code-input" id="storeCodeInput" placeholder="00000" maxlength="5" inputmode="numeric">
    <div class="setup-hint" id="setupHint">ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002</div>
    <button class="btn-setup" onclick="confirmStore()">ã“ã®åº—èˆ—ã‚³ãƒ¼ãƒ‰ã§å§‹ã‚ã‚‹</button>
  </div>
</div>

<div id="mainApp">
<div class="container">
  <header>
    <div class="header-left">
      <div class="store-badge" onclick="changeStore()">ğŸª <span id="storeLabel">-----</span></div>
      <div class="header-title">èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†æ</div>
    </div>
    <div class="header-right">
      <div class="sync-wrap"><div class="sync-dot" id="syncDot"></div><span class="sync-label" id="syncLabel">--</span></div>
      <div class="clock" id="clockDisplay"></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('measure')">â± è¨ˆæ¸¬</button>
    <button class="tab" onclick="switchTab('analysis')">ğŸ“Š åˆ†æ</button>
    <button class="tab" onclick="switchTab('history')">ğŸ“‹ å±¥æ­´</button>
    <button class="tab" onclick="switchTab('hiyari')">âš  ãƒ’ãƒ¤ãƒª</button>
  </div>

  <div id="tab-measure" class="tab-content active">
    <div class="new-ticket-bar">
      <label>å‘¼ã³å‡ºã—ç•ªå·</label>
      <div class="num-spinner">
        <button class="spinner-btn" onmousedown="startRepeat(-1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(-1);return false;" ontouchend="stopRepeat()">âˆ’</button>
        <div class="sdiv"></div>
        <input type="number" class="ticket-input" id="ticketNumInput" min="1" max="999" value="1" oninput="clampNum()" onkeydown="if(event.key==='Enter')addTicket()">
        <div class="sdiv"></div>
        <button class="spinner-btn" onmousedown="startRepeat(1)" onmouseup="stopRepeat()" onmouseleave="stopRepeat()" ontouchstart="startRepeat(1);return false;" ontouchend="stopRepeat()">ï¼‹</button>
      </div>
      <button class="btn-add" onclick="addTicket()">â–¶ è¨ˆæ¸¬é–‹å§‹</button>
      <span class="ticket-count-badge" id="ticketCountBadge">0 / 30ä»¶</span>
      <div class="tags-row">
        <label>ã‚¿ã‚°</label>
        <div id="newTagChips" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
    </div>
    <div class="tickets-grid" id="ticketsGrid">
      <div class="empty-state" id="emptyState"><div class="icon">ğŸ¥</div><p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p></div>
    </div>
    <div id="cancelledSection" style="display:none;" class="cancelled-section">
      <div class="cancelled-header">â–¼ ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ï¼ˆæœ¬æ—¥åˆ†ãƒ»å¾©æ´»å¯èƒ½ï¼‰</div>
      <div class="tickets-grid" id="cancelledGrid"></div>
    </div>
  </div>

  <div id="tab-analysis" class="tab-content">
    <div class="filter-bar">
      <label>æ—¥ä»˜</label><input type="date" class="filter-input" id="filterFrom"><label>ã€œ</label><input type="date" class="filter-input" id="filterTo">
      <label>ã‚¿ã‚°</label><select class="filter-input" id="filterTag"><option value="">ã™ã¹ã¦</option></select>
      <button class="btn-filter" onclick="updateAnalysis()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="statTotal">-</div><div class="stat-label">å¹³å‡åˆè¨ˆæ™‚é–“</div></div>
      <div class="stat-card"><div class="stat-value" id="statSessions">0</div><div class="stat-label">å®Œäº†ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="statGiqiRate">-</div><div class="stat-label">ç–‘ç¾©ç…§ä¼šç‡</div></div>
      <div class="stat-card"><div class="stat-value" id="statBN">-</div><div class="stat-label">æœ€å¤šBNå·¥ç¨‹</div></div>
    </div>
    <div class="section-title">å·¥ç¨‹åˆ¥ å¹³å‡æ‰€è¦æ™‚é–“</div>
    <div class="chart-container" id="chartContainer"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">ç–‘ç¾©ç…§ä¼š åˆ†æ</div>
    <div class="chart-container" id="giqiChart"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
  </div>

  <div id="tab-history" class="tab-content">
    <div class="filter-bar">
      <label>æ—¥ä»˜</label><input type="date" class="filter-input" id="histFilterFrom"><label>ã€œ</label><input type="date" class="filter-input" id="histFilterTo">
      <label>ã‚¿ã‚°</label><select class="filter-input" id="histFilterTag"><option value="">ã™ã¹ã¦</option></select>
      <button class="btn-filter" onclick="updateHistory()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearHistFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="history-controls">
      <button class="btn-csv" onclick="exportCSV()">â¬‡ CSVå‡ºåŠ›</button>
      <button class="btn-clear" onclick="clearHistory()">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      <span style="margin-left:auto;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace" id="histCount"></span>
    </div>
    <div class="table-wrap">
      <table class="data-table" style="min-width:900px;">
        <thead><tr><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ã‚¿ã‚°</th><th>å—ä»˜ãƒ»å…¥åŠ›</th><th>å‡¦æ–¹ç›£æŸ»ãƒ»ï¾‹ï¾Ÿï½¯ï½·ï¾ï½¸ï¾</th><th>ç›£æŸ»ãƒ»ç¢ºèª</th><th>æŠ•è–¬ãƒ»èª¬æ˜</th><th>åˆè¨ˆ</th><th>BNå·¥ç¨‹</th><th>ç–‘ç¾©</th><th>ç–‘ç¾©æ™‚é–“</th><th>ï¾‹ï¾”ï¾˜</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="14"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="tab-hiyari" class="tab-content">
    <div class="filter-bar">
      <label>æ—¥ä»˜</label><input type="date" class="filter-input" id="hiyariFilterFrom"><label>ã€œ</label><input type="date" class="filter-input" id="hiyariFilterTo">
      <label>è¨˜è¼‰</label>
      <select class="filter-input" id="hiyariFilterStatus"><option value="">ã™ã¹ã¦</option><option value="pending">æœªè¨˜è¼‰</option><option value="done">è¨˜è¼‰æ¸ˆ</option></select>
      <button class="btn-filter" onclick="updateHiyariTab()">çµã‚Šè¾¼ã¿</button>
      <button class="btn-filter sec" onclick="clearHiyariFilter()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
      <div class="stat-card"><div class="stat-value" id="hStatTotal">0</div><div class="stat-label">ç·ä»¶æ•°</div></div>
      <div class="stat-card"><div class="stat-value" id="hStatPending" style="color:var(--hiyari)">0</div><div class="stat-label">æœªè¨˜è¼‰</div></div>
      <div class="stat-card"><div class="stat-value" id="hStatPendingRate" style="color:var(--hiyari)">-</div><div class="stat-label">æœªè¨˜è¼‰ç‡</div></div>
    </div>
    <div class="section-title">å·¥ç¨‹åˆ¥ ç™ºç”Ÿä»¶æ•°</div>
    <div class="chart-container" id="hiyariStepChart"><div class="empty-state" style="padding:20px"><div class="icon">âš </div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">æ™‚é–“å¸¯åˆ¥ ç™ºç”Ÿä»¶æ•°</div>
    <div class="chart-container" id="hiyariTimeChart"><div class="empty-state" style="padding:20px"><div class="icon">â°</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">ãƒŸã‚¹å†…å®¹ãƒ»åŸå›  åˆ†æï¼ˆä¸Šä½10ä»¶ï¼‰</div>
    <div class="chart-container" id="hiyariCauseChart"><div class="empty-state" style="padding:20px"><div class="icon">ğŸ”</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div></div>
    <div class="section-title">ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆä¸€è¦§</div>
    <div class="table-wrap">
      <table class="data-table" style="min-width:700px;">
        <thead><tr><th>æ—¥ä»˜</th><th>æ™‚åˆ»</th><th>ç•ªå·</th><th>ç™ºç”Ÿå·¥ç¨‹</th><th>è¨˜è¼‰çŠ¶æ³</th><th>ãƒŸã‚¹å†…å®¹</th><th>åŸå› </th><th>æ“ä½œ</th></tr></thead>
        <tbody id="hiyariBody"><tr><td colspan="8"><div class="empty-state" style="padding:24px"><div class="icon">âš </div><p>ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- Modals -->
<div class="modal-overlay hidden" id="resumeModal">
  <div class="modal">
    <h3>å·¥ç¨‹ã‚’é¸æŠã—ã¦å†é–‹</h3>
    <div class="modal-sub" id="resumeModalSub"></div>
    <div class="step-select-list" id="resumeStepList"></div>
    <button class="modal-cancel-btn" onclick="closeResumeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="tagModal">
  <div class="modal">
    <h3>ğŸ· ã‚¿ã‚°ã‚’é¸æŠ</h3>
    <div class="modal-sub" id="tagModalSub">è¤‡æ•°é¸æŠã§ãã¾ã™</div>
    <div class="tag-modal-chips" id="tagModalChips"></div>
    <button class="btn-save-modal" onclick="saveTagModal()">ä¿å­˜</button>
    <button class="modal-cancel-btn" onclick="closeTagModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="hiyariPickModal">
  <div class="modal">
    <h3>âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆè¨˜éŒ²</h3>
    <div class="modal-sub" id="hiyariPickSub">ã©ã®å·¥ç¨‹ã§ç™ºç”Ÿã—ã¾ã—ãŸã‹ï¼Ÿ</div>
    <div class="step-picker" id="hiyariStepPicker"></div>
    <button class="btn-save-modal danger" onclick="flagHiyari('later')">ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦å¾Œã§è¨˜è¼‰ã™ã‚‹</button>
    <button class="btn-save-modal dark" style="margin-top:6px" onclick="flagHiyari('now')">ä»Šã™ãè¨˜è¼‰ã™ã‚‹ï¼ˆã“ã®ç•ªå·ã®æ™‚é–“ã‚’åœæ­¢ï¼‰</button>
    <button class="modal-cancel-btn" onclick="closeHiyariPickModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div class="modal-overlay hidden" id="hiyariWriteModal">
  <div class="modal">
    <h3>âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆè¨˜è¼‰</h3>
    <div class="modal-sub" id="hiyariWriteSub"></div>
    <div class="hiyari-section"><h4>â–¶ ä½•ã‚’é–“é•ãˆãŸã‹ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-mistake"></div></div>
    <div class="hiyari-section"><h4>â–¶ å„èª¿å‰¤æ©Ÿå™¨ã§ã‚¢ãƒ©ãƒ¼ãƒˆã¯å‡ºã¦ã„ãŸã‹ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-alert"></div></div>
    <div class="hiyari-section"><h4>â–¶ æ°—ã¥ã„ãŸãã£ã‹ã‘ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-notice"></div></div>
    <div class="hiyari-section"><h4>â–¶ ãƒŸã‚¹åŸå› ï¼ˆè¤‡æ•°å¯ï¼‰</h4><div class="hiyari-chips" id="chips-cause"></div></div>
    <div class="hiyari-section"><h4>â–¶ ãƒ•ãƒªãƒ¼è¨˜è¼‰</h4><textarea class="hiyari-textarea" id="hiyariNote" placeholder="è©³ç´°ãƒ»çŠ¶æ³ãƒ»å¯¾ç­–ãªã©è‡ªç”±ã«è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea></div>
    <button class="btn-save-modal danger" onclick="saveHiyariWrite()">ä¿å­˜ã™ã‚‹</button>
    <button class="modal-cancel-btn" onclick="closeHiyariWriteModal()">å¾Œã§è¨˜è¼‰ã™ã‚‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDKs (compatç‰ˆ = window.firebase ã«å…¬é–‹ã•ã‚Œã‚‹) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// Firebase init
firebase.initializeApp({
  apiKey:"AIzaSyDOfrlBz3QFG_XtBlwUe43tqPQKv8eiv4s",
  authDomain:"bottleneck-shiraberu.firebaseapp.com",
  databaseURL:"https://bottleneck-shiraberu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"bottleneck-shiraberu",
  storageBucket:"bottleneck-shiraberu.firebasestorage.app",
  messagingSenderId:"241290767512",
  appId:"1:241290767512:web:4290cf43b493fdc9f774ed"
});
var db = firebase.database();

var PROC=[{id:'reception',name:'å—ä»˜ãƒ»å…¥åŠ›',icon:'ğŸ“‹'},{id:'picking',name:'å‡¦æ–¹ç›£æŸ»ãƒ»ãƒ”ãƒƒã‚­ãƒ³ã‚°',icon:'ğŸ’Š'},{id:'audit',name:'ç›£æŸ»ãƒ»ç¢ºèª',icon:'ğŸ”'},{id:'dispensing',name:'æŠ•è–¬ãƒ»èª¬æ˜',icon:'ğŸ¤'}];
var TAGS=[{id:'ippoka',label:'ä¸€åŒ…åŒ–',type:'slow'},{id:'sanzai',label:'æ•£å‰¤',type:'slow'},{id:'suizai',label:'æ°´å‰¤',type:'slow'},{id:'nanko',label:'è»Ÿè†ç·´ã‚Š',type:'slow'},{id:'shika',label:'æ­¯ç§‘',type:'fast'},{id:'ganka',label:'çœ¼ç§‘',type:'fast'},{id:'normal',label:'ã‚¿ã‚°ãªã—',type:'normal'}];
var HM={mistake:['è–¬å“å','å‰¤å½¢','è¦æ ¼','ãƒ¡ãƒ¼ã‚«ãƒ¼å','æ•°é‡','ç”¨æ³•','ç”¨é‡','æ—¥æ•°','å°å­—','ãã®ä»–'],alert:['ãƒ¬ã‚»ã‚³ãƒ³','é‡é‡ç›£æŸ»æ©Ÿ','Musubi','onedy','DSX','åˆ†åŒ…æ©Ÿ','ãã®ä»–'],notice:['è‡ªå·±ç›£æŸ»','æœ€çµ‚ç›£æŸ»','èª¿å‰¤æ©Ÿå™¨ã‚¢ãƒ©ãƒ¼ãƒˆ','ä»–å¾“æ¥­å“¡ã‹ã‚‰ã®æŒ‡æ‘˜','ãŠå®¢æ§˜ã‹ã‚‰ã®æŒ‡æ‘˜','ãã®ä»–'],cause:['ã‚¢ãƒ©ãƒ¼ãƒˆç„¡è¦–','å…¥åŠ›æ™‚QRã‚³ãƒ¼ãƒ‰ä¸ä½¿ç”¨','é›»å­å‡¦æ–¹ç®‹ï¼ˆåŒ»å¸«å´ã®ãƒŸã‚¹ï¼‰','è‡ªå·±ç›£æŸ»æœªå®Ÿæ–½','é‡é‡ç›£æŸ»ä¸ä½¿ç”¨ï¼ˆHHTä½¿ç”¨ï¼‰','é‡é‡ç›£æŸ»æ©Ÿä¸é©åˆ‡ä½¿ç”¨','ç–‘ç¾©ç…§ä¼šæœªå®Ÿæ–½','ç›£æŸ»æ‰‹é †éµå®ˆã›ãš','Musubiã®ä¸é©åˆ‡ä½¿ç”¨','ä¼šè¨ˆæ™‚ã®HHTæœªä½¿ç”¨','ãã®ä»–']};

var SC='',allT={},histC=[],hiyC=[],tickInt=null,resumeId=null,tagId=null,newTags=[],hiyTickId=null,hiyStep=null,hiyEditId=null,pausedHiy=false,repT=null,repI=null,todayStr=getToday();
var unsub1=null,unsub2=null,unsub3=null;

function getToday(){return new Date().toISOString().slice(0,10);}
function fRef(p){return db.ref('stores/'+SC+'/'+p);}
function syncDot(s){document.getElementById('syncDot').className='sync-dot '+s;document.getElementById('syncLabel').textContent={synced:'åŒæœŸæ¸ˆ',syncing:'åŒæœŸä¸­â€¦',error:'ã‚¨ãƒ©ãƒ¼'}[s]||'--';}

// SETUP
function setupInputListeners(){
  var inp=document.getElementById('storeCodeInput');
  inp.addEventListener('input',function(){var v=this.value.replace(/\D/g,'');this.value=v;var h=document.getElementById('setupHint');if(v.length===5){h.textContent='âœ“ '+v+' â€” æº–å‚™OKï¼';h.className='setup-hint ok';}else if(v.length>0){h.textContent='æ•°å­—5æ¡ï¼ˆ'+v.length+'/5ï¼‰';h.className='setup-hint err';}else{h.textContent='ä¾‹ï¼šæœ¬åº— â†’ 00001';h.className='setup-hint';}});
  inp.addEventListener('keydown',function(e){if(e.key==='Enter')confirmStore();});
}
function confirmStore(){
  var code=document.getElementById('storeCodeInput').value.replace(/\D/g,'');
  if(code.length!==5){var h=document.getElementById('setupHint');h.textContent='âš  5æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';h.className='setup-hint err';document.getElementById('storeCodeInput').focus();return;}
  SC=code;localStorage.setItem('rx_store_code',code);launchApp();
}
function changeStore(){
  if(!confirm('åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ'))return;
  if(unsub1)unsub1();if(unsub2)unsub2();if(unsub3)unsub3();
  allT={};histC={};hiyC=[];
  if(tickInt){clearInterval(tickInt);tickInt=null;}
  document.getElementById('mainApp').style.display='none';
  document.getElementById('setupScreen').style.display='flex';
  document.getElementById('storeCodeInput').value='';
  document.getElementById('setupHint').textContent='ä¾‹ï¼šæœ¬åº— â†’ 00001ã€€ï¼ã€€åŒ—å£åº— â†’ 00002';
  document.getElementById('setupHint').className='setup-hint';
}
function launchApp(){
  document.getElementById('setupScreen').style.display='none';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('storeLabel').textContent=SC;
  buildTagChips();startListening();
  setInterval(updateClock,1000);updateClock();
  setInterval(function(){var d=getToday();if(d!==todayStr){todayStr=d;fRef('tickets').remove();allT={};renderAll();showToast('ğŸŒ… æ—¥ä»˜ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');}},30000);
}

// FIREBASE (compat SDK)
function startListening(){
  syncDot('syncing');
  unsub1=fRef('tickets').on('value',function(snap){
    var raw=snap.val()||{};
    // stepTimesãŒnullã®å ´åˆã«ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    Object.keys(raw).forEach(function(k){
      if(!raw[k].stepTimes)raw[k].stepTimes={};
      if(!raw[k].tags)raw[k].tags=[];
    });
    allT=raw;
    syncDot('synced');renderAll();updateCountBadge();
    if(Object.values(allT).some(function(t){return['active','giqi'].indexOf(t.status)>=0;})&&!tickInt){
      tickInt=setInterval(renderTimers,500);
    }
  },function(){syncDot('error');});
  unsub2=fRef('history').on('value',function(snap){var d=snap.val();histC=d?Object.values(d):[];updateHistory();updateAnalysis();populateTagFilters();});
  unsub3=fRef('hiyari').on('value',function(snap){var d=snap.val();hiyC=d?Object.values(d):[];updateHiyariTab();renderAll();});
}
function stopListening(){
  if(unsub1)fRef('tickets').off('value',unsub1);
  if(unsub2)fRef('history').off('value',unsub2);
  if(unsub3)fRef('hiyari').off('value',unsub3);
}
function pushT(t){
  fRef('tickets/'+t.id).set({id:t.id,ticketNum:t.ticketNum,status:t.status,currentStep:t.currentStep,stepTimes:t.stepTimes||{},pauseCount:t.pauseCount||0,giqiCount:t.giqiCount||0,giqiTotalMs:t.giqiTotalMs||0,giqiStart:t.giqiStart||null,tags:t.tags||[],totalStart:t.totalStart,stepStart:t.stepStart,pauseStart:t.pauseStart||null,pauseAccum:t.pauseAccum||0,cancelledAt:t.cancelledAt||null,dateStr:t.dateStr||todayStr}).catch(function(){syncDot('error');});
}
function removeT(id){fRef('tickets/'+id).remove();}
function pushHist(e){
  var list=histC.slice();list.push(e);
  fRef('history').set(list).catch(function(){syncDot('error');});
}
function pushHiy(){fRef('hiyari').set(hiyC).catch(function(){syncDot('error');});}

// SPINNER
function changeNum(d){var e=document.getElementById('ticketNumInput');e.value=Math.max(1,Math.min(999,(parseInt(e.value)||1)+d));}
function clampNum(){var e=document.getElementById('ticketNumInput'),v=parseInt(e.value);if(isNaN(v)||v<1)e.value=1;else if(v>999)e.value=999;}
function startRepeat(d){changeNum(d);repT=setTimeout(function(){repI=setInterval(function(){changeNum(d);},80);},380);}
function stopRepeat(){clearTimeout(repT);clearInterval(repI);}

// TAGS
function buildTagChips(){
  var wrap=document.getElementById('newTagChips');wrap.innerHTML='';
  TAGS.forEach(function(tag){
    var chip=document.createElement('span');chip.className='tag-chip tag-'+tag.type;chip.dataset.id=tag.id;chip.textContent=tag.label;
    if(newTags.indexOf(tag.id)>=0)chip.classList.add('selected');
    chip.addEventListener('click',function(){
      var i=newTags.indexOf(tag.id);
      if(i>=0){newTags.splice(i,1);chip.classList.remove('selected');}
      else{newTags.push(tag.id);chip.classList.add('selected');}
    });
    wrap.appendChild(chip);
  });
}
function openTagModal(tid){
  tagId=tid;var t=allT[tid];var cur=t?(t.tags||[]):[];
  document.getElementById('tagModalSub').textContent='No.'+(t?t.ticketNum:'?')+' ã®ã‚¿ã‚°ã‚’å¤‰æ›´ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰';
  var chips=document.getElementById('tagModalChips');chips.innerHTML='';
  TAGS.forEach(function(tag){
    var chip=document.createElement('button');chip.className='tag-modal-chip';chip.dataset.id=tag.id;chip.textContent=tag.label;
    if(cur.indexOf(tag.id)>=0)chip.classList.add('sel-'+tag.type);
    chip.addEventListener('click',function(){var s='sel-'+tag.type;chip.classList.contains(s)?chip.classList.remove(s):chip.classList.add(s);});
    chips.appendChild(chip);
  });
  document.getElementById('tagModal').classList.remove('hidden');
}
function saveTagModal(){
  var sel=[];document.querySelectorAll('#tagModalChips .tag-modal-chip').forEach(function(c){if(c.classList.length>1)sel.push(c.dataset.id);});
  if(tagId&&allT[tagId]){allT[tagId].tags=sel;pushT(allT[tagId]);}
  closeTagModal();
}
function closeTagModal(){document.getElementById('tagModal').classList.add('hidden');tagId=null;}

// TICKETS
function updateCountBadge(){
  var n=Object.values(allT).filter(function(t){return['active','paused','giqi'].indexOf(t.status)>=0;}).length;
  document.getElementById('ticketCountBadge').textContent=n+' / 30ä»¶';
}
function usedToday(){
  var s=new Set();
  Object.values(allT).forEach(function(t){if(t.dateStr===todayStr&&['active','paused','giqi'].indexOf(t.status)>=0)s.add(t.ticketNum);});
  return s;
}
function addTicket(){
  var numEl=document.getElementById('ticketNumInput'),num=numEl.value.trim();
  if(!num)return;
  var activeCount=Object.values(allT).filter(function(t){return['active','paused','giqi'].indexOf(t.status)>=0;}).length;
  if(activeCount>=30){showToast('âš  åŒæ™‚è¨ˆæ¸¬ã¯30ä»¶ã¾ã§ã§ã™');return;}
  if(usedToday().has(num)){showToast('âš  ç•ªå· '+num+' ã¯æœ¬æ—¥ã™ã§ã«ä½¿ç”¨ä¸­ã§ã™');return;}
  var tags=newTags.length>0?newTags.slice():['normal'];
  var id='T'+Date.now(),now=Date.now();
  var t={id:id,ticketNum:num,status:'active',currentStep:0,stepTimes:{},pauseCount:0,giqiCount:0,giqiTotalMs:0,giqiStart:null,tags:tags,stepStart:now,pauseStart:null,pauseAccum:0,totalStart:now,dateStr:todayStr};
  allT[id]=t;pushT(t);
  var next=parseInt(num)+1;var used=usedToday();while(used.has(String(next))&&next<999)next++;
  numEl.value=Math.min(999,next);
  var em=document.getElementById('emptyState');if(em)em.remove();
  renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}
function completeStep(id){
  var t=allT[id];if(!t||t.status!=='active')return;
  var now=Date.now();t.stepTimes[PROC[t.currentStep].id]=(now-t.stepStart)-t.pauseAccum;t.pauseAccum=0;
  if(t.currentStep>=PROC.length-1){
    t.status='done';t.totalEnd=now;pushT(t);saveToHistory(t);
    setTimeout(function(){removeT(id);delete allT[id];renderAll();updateCountBadge();},1500);
    renderAll();updateAnalysis();updateCountBadge();
  }else{t.currentStep++;t.stepStart=now;pushT(t);renderAll();}
}
function pauseTicket(id){var t=allT[id];if(!t||t.status!=='active')return;t.status='paused';t.pauseStart=Date.now();t.pauseCount++;pushT(t);renderAll();updateCountBadge();}
function toggleGiqi(id){
  var t=allT[id];if(!t)return;var now=Date.now();
  if(t.status==='giqi'){var el=now-t.giqiStart;t.giqiTotalMs=(t.giqiTotalMs||0)+el;t.pauseAccum=(t.pauseAccum||0)+el;t.status='active';t.giqiStart=null;showToast('ç–‘ç¾©ç…§ä¼šçµ‚äº† '+fmt(el));}
  else if(t.status==='active'){t.status='giqi';t.giqiStart=now;t.giqiCount=(t.giqiCount||0)+1;if(!t.pauseStart)t.pauseStart=now;showToast('ğŸ“ ç–‘ç¾©ç…§ä¼šä¸­â€¦');}
  else return;
  pushT(t);renderAll();updateCountBadge();
}
function resumeTicket_OLD(id){
  var t=allT[id];if(!t||t.status!=='paused')return;resumeId=id;
  var stepList=document.getElementById('resumeStepList');stepList.innerHTML='';
  PROC.forEach(function(p,i){
    var ts=t.stepTimes[p.id]?fmt(t.stepTimes[p.id]):'';
    var note=i===t.currentStep?'åœæ­¢ä¸­':i<t.currentStep?'å†è¨ˆæ¸¬':'';
    var btn=document.createElement('button');btn.className='step-select-btn';
    btn.innerHTML='<span class="step-sel-icon">'+p.icon+'</span><span>'+p.name+(note?'<span style="font-size:10px;color:var(--muted);margin-left:4px">ï¼ˆ'+note+'ï¼‰</span>':'')+'</span>'+(ts?'<span class="step-sel-time">'+ts+'</span>':'');
    (function(idx){btn.addEventListener('click',function(){confirmResume(idx);});})(i);
    stepList.appendChild(btn);
  });
  document.getElementById('resumeModalSub').textContent='No.'+t.ticketNum+' â€” ã©ã®å·¥ç¨‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã‹ï¼Ÿ';
  document.getElementById('resumeModal').classList.remove('hidden');
}
function confirmResume_OLD(si){
  var id=resumeId;if(!id)return;var t=allT[id],now=Date.now();
  PROC.forEach(function(_,i){if(i>=si)delete t.stepTimes[PROC[i].id];});
  t.currentStep=si;t.stepStart=now;t.pauseAccum=0;t.pauseStart=null;t.status='active';
  pushT(t);closeResumeModal();renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}
function closeResumeModal_OLD(){document.getElementById('resumeModal').classList.add('hidden');resumeId=null;}

// ã‚·ãƒ³ãƒ—ãƒ«ãªå†é–‹
function resumeTicket(id){
  var t=allT[id];if(!t||t.status!=='paused')return;
  var now=Date.now();
  if(t.pauseStart){t.pauseAccum=(t.pauseAccum||0)+(now-t.pauseStart);}
  t.pauseStart=null;t.status='active';
  pushT(t);renderAll();updateCountBadge();
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}

function cancelTicket(id){
  var t=allT[id];if(!t||['active','paused','giqi'].indexOf(t.status)<0)return;
  if(!confirm('No.'+t.ticketNum+' ã®è¨ˆæ¸¬ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ'))return;
  t.status='cancelled';t.cancelledAt=Date.now();pushT(t);renderAll();updateCountBadge();
  showToast('No.'+t.ticketNum+' ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
}
function restoreTicket(id){
  var t=allT[id];if(!t||t.status!=='cancelled')return;
  var now=Date.now();t.status='active';t.stepStart=now;t.pauseAccum=0;t.pauseStart=null;t.cancelledAt=null;
  pushT(t);renderAll();updateCountBadge();showToast('No.'+t.ticketNum+' ã‚’å¾©æ´»ã—ã¾ã—ãŸ');
  if(!tickInt)tickInt=setInterval(renderTimers,500);
}

// RENDER
function stepElapsed(t){
  if(['paused','giqi'].indexOf(t.status)>=0)return Math.max(0,(t.pauseStart?t.pauseStart:Date.now())-t.stepStart-(t.pauseAccum||0));
  return Math.max(0,(Date.now()-t.stepStart)-(t.pauseAccum||0));
}
function totalElapsed(t){return(t.totalEnd||t.cancelledAt||Date.now())-t.totalStart;}

function renderAll(){
  var grid=document.getElementById('ticketsGrid'),cGrid=document.getElementById('cancelledGrid');
  grid.querySelectorAll('.ticket-card').forEach(function(c){c.remove();});cGrid.innerHTML='';
  var emptyEl=document.getElementById('emptyState');
  var active=Object.values(allT).filter(function(t){return['active','paused','giqi'].indexOf(t.status)>=0;});
  var done=Object.values(allT).filter(function(t){return t.status==='done';});
  var cancelled=Object.values(allT).filter(function(t){return t.status==='cancelled';});
  if(active.length+done.length===0){
    if(!emptyEl){var d=document.createElement('div');d.className='empty-state';d.id='emptyState';d.innerHTML='<div class="icon">ğŸ¥</div><p>å‘¼ã³å‡ºã—ç•ªå·ã‚’å…¥åŠ›ã—ã¦è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>';grid.appendChild(d);}
    stopTicker();
  }else{
    if(emptyEl)emptyEl.remove();
    active.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
    done.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
    active.concat(done).forEach(function(t){renderCard(t,grid);});
    if(active.length===0)stopTicker();
  }
  if(cancelled.length>0){
    document.getElementById('cancelledSection').style.display='block';
    cancelled.sort(function(a,b){return parseInt(a.ticketNum)-parseInt(b.ticketNum);});
    cancelled.forEach(function(t){renderCard(t,cGrid);});
  }else{document.getElementById('cancelledSection').style.display='none';}
}

function renderCard(t,grid){
  var si=Math.min(t.currentStep,PROC.length-1),proc=PROC[si];
  var card=document.createElement('div');
  var sc=t.status==='giqi'?'giqi':t.status;
  card.className='ticket-card status-'+sc;card.id='card-'+t.id;
  var bl={active:'è¨ˆæ¸¬ä¸­',paused:'ä¸€æ™‚åœæ­¢',giqi:'ç–‘ç¾©ç…§ä¼šä¸­',done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[t.status]||t.status;
  var stepsHtml=PROC.map(function(p,i){
    var cls=i<t.currentStep||t.status==='done'?'done-step':i===t.currentStep&&['active','paused','giqi'].indexOf(t.status)>=0?'current'+(t.status==='paused'?' paused':t.status==='giqi'?' giqi':''):'pending';
    var ts=t.stepTimes&&t.stepTimes[p.id]?fmt(t.stepTimes[p.id]):cls.indexOf('current')>=0?'â€¦':'';
    return '<div class="step '+cls+'" title="'+p.name+'">'+p.icon+'<div class="step-time">'+ts+'</div></div>';
  }).join('');
  var tags=t.tags||[];
  var canEdit=['active','paused','giqi','cancelled'].indexOf(t.status)>=0;
  var tagsHtml='<div class="card-tags">'+tags.map(function(tid){var tag=TAGS.find(function(x){return x.id===tid;});return tag?'<span class="card-tag '+tag.type+'">'+tag.label+'</span>':'';}).join('')+(canEdit?'<button class="btn-tag-edit" onclick="openTagModal(\''+t.id+'\')">âœ ã‚¿ã‚°ç·¨é›†</button>':'')+'</div>';
  var hFlags=hiyC.filter(function(h){return h.ticketId===t.id&&!h.written;});
  var hFlagHtml=hFlags.length>0?'<div class="hiyari-flag"><span class="hf-dot"></span>ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆæœªè¨˜è¼‰ '+hFlags.length+'ä»¶</div>':'';
  var cpHtml='';
  if(['active','paused','giqi'].indexOf(t.status)>=0){
    var tc=t.status==='giqi'?'var(--giqi)':t.status==='paused'?'var(--pause)':'var(--accent)';
    var blink=['paused','giqi'].indexOf(t.status)>=0?' blinking':'';
    cpHtml='<div class="current-process"><span class="proc-icon">'+proc.icon+'</span><span class="proc-name">'+proc.name+'</span><span class="proc-timer'+blink+'" style="color:'+tc+'"><span id="timer-'+t.id+'">00:00</span></span></div>';
  }else if(t.status==='done'){cpHtml='<div class="current-process"><span class="proc-icon">âœ…</span><span class="proc-name" style="color:var(--success)">å…¨å·¥ç¨‹å®Œäº†</span></div>';}
  else{cpHtml='<div class="current-process"><span class="proc-icon">âŒ</span><span class="proc-name" style="color:var(--muted)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</span></div>';}
  var giqiHtml=(t.giqiCount||0)>0?'<div class="giqi-info">ğŸ“ ç–‘ç¾©ç…§ä¼š <span>'+t.giqiCount+'å›</span>ã€€è¨ˆ <span>'+fmt(t.giqiTotalMs||0)+'</span>'+(t.status==='giqi'?' â±é€²è¡Œä¸­':'')+'</div>':'';
  var pauseHtml=(t.pauseCount||0)>0?'<div class="sub-info">â¸ ä¸€æ™‚åœæ­¢ '+t.pauseCount+'å›</div>':'';
  card.innerHTML='<div class="ticket-header"><div class="ticket-num">No.'+t.ticketNum+'</div><span class="ticket-badge badge-'+sc+'">'+bl+'</span></div>'+tagsHtml+hFlagHtml+'<div class="steps">'+stepsHtml+'</div>'+cpHtml+'<div class="total-time" id="total-'+t.id+'">åˆè¨ˆ: <span>'+fmt(totalElapsed(t))+'</span></div>'+giqiHtml+pauseHtml+'<div class="ticket-buttons" id="btns-'+t.id+'"></div>';

  // ãƒœã‚¿ãƒ³ã‚’JSã§ç›´æ¥ç”Ÿæˆã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
  var btnWrap=card.querySelector('#btns-'+t.id);
  var tid=t.id;
  function mkBtn(cls,label,fn,extraStyle){
    var b=document.createElement('button');
    b.className='tbtn '+cls;b.textContent=label;
    if(extraStyle)b.style.cssText=extraStyle;
    b.addEventListener('click',fn);
    btnWrap.appendChild(b);
  }
  if(t.status==='active'){
    var isLast=t.currentStep>=PROC.length-1;
    mkBtn('tbtn-next',isLast?'âœ… æŠ•è–¬å®Œäº†':'âœ” æ¬¡ã®å·¥ç¨‹ã¸',function(){completeStep(tid);},'flex:2');
    mkBtn('tbtn-pause','ä¸€æ™‚åœæ­¢',function(){pauseTicket(tid);});
    mkBtn('tbtn-giqi','ç–‘ç¾©ç…§ä¼š',function(){toggleGiqi(tid);});
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='giqi'){
    mkBtn('tbtn-giqi on','ç–‘ç¾©ç…§ä¼šã‚’çµ‚äº†ã™ã‚‹',function(){toggleGiqi(tid);},'flex:2');
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='paused'){
    mkBtn('tbtn-resume','â–¶ ä¸€æ™‚åœæ­¢ã‚’è§£é™¤ã—ã¦å†é–‹',function(){resumeTicket(tid);},'flex:2');
    mkBtn('tbtn-hiyari','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆ',function(){openHiyariPickModal(tid);});
    mkBtn('tbtn-cancel','ã‚­ãƒ£ãƒ³ã‚»ãƒ«',function(){cancelTicket(tid);});
  }else if(t.status==='cancelled'){
    mkBtn('tbtn-restore','ğŸ”„ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å–ã‚Šæ¶ˆã—ã¦å†é–‹ã™ã‚‹',function(){restoreTicket(tid);},'flex:2');
  }
  if(!btnWrap.children.length)btnWrap.style.display='none';
  grid.appendChild(card);
  if(['active','giqi'].indexOf(t.status)>=0)updTimer(t.id);
}

function renderTimers(){
  Object.values(allT).forEach(function(t){
    if(['active','giqi'].indexOf(t.status)<0)return;
    updTimer(t.id);
    var el=document.getElementById('total-'+t.id);
    if(el)el.innerHTML='åˆè¨ˆ: <span>'+fmt(totalElapsed(t))+'</span>';
  });
}
function updTimer(id){var t=allT[id];if(!t)return;var el=document.getElementById('timer-'+id);if(el)el.textContent=fmt(stepElapsed(t));}
function stopTicker(){if(!Object.values(allT).some(function(t){return['active','giqi'].indexOf(t.status)>=0;})&&tickInt){clearInterval(tickInt);tickInt=null;}}

// HISTORY
function saveToHistory(t){
  var dt=new Date(),total=Object.values(t.stepTimes||{}).reduce(function(a,b){return a+b;},0);
  var bnId=null,bnMs=0;
  Object.entries(t.stepTimes||{}).forEach(function(e){if(e[1]>bnMs){bnMs=e[1];bnId=e[0];}});
  var bnP=PROC.find(function(p){return p.id===bnId;});
  pushHist({storeCode:SC,ticketNum:t.ticketNum,date:dt.toLocaleDateString('ja-JP'),time:dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),dateISO:dt.toISOString().slice(0,10),ts:Date.now(),status:t.status,stepTimes:Object.assign({},t.stepTimes||{}),total:total,bottleneck:bnP?bnP.name:null,pauseCount:t.pauseCount||0,hasPause:(t.pauseCount||0)>0,giqiCount:t.giqiCount||0,giqiTotalMs:t.giqiTotalMs||0,tags:t.tags||[]});
}
function populateTagFilters(){
  var at=new Set();histC.forEach(function(h){(h.tags||[]).forEach(function(t){at.add(t);});});
  ['filterTag','histFilterTag'].forEach(function(fid){
    var sel=document.getElementById(fid),cur=sel.value;sel.innerHTML='<option value="">ã™ã¹ã¦</option>';
    TAGS.forEach(function(tag){if(at.has(tag.id)){var o=document.createElement('option');o.value=tag.id;o.textContent=tag.label;if(cur===tag.id)o.selected=true;sel.appendChild(o);}});
  });
}
function getFiltered(fid,tid,tagid){
  var from=document.getElementById(fid).value,to=document.getElementById(tid).value,tag=document.getElementById(tagid).value;
  return histC.filter(function(h){if(from&&h.dateISO<from)return false;if(to&&h.dateISO>to)return false;if(tag&&(h.tags||[]).indexOf(tag)<0)return false;return true;});
}
function updateHistory(){
  var history=getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  document.getElementById('histCount').textContent=history.length+'ä»¶';
  var tbody=document.getElementById('historyBody');
  if(!history.length){tbody.innerHTML='<tr><td colspan="14"><div class="empty-state" style="padding:24px"><div class="icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';return;}
  tbody.innerHTML=history.slice().reverse().map(function(h){
    var steps=PROC.map(function(p){return h.stepTimes&&h.stepTimes[p.id]?fmt(h.stepTimes[p.id]):'-';}).join('</td><td>');
    var stTag=h.status==='done'?'<span class="tag tag-done">å®Œäº†</span>':'<span class="tag tag-cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
    var tagHtml=(h.tags||[]).map(function(tid){var tag=TAGS.find(function(x){return x.id===tid;});return tag?'<span class="card-tag '+tag.type+'" style="font-size:10px">'+tag.label+'</span>':'';}).join(' ');
    var giqiHtml=(h.giqiCount||0)>0?'<span class="tag tag-giqi">'+h.giqiCount+'å›</span>':'<span style="color:var(--muted)">-</span>';
    var hiyN=hiyC.filter(function(hh){return hh.ticketNum===h.ticketNum&&hh.dateISO===h.dateISO;}).length;
    var hiyHtml=hiyN>0?'<span class="tag tag-hiyari">'+hiyN+'ä»¶</span>':'<span style="color:var(--muted)">-</span>';
    return '<tr><td style="font-family:\'JetBrains Mono\',monospace">'+(h.date||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace">'+(h.time||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace;font-weight:700">No.'+h.ticketNum+'</td><td>'+(tagHtml||'-')+'</td><td>'+steps+'</td><td style="font-family:\'JetBrains Mono\',monospace;font-weight:700">'+(h.total?fmt(h.total):'-')+'</td><td class="bn-text">'+(h.bottleneck||'-')+'</td><td>'+giqiHtml+'</td><td style="font-family:\'JetBrains Mono\',monospace">'+((h.giqiTotalMs||0)>0?fmt(h.giqiTotalMs):'-')+'</td><td>'+hiyHtml+'</td><td>'+stTag+'</td></tr>';
  }).join('');
}
function clearFilter(){document.getElementById('filterFrom').value='';document.getElementById('filterTo').value='';document.getElementById('filterTag').value='';updateAnalysis();}
function clearHistFilter(){document.getElementById('histFilterFrom').value='';document.getElementById('histFilterTo').value='';document.getElementById('histFilterTag').value='';updateHistory();}
function clearHistory(){if(!confirm('ã“ã®åº—èˆ—ã®å…¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;histC=[];fRef('history').remove();updateHistory();updateAnalysis();showToast('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');}
function exportCSV(){
  var history=getFiltered('histFilterFrom','histFilterTo','histFilterTag');
  if(!history.length){showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var headers=['åº—èˆ—ã‚³ãƒ¼ãƒ‰','æ—¥ä»˜','æ™‚åˆ»','å‘¼ã³å‡ºã—ç•ªå·','ã‚¿ã‚°'].concat(PROC.map(function(p){return p.name;})).concat(['åˆè¨ˆæ™‚é–“(s)','BNå·¥ç¨‹','ç–‘ç¾©ç…§ä¼šå›æ•°','ç–‘ç¾©ç…§ä¼šæ™‚é–“(s)','ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆä»¶æ•°','ä¸€æ™‚åœæ­¢å›æ•°','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']);
  var rows=history.slice().reverse().map(function(h){
    return [SC,h.date||'',h.time||'','No.'+h.ticketNum,(h.tags||[]).map(function(tid){var t=TAGS.find(function(x){return x.id===tid;});return t?t.label:tid;}).join('ãƒ»')].concat(PROC.map(function(p){return h.stepTimes&&h.stepTimes[p.id]?((h.stepTimes[p.id]/1000).toFixed(1)):'-';})).concat([h.total?(h.total/1000).toFixed(1):'-',h.bottleneck||'',h.giqiCount||0,(h.giqiTotalMs||0)>0?((h.giqiTotalMs/1000).toFixed(1)):'-',hiyC.filter(function(hh){return hh.ticketNum===h.ticketNum&&hh.dateISO===h.dateISO;}).length,h.pauseCount||0,{done:'å®Œäº†',cancelled:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}[h.status]||h.status]);
  });
  var csv='\uFEFF'+[headers].concat(rows).map(function(r){return r.map(function(v){return '"'+String(v).replace(/"/g,'""')+'"';}).join(',');}).join('\r\n');
  var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download='èª¿å‰¤ãƒœãƒˆãƒ«ãƒãƒƒã‚¯_'+SC+'_'+getToday()+'.csv';a.click();URL.revokeObjectURL(a.href);showToast('âœ“ CSVå‡ºåŠ› '+rows.length+'ä»¶');
}

// ANALYSIS
function updateAnalysis(){
  var all=getFiltered('filterFrom','filterTo','filterTag'),done=all.filter(function(h){return h.status==='done';});
  document.getElementById('statSessions').textContent=done.length;
  var gD=done.filter(function(h){return(h.giqiCount||0)>0;});
  document.getElementById('statGiqiRate').textContent=done.length?Math.round(gD.length/done.length*100)+'%':'-';
  if(!done.length){document.getElementById('statTotal').textContent='-';document.getElementById('statBN').textContent='-';document.getElementById('chartContainer').innerHTML='<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“Š</div><p>å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';document.getElementById('giqiChart').innerHTML='<div class="empty-state" style="padding:24px"><div class="icon">ğŸ“</div><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';return;}
  var sums={},counts={};PROC.forEach(function(p){sums[p.id]=0;counts[p.id]=0;});var ts=0;
  done.forEach(function(h){ts+=h.total||0;PROC.forEach(function(p){if(h.stepTimes&&h.stepTimes[p.id]){sums[p.id]+=h.stepTimes[p.id];counts[p.id]++;}});});
  document.getElementById('statTotal').textContent=fmt(ts/done.length);
  var avgs={};PROC.forEach(function(p){avgs[p.id]=counts[p.id]?sums[p.id]/counts[p.id]:0;});
  var maxMs=Math.max.apply(null,Object.values(avgs));
  var bnId=Object.entries(avgs).sort(function(a,b){return b[1]-a[1];})[0][0];
  document.getElementById('statBN').textContent=(PROC.find(function(p){return p.id===bnId;})||{}).name||'-';
  document.getElementById('chartContainer').innerHTML=PROC.filter(function(p){return avgs[p.id]>0;}).map(function(p){var pct=maxMs?avgs[p.id]/maxMs*100:0,isBN=p.id===bnId,cls=isBN?'bn':pct>60?'nrm':'fst';return '<div class="bar-row"><div class="bar-label">'+p.icon+' '+p.name+'</div><div class="bar-wrap"><div class="bar-fill '+cls+'" style="width:'+Math.max(pct,4)+'%">'+fmt(avgs[p.id])+'</div></div>'+(isBN?'<span class="bn-badge">BN</span>':'<span style="width:36px;flex-shrink:0"></span>')+'</div>';}).join('')||'<div class="empty-state" style="padding:24px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';
  var avgGT=gD.length?gD.reduce(function(a,h){return a+(h.giqiTotalMs||0);},0)/gD.length:0;
  document.getElementById('giqiChart').innerHTML='<div class="bar-row"><div class="bar-label">ç–‘ç¾©ç…§ä¼šç‡</div><div class="bar-wrap"><div class="bar-fill giq" style="width:'+Math.max(done.length?gD.length/done.length*100:0,2)+'%">'+(done.length?Math.round(gD.length/done.length*100):0)+'%</div></div><span style="width:36px;flex-shrink:0"></span></div><div class="bar-row"><div class="bar-label">å¹³å‡ç–‘ç¾©ç…§ä¼šæ™‚é–“</div><div class="bar-wrap"><div class="bar-fill giq" style="width:'+(avgGT>0?'50%':'2%')+'">'+fmt(avgGT)+'</div></div><span style="width:36px;flex-shrink:0"></span></div>';
}

// HIYARI
function openHiyariPickModal(tid){
  var t=allT[tid];if(!t)return;hiyTickId=tid;hiyStep=null;
  document.getElementById('hiyariPickSub').textContent='No.'+t.ticketNum+' â€” ã©ã®å·¥ç¨‹ã§ç™ºç”Ÿã—ã¾ã—ãŸã‹ï¼Ÿ';
  var picker=document.getElementById('hiyariStepPicker');picker.innerHTML='';
  PROC.forEach(function(p,i){
    var btn=document.createElement('button');btn.className='step-pick-btn';btn.textContent=p.icon+' '+p.name;
    btn.addEventListener('click',function(){picker.querySelectorAll('.step-pick-btn').forEach(function(b){b.classList.remove('sel');});btn.classList.add('sel');hiyStep=i;});
    picker.appendChild(btn);
  });
  document.getElementById('hiyariPickModal').classList.remove('hidden');
}
function flagHiyari(mode){
  if(hiyStep===null){showToast('âš  å·¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  var t=allT[hiyTickId],dt=new Date();
  var entry={id:'H'+Date.now(),ticketId:hiyTickId,ticketNum:t?t.ticketNum:'?',step:hiyStep,stepName:PROC[hiyStep].name,date:dt.toLocaleDateString('ja-JP'),time:dt.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),hour:dt.getHours(),dateISO:dt.toISOString().slice(0,10),ts:Date.now(),written:false,mistake:[],alert:[],notice:[],cause:[],note:''};
  closeHiyariPickModal();
  if(mode==='now'){
    if(t&&t.status==='active'){t.status='paused';t.pauseStart=Date.now();t.pauseCount++;pushT(t);renderAll();pausedHiy=true;}
    hiyEditId=entry.id;hiyC.push(entry);openHiyariWriteModal(entry);
  }else{hiyC.push(entry);pushHiy();showToast('âš  ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¾ã—ãŸ');}
}
function closeHiyariPickModal(){document.getElementById('hiyariPickModal').classList.add('hidden');hiyTickId=null;hiyStep=null;}
function openHiyariWriteModal(entry){
  document.getElementById('hiyariWriteSub').textContent=(entry.ticketNum?'No.'+entry.ticketNum+' â€” ':'')+entry.stepName+' ã§ç™ºç”Ÿ';
  document.getElementById('hiyariNote').value=entry.note||'';
  Object.entries(HM).forEach(function(kv){
    var key=kv[0],items=kv[1];
    var wrap=document.getElementById('chips-'+key);wrap.innerHTML='';
    items.forEach(function(item){
      var chip=document.createElement('button');chip.className='hiyari-chip';chip.textContent=item;
      if((entry[key]||[]).indexOf(item)>=0)chip.classList.add('sel');
      chip.addEventListener('click',function(){chip.classList.toggle('sel');});
      wrap.appendChild(chip);
    });
  });
  document.getElementById('hiyariWriteModal').classList.remove('hidden');
}
function openHiyariWriteById(id){var entry=hiyC.find(function(h){return h.id===id;});if(!entry)return;hiyEditId=id;openHiyariWriteModal(entry);}
function saveHiyariWrite(){
  var idx=hiyC.findIndex(function(h){return h.id===hiyEditId;});if(idx===-1)return;
  var entry=hiyC[idx];
  Object.keys(HM).forEach(function(key){entry[key]=Array.from(document.querySelectorAll('#chips-'+key+' .hiyari-chip.sel')).map(function(c){return c.textContent;});});
  entry.note=document.getElementById('hiyariNote').value;entry.written=true;
  if(pausedHiy&&entry.ticketId&&allT[entry.ticketId]&&allT[entry.ticketId].status==='paused'){var t=allT[entry.ticketId],now=Date.now();t.pauseAccum+=(now-t.pauseStart);t.pauseStart=null;t.status='active';pushT(t);renderAll();}
  pausedHiy=false;hiyEditId=null;pushHiy();closeHiyariWriteModal();showToast('âœ“ ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function closeHiyariWriteModal(){
  document.getElementById('hiyariWriteModal').classList.add('hidden');
  if(pausedHiy){
    var entry=hiyC.find(function(h){return h.id===hiyEditId;});
    if(entry&&entry.ticketId&&allT[entry.ticketId]&&allT[entry.ticketId].status==='paused'){var t=allT[entry.ticketId],now=Date.now();t.pauseAccum+=(now-t.pauseStart);t.pauseStart=null;t.status='active';pushT(t);renderAll();}
    pausedHiy=false;pushHiy();
  }
  hiyEditId=null;
}
function updateHiyariTab(){
  var from=document.getElementById('hiyariFilterFrom').value,to=document.getElementById('hiyariFilterTo').value,st=document.getElementById('hiyariFilterStatus').value;
  var filtered=hiyC.filter(function(h){if(from&&h.dateISO<from)return false;if(to&&h.dateISO>to)return false;if(st==='pending'&&h.written)return false;if(st==='done'&&!h.written)return false;return true;});
  var pending=filtered.filter(function(h){return!h.written;});
  document.getElementById('hStatTotal').textContent=filtered.length;
  document.getElementById('hStatPending').textContent=pending.length;
  document.getElementById('hStatPendingRate').textContent=filtered.length?Math.round(pending.length/filtered.length*100)+'%':'-';
  var sc={};PROC.forEach(function(p){sc[p.id]=0;});filtered.forEach(function(h){var p=PROC[h.step];if(p)sc[p.id]++;});
  var mx=Math.max.apply(null,Object.values(sc).concat([1]));
  document.getElementById('hiyariStepChart').innerHTML=PROC.map(function(p){return '<div class="bar-row"><div class="bar-label">'+p.icon+' '+p.name+'</div><div class="bar-wrap"><div class="bar-fill hiy" style="width:'+Math.max(sc[p.id]/mx*100,sc[p.id]>0?4:0)+'%">'+sc[p.id]+'ä»¶</div></div><span style="width:36px;flex-shrink:0"></span></div>';}).join('');
  var hc={};for(var i=0;i<24;i++)hc[i]=0;filtered.forEach(function(h){if(h.hour!==undefined)hc[h.hour]++;});
  var mxH=Math.max.apply(null,Object.values(hc).concat([1]));
  var hd=Object.entries(hc).filter(function(e){return e[1]>0;});
  document.getElementById('hiyariTimeChart').innerHTML=hd.length?hd.map(function(e){return '<div class="bar-row"><div class="bar-label" style="font-family:\'JetBrains Mono\',monospace">'+String(e[0]).padStart(2,'0')+':00ã€œ</div><div class="bar-wrap"><div class="bar-fill hiy" style="width:'+Math.max(e[1]/mxH*100,4)+'%">'+e[1]+'ä»¶</div></div><span style="width:36px;flex-shrink:0"></span></div>';}).join(''):'<div class="empty-state" style="padding:20px"><p>ãƒ‡ãƒ¼ã‚¿ãªã—</p></div>';
  var cc={};filtered.filter(function(h){return h.written;}).forEach(function(h){(h.cause||[]).forEach(function(c){cc[c]=(cc[c]||0)+1;});(h.mistake||[]).forEach(function(c){cc['é–“é•ã„ï¼š'+c]=(cc['é–“é•ã„ï¼š'+c]||0)+1;});});
  var ce=Object.entries(cc).sort(function(a,b){return b[1]-a[1];}).slice(0,10);
  var mxC=Math.max.apply(null,ce.map(function(e){return e[1];}).concat([1]));
  document.getElementById('hiyariCauseChart').innerHTML=ce.length?ce.map(function(e){return '<div class="bar-row"><div class="bar-label" style="font-size:10px">'+e[0]+'</div><div class="bar-wrap"><div class="bar-fill hiy" style="width:'+Math.max(e[1]/mxC*100,4)+'%">'+e[1]+'ä»¶</div></div><span style="width:36px;flex-shrink:0"></span></div>';}).join(''):'<div class="empty-state" style="padding:20px"><p>è¨˜è¼‰æ¸ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
  var tbody=document.getElementById('hiyariBody');
  if(!filtered.length){tbody.innerHTML='<tr><td colspan="8"><div class="empty-state" style="padding:24px"><div class="icon">âš </div><p>ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div></td></tr>';return;}
  tbody.innerHTML=filtered.slice().reverse().map(function(h){
    var stH=h.written?'<span class="tag tag-done">è¨˜è¼‰æ¸ˆ</span>':'<span class="pending-badge">æœªè¨˜è¼‰</span>';
    var wB='<button class="btn-write" onclick="openHiyariWriteById(\''+h.id+'\')">'+(h.written?'ç·¨é›†':'è¨˜è¼‰ã™ã‚‹')+'</button>';
    return '<tr><td style="font-family:\'JetBrains Mono\',monospace">'+(h.date||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace">'+(h.time||'')+'</td><td style="font-family:\'JetBrains Mono\',monospace;font-weight:700">No.'+h.ticketNum+'</td><td>'+(h.stepName||'')+'</td><td>'+stH+'</td><td style="font-size:11px">'+((h.mistake||[]).slice(0,3).join('ãƒ»')||'-')+'</td><td style="font-size:11px">'+((h.cause||[]).slice(0,2).join('ãƒ»')||'-')+'</td><td>'+wB+'</td></tr>';
  }).join('');
}
function clearHiyariFilter(){document.getElementById('hiyariFilterFrom').value='';document.getElementById('hiyariFilterTo').value='';document.getElementById('hiyariFilterStatus').value='';updateHiyariTab();}

// UTILS
function fmt(ms){var s=Math.floor(ms/1000);return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(function(){t.classList.remove('show');},2800);}
function switchTab(name){
  document.querySelectorAll('.tab').forEach(function(t,i){t.classList.toggle('active',['measure','analysis','history','hiyari'][i]===name);});
  document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active');});
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='analysis')updateAnalysis();if(name==='history')updateHistory();if(name==='hiyari')updateHiyariTab();
}
function updateClock(){var n=new Date();document.getElementById('clockDisplay').textContent=String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0')+':'+String(n.getSeconds()).padStart(2,'0');}

setupInputListeners();
var saved=localStorage.getItem('rx_store_code');
if(saved&&saved.length===5){SC=saved;document.getElementById('storeCodeInput').value=saved;launchApp();}
</script>
</body>
</html>
